<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bancolombia - Consulta de Proyectos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ===== Colores principales (grises equivalentes) ===== */
            --bancolombia-blue: #2C2A29;        
            --bancolombia-light-blue: #5A5A5A;   
            --bancolombia-green: #707070;       
            --bancolombia-yellow: #D9D9D9;       

            /* ===== Neutrales ===== */
            --bancolombia-gray: #F5F5F5;         
            --bancolombia-dark-gray: #1E1E1E;     
            --text-secondary: #5A5A5A;            
            --border-light: #E0E0E0;             
            --pure-white: #FFFFFF;               
        }
        
        body {
            font-family: "Cambria", serif;
            font-size: 18px;
            background-color: var(--bancolombia-gray);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 1. Botón Primario (Azul original → Gris oscuro) */
        .btn-primary {
            background-color: var(--bancolombia-blue);
            color: var(--pure-white);
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-primary:hover {
            background-color: #1E1E1E; /* 10% más oscuro al hover */
        }
        
        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 0;
            margin-bottom: 20px;
        }
        
        
        .logo-container img {
            height: 50px;
        }
        
        .consultar-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
            /* Nuevas propiedades añadidas */
            position: relative;
            overflow: visible;
            z-index: 1;
        }
        
        .section-title {
            color: var(--bancolombia-blue);
            border-bottom: 2px solid var(--bancolombia-light-blue);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .btn-bancolombia {
            background-color: var(--bancolombia-blue);
            color: white;
        }
        
        .btn-bancolombia:hover {
            background-color: var(--bancolombia-light-blue);
            color: white;
        }
        
        .filtro-card {
            border-left: 4px solid var(--bancolombia-light-blue);
            margin-bottom: 20px;
        }
        
        .resultados-table {
            margin-top: 30px;
        }

        .resultados-table table {
            font-size: 0.85rem; /* Reduce solo el tamaño de letra */
        }
        
        .resultados-table th {
            background-color: var(--bancolombia-blue);
            color: white;
        }

        .resultados-table td {
            white-space: nowrap; /* Evita saltos de línea */
            padding: 8px 12px; /* Padding más compacto */
        }

        .table-responsive {
            overflow-y: visible !important; 
            max-height: none !important;
        }

        .footer {
            background-color: var(--bancolombia-blue);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 40px;
        }
        
        .footer a {
            color: var(--bancolombia-yellow);
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        .user-info {
            text-align: right;
            padding: 10px 20px;
            background-color: var(--bancolombia-gray);
            color: var(--bancolombia-dark-gray);
            font-size: 0.9rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        /* Ajustes para mejor alineación */
        .container-aligned {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }
        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .breadcrumb-item.active {
            color: var(--bancolombia-blue);
            font-weight: 600;
        }
         /* Efecto hover para el logo */
         .logo-container img:hover {
            transform: scale(1.05);
        }
        .logo-container {
            text-align: center;
            padding: 10px 0;
            margin: 0 auto;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .participante-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        .acciones-container {
            position: relative;
            display: flex;
            gap: 5px;
        }

        .btn-accion {
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        .btn-accion-primary {
            background-color: var(--bancolombia-blue);
            color: white;
            border: 1px solid var(--bancolombia-blue);
        }

        .btn-accion-primary:hover {
            background-color: var(--bancolombia-light-blue);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,72,132,0.2);
        }

        .btn-accion-secondary {
            background-color: var(--bancolombia-gray);
            color: var(--bancolombia-dark-gray);
            border: 1px solid #ccc;
        }

        .btn-accion-secondary:hover {
            background-color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .acciones-extendidas {
            position: absolute;
            right: 0;
            bottom: 100%; /* Cambiamos top por bottom */
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
            min-width: 280px;
            max-height: 400px;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px; /* Espacio entre botón y menú */
            overflow-y: auto;
            animation: slideUp 0.3s ease-out; /* Nueva animación */
        }

        /* Animación para aparecer hacia arriba */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Clase adicional para cuando hay espacio abajo */
        .menu-abajo {
            top: 100%;
            bottom: auto;
            animation: slideDown 0.3s ease-out;
        }

        .acciones-container:hover .acciones-extendidas {
            display: flex;
        }

        .btn-accion-extendida {
            width: 100%;
            justify-content: start;
            text-align: left;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .acciones-container:hover .acciones-extendidas {
            display: flex;
            flex-wrap: nowrap;
            overflow: visible;
        }

        /* Ajustes para mejor visibilidad */
        .btn-accion-extendida:hover {
            transform: none;
            background-color: #f8f9fa;
            box-shadow: none;
        }

        .btn-accion-extendida i {
            min-width: 20px;
            margin-right: 10px;
        }
        .historial-contenido {
            max-height: 500px;
            overflow-y: auto;
        }

        #btn-export-pdf {
            margin-left: 10px;
        }

        /* ESTILOS CORREGIDOS PARA EL MODAL */
        .modal-content {
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: none;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--bancolombia-blue), var(--bancolombia-light-blue));
            color: white;
            border-radius: 8px 8px 0 0;
            padding: 15px 20px;
        }
        
        .modal-title {
            font-weight: 600;
            font-size: 1.3rem;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            border-top: 1px solid var(--border-light);
            padding: 15px 20px;
        }
        
        .values-section {
            background-color: var(--bancolombia-gray);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--bancolombia-blue);
        }
        
        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .summary-table th {
            background-color: var(--bancolombia-blue);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }
        
        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light);
        }
        
        .summary-table tr:nth-child(even) {
            background-color: var(--pure-white);
        }
        
        .value-highlight {
            font-weight: 600;
        }
        
        .positive-value {
            color: #28a745;
        }
        
        .negative-value {
            color: #dc3545;
        }
        
        .coverage-percentage {
            font-weight: 700;
            color: #e67e22;
        }
        
        .filters-info {
            background-color: var(--bancolombia-yellow);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .info-label {
            font-weight: 600;
            color: var(--bancolombia-blue);
        }
        
        .project-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--bancolombia-blue);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bancolombia-yellow);
        }
        
        #modalDesembolsos .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Pasar el rol del usuario desde el servidor
        const USUARIO_ROL = '{{ session.usuario.rol }}';
    </script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='LogoBancolombia.ico') }}">
     <!-- Bootstrap JS -->
     <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>
     <!-- Header con logo y usuario -->
     <div class="header">
        <div class="container-aligned">
            <div class="user-info">
                <span class="role-badge me-3">{{ session.usuario.rol | title }}</span>
                <i class="fas fa-user-circle"></i> {{ session.usuario.nombre }}
                | <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
            </div>
            <div class="logo-container">
                <img src="https://www.uam.edu.co/wp-content/uploads/2022/09/logo-bancolombia1.png" 
                     alt="Bancolombia">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('menu_principal') }}"><i class="fas fa-home"></i> Menú Principal</a></li>
                        <li class="breadcrumb-item active" aria-current="page"><i class="fas fa-user-tie"></i> Módulo Pilotos</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3"><i class="fas fa-search me-2"></i> Consulta de Proyectos</h1>
            <a href="{{ url_for('modulo_pilotos') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
        </div>
        
        <!-- Card de Filtros -->
        <div class="consultar-container">
            <h2 class="section-title"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h2>
            
            <form id="form-consulta">
                <div class="row">
                    <!-- Filtro 1: Datos Generales -->
                    <div class="col-md-6">
                        <div class="card filtro-card">
                            <div class="card-body">
                                <h5 class="card-title text-bancolombia">Datos Generales</h5>
                                <div class="mb-3">
                                    <label class="form-label">ID Proyecto</label>
                                    <input type="text" class="form-control" name="id_proyecto" id="id_proyecto">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nombre Proyecto</label>
                                    <input type="text" class="form-control" name="proyecto">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Titular</label>
                                    <input type="text" class="form-control" name="titular">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">NIT</label>
                                    <input type="text" class="form-control" name="nit">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Filtro 2: Roles -->
                    <div class="col-md-6">
                        <div class="card filtro-card">
                            <div class="card-body">
                                <h5 class="card-title text-bancolombia">Roles</h5>
                                <div class="mb-3">
                                    <label class="form-label">Arquitecto</label>
                                    <select class="form-select" name="arquitecto">
                                        <option value="">Todos</option>
                                        <option>Arquitecto 1</option>
                                        <option>Arquitecto 2</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Gerente</label>
                                    <select class="form-select" name="gerente">
                                        <option value="">Todos</option>
                                        <option>Gerente 1</option>
                                        <option>Gerente 2</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Constructor</label>
                                    <select class="form-select" name="constructor">
                                        <option value="">Todos</option>
                                        <option>Constructor 1</option>
                                        <option>Constructor 2</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtro 3: Avances -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card filtro-card">
                            <div class="card-body">
                                <h5 class="card-title text-bancolombia">Estado Proyecto</h5>
                                <select class="form-select" name="estado_proyecto" id="estado_proyecto">
                                    <option value="">Todos</option>
                                    <option value="sin aprobar">Sin aprobar</option>
                                    <option value="aprobado sin desembolsar">Aprobado sin desembolsar</option>
                                    <option value="en preoperativo">En preoperativo</option>
                                    <option value="en construcción">En construcción</option>
                                    <option value="en escrituración">En escrituración</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </div>    
                        </div> 
                    </div>        
                <!-- Filtro 4: Desembolsos - Versión modificada -->
                <div class="col-md-6">
                    <div class="card filtro-card">
                        <div class="card-body">
                            <h5 class="card-title text-bancolombia">Desembolsos</h5>
                            <button class="btn btn-bancolombia w-100" id="btn-ver-desembolsos">
                                <i class="fas fa-search me-2"></i>Ver Desembolsos
                            </button>
                        </div>
                    </div>
                </div>             
                <!-- Botones -->
                <div class="d-flex justify-content-end mt-4">
                    <button type="reset" class="btn btn-outline-secondary me-3">
                        <i class="fas fa-eraser me-2"></i>Limpiar
                    </button>
                    <button type="submit" class="btn btn-bancolombia">
                        <i class="fas fa-search me-2"></i>Buscar
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Resultados -->
        <div class="consultar-container">
            <h2 class="section-title"><i class="fas fa-table me-2"></i>Resultados</h2>
            <div class="d-flex justify-content-end mt-4">
                <div class="d-flex justify-content-end mt-4 align-items-center gap-2">
                    <label for="page-size-select" class="mb-0 me-2">Mostrar</label>
                    <select id="page-size-select" class="form-select form-select-sm" style="width: auto;">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-success" id="btn-exportar">
                <i class="fas fa-file-export me-2"></i>Exportar a Excel
            </button>         
            <div class="table-responsive resultados-table">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Proyecto</th>
                            <th>Estado</th>
                            <th>Titular</th>
                            <th>NIT</th>
                            <th>Arquitecto</th>
                            <th>% Avance</th>
                            <th>Perito</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-body">
                        <!-- Dinámico -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Paginación -->
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <a class="page-link" href="#" tabindex="-1">Anterior</a>
                    </li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link" href="#">Siguiente</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    
    <!-- Script para manejar la búsqueda -->

    <script>
         // Función para formatear valores monetarios
         function formatearMoneda(valor) {
            if (valor === null || valor === undefined) return '$ 0';
            return '$ ' + valor.toLocaleString('es-CO', {maximumFractionDigits: 0});
        }

        // Función para formatear fechas
        function formatearFecha(fechaStr) {
            if (!fechaStr) return 'No disponible';
            
            try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return 'Fecha inválida';
            }
        }

        // Función segura para establecer contenido de elementos
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.error(`Elemento con ID '${elementId}' no encontrado`);
            }
        }

        // Función para obtener el nombre del proyecto desde localStorage
        function obtenerNombreProyecto(idProyecto) {
            try {
                // 1. Buscar en historialDesembolsosDiarios
                const historialDesembolsosDiarios = JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');
                const proyectoDiario = historialDesembolsosDiarios.find(item => 
                    item.proyectoId == idProyecto && item.proyectoNombre
                );
                
                if (proyectoDiario) {
                    return proyectoDiario.proyectoNombre;
                }
                
                // 2. Buscar en historialVentas
                const historialVentas = JSON.parse(localStorage.getItem('historialVentas') || '[]');
                const proyectoVentas = historialVentas.find(item => 
                    item.proyectoId == idProyecto && item.proyectoNombre
                );
                
                if (proyectoVentas) {
                    return proyectoVentas.proyectoNombre;
                }
                
                // 3. Buscar en proyectos
                const proyecto = proyectosGlobal.find(p => p.id_proyecto == idProyecto);
                return proyecto ? proyecto.nombre_proyecto : "Proyecto sin nombre";

            } catch (e) {
                console.error('Error al obtener nombre del proyecto:', e);
                return "Proyecto sin nombre";
            }
        }

        // Función para obtener datos del proyecto
        function obtenerDatosProyecto(idProyecto) {
            try {
                // Obtener datos de historialDesembolsos
                const historialDesembolsos = JSON.parse(localStorage.getItem('historialDesembolsos') || '[]');
                const desembolsosProyecto = Array.isArray(historialDesembolsos) ? 
                    historialDesembolsos.filter(item => item.proyectoId == idProyecto) : [];
                
                // Obtener el registro más reciente
                const desembolsosMasRecientes = desembolsosProyecto.length > 0 ?
                    desembolsosProyecto.sort((a, b) => 
                        new Date(b.fechaCarga) - new Date(a.fechaCarga))[0] : null;
                
                return desembolsosMasRecientes;
            } catch (e) {
                console.error('Error al obtener datos del proyecto:', e);
                return null;
            }
        }

        // Inicializar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Asignar el evento click al botón
            const btn = document.getElementById('btn-ver-desembolsos');
            if (btn) {
                btn.addEventListener('click', verValores);
            } else {
                console.error("Botón 'btn-ver-desembolsos' no encontrado");
            }
        });

        // Función principal para mostrar valores
        function verValores() {
            // Obtener ID del proyecto ingresado
            const idProyectoInput = document.getElementById('id_proyecto');
            
            // Verificar si el input existe
            if (!idProyectoInput) {
                console.error("Elemento 'id_proyecto' no encontrado");
                Swal.fire({
                    icon: 'error',
                    title: 'Error interno',
                    text: 'No se encontró el campo ID del proyecto'
                });
                return;
            }

            const idProyecto = idProyectoInput.value.trim();
            
            // Verificar si se ingresó un ID
            if (!idProyecto) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campo requerido',
                    text: 'Debe ingresar el ID del proyecto para ver los valores'
                });
                return;
            }

            // Obtener nombre del proyecto
            const nombreProyecto = obtenerNombreProyecto(idProyecto);
            
            // Obtener datos del proyecto
            const datos = obtenerDatosProyecto(idProyecto);
            
            // Verificar si se encontraron datos
            if (!datos) {
                Swal.fire({
                    icon: 'error',
                    title: 'Datos no encontrados',
                    text: `No se encontraron valores calculados para el proyecto con ID: ${idProyecto}`
                });
                return;
            }

            // Obtener valores calculados
            const valores = datos.campos || {};
            
            // Actualizar título del proyecto
            safeSetTextContent('titulo-proyecto', `${nombreProyecto} (ID: ${idProyecto})`);
            
            // Actualizar valores calculados
            safeSetTextContent('modal-valor-entregado', formatearMoneda(valores.valorEntregado));
            safeSetTextContent('modal-valor-por-entregar', formatearMoneda(valores.valorPorEntregar));
            safeSetTextContent('modal-a-desembolsar', formatearMoneda(valores.formulaA));
            safeSetTextContent('modal-b-desembolsar', formatearMoneda(valores.formulaB));
            safeSetTextContent('modal-superavit', formatearMoneda(valores.superavit));
            
            // Manejar cobertura
            const cobertura = valores.cobertura || 0;
            safeSetTextContent('modal-cobertura', cobertura.toFixed(2) + '%');
            
            safeSetTextContent('modal-maximo-desembolsar', formatearMoneda(valores.maximoDesembolsar));
            
            // Actualizar información adicional
            safeSetTextContent('modal-fecha-carga', formatearFecha(datos.fechaCarga));
            safeSetTextContent('modal-usuario', datos.usuario || 'No disponible');
            
            const requiereVistoBueno = valores.requiereVistoBueno ? 'Sí' : 'No';
            safeSetTextContent('modal-requiere-visto-bueno', requiereVistoBueno);

            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());

            const modal = bootstrap.Modal.getOrCreateInstance(
                document.getElementById('modalDesembolsos'),
                {
                    backdrop: true,  // Permite cerrar haciendo clic fuera
                    keyboard: true   // Permite cerrar con ESC
                }
            );
            modal.show();

        }

        // Función de formato de fecha mejorada
        function formatFecha(valor) {
            try {
                if (!valor) return 'Sin registros';
                
                // Manejar diferentes formatos de fecha
                const fecha = new Date(valor);
                if (isNaN(fecha)) {
                    // Intentar extraer fecha de cadenas complejas
                    const match = valor.match(/(\d{2})[/-](\d{2})[/-](\d{4})/);
                    return match ? `${match[1]}/${match[2]}/${match[3]}` : 'Fecha inválida';
                }
                return fecha.toLocaleDateString('es-CO');
            } catch (e) {
                console.error('Error formateando fecha:', valor, e);
                return 'Formato inválido';
            }
        }


        function obtenerRolUsuario() {
        return document.querySelector('.role-badge').textContent.trim().toLowerCase();
        }

        // Función para cargar (y filtrar) proyectos
        function cargarProyectos(filtros = {}) {
            const userRole = obtenerRolUsuario();
            let proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];

            // Ordena por fecha_creacion descendente (convirtiendo a Date)
            proyectos.sort((a, b) => {
                const fa = a.fecha_creacion ? new Date(a.fecha_creacion) : new Date(0);
                const fb = b.fecha_creacion ? new Date(b.fecha_creacion) : new Date(0);
                return fb - fa;
            });

            // Aplica filtros solo si hay valor en el formulario
            proyectos = proyectos.filter(p => {
                let ok = true;

                if (filtros.proyecto) {
                    const busq = filtros.proyecto.toLowerCase();
                    ok = ok && (
                        (p.id_proyecto || '').toString().toLowerCase().includes(busq) ||
                        (p.nombre_proyecto || '').toLowerCase().includes(busq)
                    );
                }

                if (filtros.titular) {
                    const busq = filtros.titular.toLowerCase();
                    ok = ok && (p.titular_credito || '').toLowerCase().includes(busq);
                }

                if (filtros.nit) {
                    const busq = filtros.nit.toLowerCase();
                    ok = ok && (
                        (p.nit_titular || '').toLowerCase().includes(busq) ||
                        (p.nit_grupo_riesgo || '').toLowerCase().includes(busq)
                    );
                }

                if (filtros.estado_proyecto) {
                    const estadoProyecto = String(p.estado || 'sin aprobar').trim().toLowerCase();
                    const filtroEstado = filtros.estado_proyecto.trim().toLowerCase();
                    ok = ok && estadoProyecto === filtroEstado;
                }

                return ok;
            });

            // Renderizado
            const tbody = document.getElementById('resultados-body');
            tbody.innerHTML = '';

            proyectos.forEach(p => {
                const datos = {
                    nombre_proyecto: p.nombre_proyecto || 'Proyecto sin nombre',
                    estado: (p.estado !== undefined && p.estado !== null) ? p.estado : 'sin aprobar',
                    titular: p.titular_credito || 'Sin titular',
                    nit: p.nit_titular || p.nit_grupo_riesgo || 'Sin NIT',
                    arquitecto: p.arquitecto || p.gerente || 'Sin arquitecto',
                    avance: Math.min(Math.max(p.avance || 0, 0), 100),
                    perito: p.perito || '—'
                };

                const puedeEditar = ['admin','auxiliar'].includes(userRole);

                let badge = '';
                switch ((datos.estado || '').toLowerCase()) {
                    case 'sin aprobar': badge = '<span class="badge bg-secondary">Sin aprobar</span>'; break;
                    case 'aprobado sin desembolsar': badge = '<span class="badge bg-primary">Aprobado sin desembolsar</span>'; break;
                    case 'en preoperativo': badge = '<span class="badge bg-info text-dark">En preoperativo</span>'; break;
                    case 'en construcción': badge = '<span class="badge bg-warning text-dark">En construcción</span>'; break;
                    case 'en escrituración': badge = '<span class="badge bg-success">En escrituración</span>'; break;
                    case 'cancelado': badge = '<span class="badge bg-danger">Cancelado</span>'; break;
                    default: badge = `<span class="badge bg-light text-dark">${datos.estado}</span>`;
                }

                tbody.innerHTML += `
                <tr>
                    <td>${datos.nombre_proyecto}</td>
                    <td>${badge}</td> <!-- Estado -->
                    <td>${datos.titular}</td>
                    <td>${datos.nit}</td>
                    <td>${datos.arquitecto}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" style="width:${datos.avance}%">
                                ${datos.avance}%
                            </div>
                        </div>
                    </td>
                    <td>${datos.perito}</td>
                    <td>
                        <div class="acciones-container">
                            <button class="btn btn-accion btn-accion-primary"
                                    onclick="verProyecto('${p.id_proyecto}')"
                                    data-bs-toggle="tooltip" title="Ver detalles">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                        ${puedeEditar ? `
                        <button class="btn btn-accion btn-accion-secondary"
                                onclick="editarProyecto('${p.id_proyecto}')"
                                data-bs-toggle="tooltip" title="Editar proyecto">
                            <i class="fas fa-edit"></i> Editar Grupo
                        </button>
                        <div class="dropdown">
                            <button class="btn btn-accion btn-accion-secondary"
                                    data-bs-toggle="dropdown" title="Más acciones">
                            <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end animate__fadeIn">
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('titular','${p.id_proyecto}')">
                                <i class="fas fa-user-edit me-2 text-primary"></i>
                                Cambio Titular
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('nombre','${p.id_proyecto}')">
                                <i class="fas fa-signature me-2 text-info"></i>
                                Cambio Nombre
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('unidades','${p.id_proyecto}')">
                                <i class="fas fa-cubes me-2 text-warning"></i>
                                Gestión Unidades
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('desistimiento','${p.id_proyecto}')">
                                <i class="fas fa-ban me-2 text-danger"></i>
                                Desistimiento
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('monto','${p.id_proyecto}')">
                                <i class="fas fa-coins me-2 text-success"></i>
                                Ampliación de Monto
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('vigencia','${p.id_proyecto}')">
                                <i class="fas fa-calendar-day me-2 text-info"></i>
                                Ampliación de Vigencia
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('plazo','${p.id_proyecto}')">
                                <i class="fas fa-clock me-2 text-warning"></i>
                                Ampliación de Plazo
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            </ul>
                        </div>
                        ` : ''}
                    </div>
                    </td>
                </tr>
                `;
            });

            // Si no quedan proyectos, aviso
            if (proyectos.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">— Sin resultados —</td>
                </tr>
                `;
            }
        }

        // Opcional: al cargar la página muestro todos
        window.addEventListener('DOMContentLoaded', async () => {
            await cargarProyectos({});
        });
                
        // Función para abrir modal de edición
        async function editarProyecto(id) {
            try {
                // Hacer petición a la API
                const response = await fetch(`/api/proyectos/${id}`);
                const result = await response.json();
                
                if (!result.success) {
                    Swal.fire('Error', 'Proyecto no encontrado', 'error');
                    return;
                }

                const p = result.proyecto;

                // Rellenar campos básicos
                document.getElementById('edit-id').value = p.id_proyecto;
                document.getElementById('edit-nombre').value = p.nombre_proyecto || '';
                document.getElementById('edit-titular').value = p.titular_credito || '';
                document.getElementById('edit-nit').value = p.nit_titular || '';
                document.getElementById('edit-avance').value = p.avance || 0;

                // Rellenar lista de participantes
                const lista = document.querySelector('.participantes-list');
                lista.innerHTML = '';
                if (Array.isArray(p.participantes)) {
                    p.participantes.forEach(pt => {
                        const row = document.createElement('div');
                        row.classList.add('participante-item', 'mb-2', 'row');
                        row.innerHTML = `
                            <div class="col"><input type="text" class="form-control" placeholder="Nombre" value="${pt.nombre || ''}"></div>
                            <div class="col"><input type="text" class="form-control" placeholder="Rol"    value="${pt.rol || ''}"></div>
                            <div class="col"><input type="number" class="form-control" placeholder="%"    min="0" max="100" value="${pt.participacion || 0}"></div>
                            <div class="col-auto">
                            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.participante-item').remove()">
                                <i class="fas fa-trash"></i>
                            </button>
                            </div>`;
                        lista.appendChild(row);
                    });
                }

                // Mostrar modal
                bootstrap.Modal.getOrCreateInstance(document.getElementById('editarModal')).show();
            } catch (error) {
                console.error('Error al cargar proyecto:', error);
                Swal.fire('Error', 'No se pudo cargar el proyecto para edición', 'error');
            }
        }
        
        
        // Añade un nuevo bloque de inputs para un participante
        function agregarParticipante() {
            const lista = document.querySelector('.participantes-list');
            const row = document.createElement('div');
            row.classList.add('participante-item', 'mb-2', 'row');
            row.innerHTML = `
                <div class="col"><input type="text" class="form-control" placeholder="Nombre"></div>
                <div class="col"><input type="text" class="form-control" placeholder="Rol"></div>
                <div class="col"><input type="number" class="form-control" placeholder="%" min="0" max="100"></div>
                <div class="col-auto">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.participante-item').remove()">
                    <i class="fas fa-trash"></i>
                </button>
                </div>`;
            lista.appendChild(row);
        }

        function generarMenuAcciones(proyecto) {
            return `
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('desistimiento','${proyecto.id}')">
                        <i class="fas fa-ban me-2 text-danger"></i>
                        Desistimiento
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('monto','${proyecto.id}')">
                        <i class="fas fa-coins me-2 text-success"></i>
                        Ampliación de Monto
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('vigencia','${proyecto.id}')">
                        <i class="fas fa-calendar-day me-2 text-info"></i>
                        Ampliación de Vigencia
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('plazo','${proyecto.id}')">
                        <i class="fas fa-clock me-2 text-warning"></i>
                        Ampliación de Plazo
                    </button>
                </li>
            `;
        }
        
        
        // Guarda los cambios del formulario del modal
        function guardarCambios() {
            try {
                const proyectos = JSON.parse(localStorage.getItem('proyectos') || []);
                const id = document.getElementById('edit-id')?.value;
                if (!id) throw new Error('ID de proyecto no encontrado');

                const idx = proyectos.findIndex(p => p.id_proyecto === id);
                if (idx === -1) throw new Error('Proyecto no existe en los registros');

                // Recoger datos del formulario con validación
                const form = document.getElementById('form-editar');
                if (!form) throw new Error('Formulario no encontrado');

                const updated = {
                    ...proyectos[idx],
                    nombre_proyecto: form.querySelector('#edit-nombre')?.value?.trim() || proyectos[idx].nombre_proyecto,
                    titular_credito: form.querySelector('#edit-titular')?.value?.trim() || proyectos[idx].titular_credito,
                    nit_titular: form.querySelector('#edit-nit')?.value?.trim() || proyectos[idx].nit_titular,
                    avance: parseInt(form.querySelector('#edit-avance')?.value, 10) || proyectos[idx].avance || 0,
                    participantes: []
                };

                // Recoger participantes con validación
                document.querySelectorAll('.participante-item').forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    if (inputs.length >= 3) {
                        updated.participantes.push({
                            nombre: inputs[0]?.value?.trim() || '',
                            rol: inputs[1]?.value?.trim() || '',
                            participacion: parseInt(inputs[2]?.value, 10) || 0
                        });
                    }
                });

                // Actualizar y guardar
                proyectos[idx] = updated;
                localStorage.setItem('proyectos', JSON.stringify(proyectos));
                
                // Actualizar UI y cerrar modal
                cargarProyectos({});
                bootstrap.Modal.getInstance(document.getElementById('editarModal'))?.hide();
                
                // Feedback visual
                Swal.fire({
                    icon: 'success',
                    title: '¡Guardado!',
                    text: 'Cambios actualizados correctamente',
                    timer: 1500
                });

            } catch (error) {
                console.error('Error al guardar:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudieron guardar los cambios'
                });
            }
        }

        // Eliminar proyecto
        async function eliminarProyecto(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este proyecto?')) {
                try {
                    const response = await fetch(`/api/proyectos/${id}`, {
                        method: 'DELETE'
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Proyecto eliminado correctamente');
                        await cargarProyectos(); // Recargar la lista
                    } else {
                        alert('Error al eliminar el proyecto: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar proyecto:', error);
                    alert('Error al eliminar el proyecto');
                }
            }
        }

        function confirmarEliminacion() {
            const id = document.getElementById('delete-id').value;
            let proyectos = JSON.parse(localStorage.getItem('proyectos') || '[]');
            proyectos = proyectos.filter(p => p.id !== id);
            localStorage.setItem('proyectos', JSON.stringify(proyectos));
            cargarProyectos();
            bootstrap.Modal.getInstance(document.getElementById('eliminarModal')).hide();
        }

        // Funciones para manejar participantes
        function agregarParticipante() {
            const container = document.querySelector('.participantes-list');
            const index = container.children.length;
            
            container.innerHTML += `
                <div class="participante-item mb-2">
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="text" class="form-control" placeholder="Nombre" data-index="${index}">
                        </div>
                        <div class="col-3">
                            <select class="form-select" data-index="${index}">
                                <option>Arquitecto</option>
                                <option>Ingeniero</option>
                                <option>Cliente</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control" placeholder="Participación %" data-index="${index}">
                        </div>
                        <div class="col-2">
                            <button class="btn btn-danger btn-sm" onclick="eliminarParticipante(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function eliminarParticipante(index) {
            document.querySelectorAll('.participante-item')[index].remove();
        }

        function getBadgeEstado(estado) {
            switch ((estado || '').toLowerCase()) {
                case 'sin aprobar': 
                    return '<span class="badge bg-secondary">Sin aprobar</span>';
                case 'aprobado sin desembolsar': 
                    return '<span class="badge bg-primary">Aprobado sin desembolsar</span>';
                case 'en preoperativo': 
                    return '<span class="badge bg-info text-dark">En preoperativo</span>';
                case 'en construcción': 
                    return '<span class="badge bg-warning text-dark">En construcción</span>';
                case 'en escrituración': 
                    return '<span class="badge bg-success">En escrituración</span>';
                case 'cancelado': 
                case 'desistido': 
                    return '<span class="badge bg-danger">' + (estado || 'Cancelado') + '</span>';
                default: 
                    return `<span class="badge bg-light text-dark">${estado || 'Activo'}</span>`;
            }
        }


        // Modificar la función verProyecto para usar ID
        async function verProyecto(id) {
            try {
                // 1. Buscar proyecto usando API
                const response = await fetch(`/api/proyectos/${id}`);
                const result = await response.json();
                
                if (!result.success) {
                    Swal.fire('Error', `Proyecto con ID ${id} no existe`, 'error');
                    return;
                }

                const proyecto = result.proyecto;

                // 2. Construir contenido dinámico
                const contenidoHTML = `
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>${proyecto.nombre_proyecto || 'Proyecto sin nombre'}</h4>
                            <button class="btn btn-primary btn-sm" onclick="mostrarHistorial('${id}')">
                                <i class="fas fa-history me-2"></i>Ver Historial
                            </button>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>ID Proyecto:</strong> ${proyecto.id_proyecto}</p>
                                <p><strong>Titular:</strong> ${proyecto.titular_credito || 'No registrado'}</p>
                                <p><strong>NIT:</strong> ${proyecto.nit_titular || proyecto.nit || 'Sin NIT'}</p>
                                <p><strong>Vigencia:</strong> ${proyecto.vigencia_en_meses || 'No definida'} meses</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Avance:</strong> 
                                    <div class="progress">
                                        <div class="progress-bar" 
                                            style="width: ${proyecto.avance || 0}%">
                                            ${proyecto.avance || 0}%
                                        </div>
                                    </div>
                                </p>
                                <p><strong>Estado:</strong> 
                                    ${getBadgeEstado(proyecto.estado)}
                                </p>
                            </div>
                        </div>

                        ${proyecto.participantes?.length ? `
                        <div class="mt-4">
                            <h5>Participantes</h5>
                            <ul class="list-group">
                                ${proyecto.participantes.map(p => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${p.nombre || 'N/A'}
                                        <span class="badge bg-primary rounded-pill">
                                            ${p.rol || 'Sin rol'}
                                        </span>
                                        <span class="text-muted">${p.participacion || 0}%</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                        ` : ''}

                        ${proyecto.gestiones?.length ? `
                        <div class="mt-4">
                            <h5>Historial de Gestiones</h5>
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Fecha</th>
                                            <th>Tipo</th>
                                            <th>Usuario</th>
                                            <th>Detalles</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${proyecto.gestiones.map(g => `
                                            <tr>
                                                <td>${formatFecha(g.fecha)}</td>
                                                <td>${g.tipo || 'N/A'}</td>
                                                <td>${g.usuario || 'N/A'}</td>
                                                <td>${g.comentarios || 'Sin comentarios'}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        ` : ''}
                    </div>`;

                // 3. Inyectar contenido y mostrar modal
                const detalleContent = document.getElementById('detalle-content');
                detalleContent.innerHTML = contenidoHTML;
                new bootstrap.Modal(document.getElementById('detalleModal')).show();

            } catch (error) {
                console.error('Error en verProyecto:', error);
                Swal.fire('Error', 'No se pudo cargar el detalle del proyecto', 'error');
            }
        }


        // 2) Al enviar el formulario, evita el submit y llama a cargarProyectos
        document.getElementById('form-consulta').addEventListener('submit', function(e) {
            e.preventDefault();
            const filtros = {
                id_proyecto: (this.elements['id_proyecto']?.value || '').trim(),
                proyecto: (this.elements['proyecto']?.value || '').trim(),
                titular: (this.elements['titular']?.value || '').trim(),
                nit: (this.elements['nit']?.value || '').trim(),
                estado_proyecto: document.getElementById('estado_proyecto').value
            };
            cargarProyectos(filtros);
        });

        // Exportar a Excel
        document.getElementById('btn-exportar').addEventListener('click', () => {
            const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Cabeceras
            csvContent += "Proyecto,Titular,NIT,Arquitecto,Avance%,Fecha Creacion\n";
            
            // Datos
            proyectos.forEach(proyecto => {
                const row = [
                    `"${proyecto.nombre_proyecto}"`,
                    `"${proyecto.titular}"`,
                    proyecto.nit,
                    (proyecto.participantes || []).find(p => p.rol === 'Arquitecto')?.nombre || 'N/A',
                    proyecto.avance || 0,
                    formatFecha(proyecto.fecha_creacion)
                ].join(',');
                csvContent += row + "\n";
            });
            
            // Descargar
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "proyectos.csv");
            document.body.appendChild(link);
            link.click();
        });

    // Mostrar modal de gestión
    async function mostrarModalGestion(tipo, proyectoId) {
        try {
            // Primero obtener los datos del proyecto
            const response = await fetch(`/api/proyectos/${proyectoId}`);
            const result = await response.json();
            
            if (!result.success) {
                alert('Proyecto no encontrado');
                return;
            }

            const proyecto = result.proyecto;
            
            // Configurar el modal según el tipo de gestión
            document.getElementById('gestionModalTitle').textContent = `Gestión: ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
            document.getElementById('gestion-tipo').value = tipo;
            document.getElementById('gestion-id').value = proyectoId;
            
            // Ocultar todos los contenidos primero
            document.querySelectorAll('.gestion-contenido').forEach(el => {
                el.style.display = 'none';
            });
            
            // Mostrar el contenido específico según el tipo
            const contenido = document.getElementById(`contenido-${tipo}`);
            if (contenido) {
                contenido.style.display = 'block';
                
                // Llenar campos según el tipo
                switch(tipo) {
                    case 'titular':
                        document.getElementById('actual-titular').value = proyecto.titular_credito || '';
                        break;
                    case 'nombre':
                        document.getElementById('actual-nombre').value = proyecto.nombre_proyecto || '';
                        break;
                    case 'unidades':
                        document.getElementById('actual-unidades').value = proyecto.total_inmuebles || 0;
                        break;
                    case 'desistimiento':
                        // Establecer fecha actual por defecto
                        document.getElementById('fecha-desistimiento').value = new Date().toISOString().split('T')[0];
                        break;
                    case 'monto':
                        document.getElementById('actual-monto').value = proyecto.total_valor_aprobado || 0;
                        break;
                    case 'vigencia':
                        // Puedes establecer la vigencia actual si está disponible
                        if (proyecto.vigencia_en_meses) {
                            const fechaActual = new Date();
                            fechaActual.setMonth(fechaActual.getMonth() + parseInt(proyecto.vigencia_en_meses));
                            document.getElementById('actual-vigencia').value = fechaActual.toISOString().split('T')[0];
                        }
                        break;
                    case 'plazo':
                        document.getElementById('actual-plazo').value = proyecto.plazo_ajustado || proyecto.meses_programacion || 0;
                        break;
                }
            }
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('gestionModal'));
            modal.show();
            
        } catch (error) {
            console.error('Error al cargar datos para el modal:', error);
            alert('Error al cargar los datos del proyecto');
        }
    }
    
    // Guardar gestión
    async function guardarGestion() {
        const tipo = document.getElementById('gestion-tipo').value;
        const proyectoId = document.getElementById('gestion-id').value;
        const comentarios = document.querySelector('#form-gestion textarea').value;
        
        let datosGestion = {
            tipo: tipo,
            fecha: new Date().toISOString(),
            comentarios: comentarios,
            usuario: '{{ session.usuario.nombre }}' // Usuario desde sesión
        };
        
        // Recoger datos específicos según el tipo
        switch(tipo) {
            case 'titular':
                datosGestion.actual = document.getElementById('actual-titular').value;
                datosGestion.nuevo = document.getElementById('nuevo-titular').value;
                break;
            case 'nombre':
                datosGestion.actual = document.getElementById('actual-nombre').value;
                datosGestion.nuevo = document.getElementById('nuevo-nombre').value;
                break;
            case 'unidades':
                datosGestion.actual = document.getElementById('actual-unidades').value;
                datosGestion.nuevo = document.getElementById('nuevo-unidades').value;
                datosGestion.tipo_modificacion = document.getElementById('tipo-modificacion').value;
                break;
            case 'desistimiento':
                datosGestion.motivo = document.getElementById('motivo-desistimiento').value;
                datosGestion.fecha_efectiva = document.getElementById('fecha-desistimiento').value;
                break;
            case 'monto':
                datosGestion.actual = document.getElementById('actual-monto').value;
                datosGestion.nuevo = document.getElementById('nuevo-monto').value;
                break;
            case 'vigencia':
                datosGestion.actual = document.getElementById('actual-vigencia').value;
                datosGestion.nuevo = document.getElementById('nueva-vigencia').value;
                break;
            case 'plazo':
                datosGestion.actual = document.getElementById('actual-plazo').value;
                datosGestion.nuevo = document.getElementById('nuevo-plazo').value;
                break;
        }
        
        try {
            const response = await fetch(`/api/proyectos/${proyectoId}/gestiones`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(datosGestion)
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('Gestión guardada correctamente');
                
                // Cerrar el modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('gestionModal'));
                modal.hide();
                
                // Recargar el proyecto para ver los cambios
                await cargarProyectos();
            } else {
                alert('Error al guardar la gestión: ' + result.message);
            }
        } catch (error) {
            console.error('Error al guardar gestión:', error);
            alert('Error al guardar la gestión');
        }
    }
    
    // Cargar gestiones de un proyecto (para el modal de historial)
    async function cargarGestiones(proyectoId) {
        try {
            const response = await fetch(`/api/proyectos/${proyectoId}`);
            const result = await response.json();
            
            if (!result.success) {
                console.error('Error al cargar gestiones:', result.message);
                return;
            }
            
            const proyecto = result.proyecto;
            const gestiones = proyecto.gestiones || [];
            
            // Aquí puedes implementar la visualización de gestiones en tu modal de historial
            console.log('Gestiones del proyecto:', gestiones);
            
        } catch (error) {
            console.error('Error al cargar gestiones:', error);
        }
    }

    // Eliminar gestión
    async function eliminarGestion(proyectoId, gestionId) {
        if (confirm('¿Estás seguro de que deseas eliminar esta gestión?')) {
            try {
                const response = await fetch(`/api/proyectos/${proyectoId}/gestiones/${gestionId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Gestión eliminada correctamente');
                    await cargarGestiones(proyectoId); // Recargar las gestiones
                } else {
                    alert('Error al eliminar la gestión: ' + result.message);
                }
            } catch (error) {
                console.error('Error al eliminar gestión:', error);
                alert('Error al eliminar la gestión');
            }
        }
    }

    
    // Funciones de utilidad (globales)
    function formatFecha(valor) {
        if (!valor) return 'N/A';
        try {
            if (typeof valor === 'string' && valor.includes('T')) {
                return new Date(valor).toLocaleDateString('es-CO');
            }
            if (typeof valor === 'number') {
                return new Date((valor - 25569) * 86400 * 1000).toLocaleDateString('es-CO');
            }
            return valor;
        } catch (e) {
            console.error('Error formateando fecha:', valor, e);
            return 'Formato inválido';
        }
    }

    function formatCurrency(value) {
        if (isNaN(value)) return '$0';
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }

    function getNestedValue(obj, path) {
        try {
            return path.split('.').reduce((o, p) => o[p], obj);
        } catch (e) {
            return null;
        }
    }

    // Funciones de historial
    function cargarHistorialVentas(idProyecto) {
        try {
            const historial = JSON.parse(localStorage.getItem('historialVentas') || '[]');
            const ventasProyecto = historial.filter(v => v.proyectoId === idProyecto);
            const tbody = document.querySelector('#tabla-ventas tbody');
            tbody.innerHTML = '';

            if (ventasProyecto.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros de ventas</td></tr>';
                return;
            }

            ventasProyecto.forEach((d, index) => {
            const campos = d.campos || {};
            tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td> <!-- Columna enumeradora -->
                        <td>${formatFecha(d.fechaCarga)}</td>
                        <td>${d.usuario || 'N/A'}</td>
                        <td>${getNestedValue(campos, 'FECHA INICIO DE VENTAS.valor') || 'N/A'}</td>
                        <td>${getNestedValue(campos, 'INMUEBLES VENDIDOS (unidades).valor') || 0}</td>
                        <td>${(getNestedValue(campos, '% PORCENTAJE DE VENTAS (unidades).valor') || 0 * 100).toFixed(2)}%</td>
                        <td>${formatCurrency(getNestedValue(campos, 'valor inmuebles vendidos.valor') || 0)}</td>
                        <td>${formatCurrency(getNestedValue(campos, 'cartera RECAUDADA.valor') || 0)}</td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('Error cargando ventas:', error);
            const tbody = document.querySelector('#tabla-ventas tbody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar ventas</td></tr>';
        }
    }

    // Función mejorada para cargar historial de visitas
    function cargarHistorialVisitas(idProyecto) {
        try {
            // Obtener datos del localStorage con valor por defecto seguro
            const historialData = localStorage.getItem('historialVisitas') || '[]';
            const historial = JSON.parse(historialData);
            
            const visitasProyecto = Array.isArray(historial) ? 
                historial.filter(v => v.proyectoId === idProyecto) : [];
                
            const tbody = document.querySelector('#tabla-visitas tbody');
            tbody.innerHTML = '';

            if (visitasProyecto.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros de visitas</td></tr>';
                return;
            }

            visitasProyecto.forEach((d, index) => {
            const campos = d.campos || {};
            tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td> <!-- Columna enumeradora -->
                        <td>${formatFecha(getNestedValue(campos, 'FECHA VISITA.valor'))}</td>
                        <td>${d.usuario || 'N/A'}</td>
                        <td>${getNestedValue(campos, 'NUMERO VISITA.valor') || 'N/A'}</td>
                        <td>${getNestedValue(campos, 'AVANCE OBRA.valor') || 'N/A'}</td>
                        <td>${(getNestedValue(campos, 'AVANCE ESPERADO PORCENTAJE.valor') || 0).toFixed(2)}%</td>
                        <td>${getNestedValue(campos, 'ESTADO EJECUCIÓN OBRA.valor') || 'N/A'}</td>
                        <td>${getNestedValue(campos, 'RESUMEN ALERTA DEL PROYECTO.valor') || 'Sin alertas'}</td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('Error cargando visitas:', error);
            const tbody = document.querySelector('#tabla-visitas tbody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar los datos de visitas</td></tr>';
        }
    }

    function cargarHistorialDesembolsosDiarios(idProyecto) {
        try {
            const historial = JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');
            const desembolsosProyecto = historial.filter(d => d.proyectoId === idProyecto);
            const tbody = document.querySelector('#tabla-desembolsos tbody');
            tbody.innerHTML = '';

            if (desembolsosProyecto.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros de desembolsos</td></tr>';
                return;
            }

            desembolsosProyecto.forEach((d, index) => {
            const campos = d.campos || {};
            tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td> <!-- Columna enumeradora -->
                        <td>${formatFecha(d.fechaCarga)}</td>
                        <td>${d.usuario || 'N/A'}</td>
                        <td>${formatCurrency(campos.valorEntregado || 0)}</td>
                        <td>${formatCurrency(campos.valorPorEntregar || 0)}</td>
                        <td>${(campos.cobertura || 0).toFixed(2)}%</td>
                        <td>${formatCurrency(campos.superavit || 0)}</td>
                        <td>${campos.requiereVistoBueno ? 'Sí' : 'No'}</td>
                    </tr>
                `;
            });
        } catch (error) {
            console.error('Error cargando desembolsos:', error);
            const tbody = document.querySelector('#tabla-desembolsos tbody');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar desembolsos</td></tr>';
        }
    }

    // Función mejorada para mostrar el historial
    function mostrarHistorial(idProyecto) {
        try {
            // Obtener historiales desde localStorage
            const historialVentas = JSON.parse(localStorage.getItem('historialVentas') || '[]');
            const historialVisitas = JSON.parse(localStorage.getItem('historialVisitas') || '[]');
            const historialDesembolsos = JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');
            
            // Filtrar por proyecto
            const ventasProyecto = historialVentas.filter(v => v.proyectoId == idProyecto);
            const visitasProyecto = historialVisitas.filter(v => v.proyectoId == idProyecto);
            const desembolsosProyecto = historialDesembolsos.filter(d => d.proyectoId == idProyecto);
            
            // Verificar si hay datos
            if (ventasProyecto.length === 0 && visitasProyecto.length === 0 && desembolsosProyecto.length === 0) {
                Swal.fire({
                    title: 'Historial vacío',
                    text: 'Este proyecto no tiene registros de ventas, visitas ni desembolsos',
                    icon: 'info',
                    confirmButtonText: 'Entendido'
                });
                return;
            }
            
            // Cargar datos en las tablas
            if (ventasProyecto.length > 0) {
                cargarHistorialVentas(idProyecto);
                document.querySelector('[data-tipo="ventas"]').classList.add('active');
                document.getElementById('contenido-ventas').style.display = 'block';
            } else if (visitasProyecto.length > 0) {
                cargarHistorialVisitas(idProyecto);
                document.querySelector('[data-tipo="visitas"]').classList.add('active');
                document.getElementById('contenido-visitas').style.display = 'block';
            } else if (desembolsosProyecto.length > 0) {
                cargarHistorialDesembolsosDiarios(idProyecto);
                document.querySelector('[data-tipo="desembolsos"]').classList.add('active');
                document.getElementById('contenido-desembolsos').style.display = 'block';
            }
            
            // Mostrar modal
            const modal = document.getElementById('historialModal');
            modal.dataset.proyectoId = idProyecto;
            new bootstrap.Modal(modal).show();
            
        } catch (error) {
            console.error('Error mostrando historial:', error);
            Swal.fire('Error', 'No se pudo cargar el historial', 'error');
        }
    }
    // Configuración de event listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Cargar proyectos iniciales
        cargarProyectos();
        
        // Manejar botones de tipo de historial
        document.querySelectorAll('[data-tipo]').forEach(btn => {
            btn.addEventListener('click', function() {
                const tipo = this.dataset.tipo;
                const proyectoId = document.getElementById('historialModal').dataset.proyectoId;
                
                // Actualizar botones activos
                document.querySelectorAll('[data-tipo]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Ocultar todos los contenidos
                document.querySelectorAll('.historial-contenido').forEach(c => c.style.display = 'none');
                
                // Mostrar contenido seleccionado
                document.getElementById(`contenido-${tipo}`).style.display = 'block';
                
                // Cargar datos según el tipo
                switch(tipo) {
                    case 'ventas':
                        cargarHistorialVentas(proyectoId);
                        break;
                    case 'visitas':
                        cargarHistorialVisitas(proyectoId);
                        break;
                    case 'desembolsos':
                        cargarHistorialDesembolsosDiarios(proyectoId);
                        break;
                }
            });
        });

        // Botón de exportar PDF
        document.getElementById('btn-export-pdf').addEventListener('click', function() {
            const tipoActivo = document.querySelector('[data-tipo].active').dataset.tipo;
            exportarAPDF(tipoActivo);
        });
    });
        
        let isGeneratingPDF = false;

        async function exportarAPDF(tipo) {
            if (isGeneratingPDF) return;
            isGeneratingPDF = true;

            try {
                Swal.fire({
                    title: 'Generando PDF',
                    html: 'Preparando documento...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const modal = document.getElementById('historialModal');
                const activeTabContent = modal.querySelector(`#contenido-${tipo}`);

                if (!activeTabContent) {
                    throw new Error(`No se encontró el contenido para ${tipo}`);
                }

                const contentClone = activeTabContent.cloneNode(true);

                const elementsToHide = contentClone.querySelectorAll('.btn, .no-print');
                elementsToHide.forEach(el => el.style.display = 'none');

                const printStyles = `
                    <style>
                        * {
                            box-sizing: border-box;
                        }
                        body {
                            font-family: Arial, sans-serif;
                            font-size: 11px;
                            margin: 0;
                            padding: 0;
                        }
                        .pdf-content {
                            padding: 20px 45px 30px 55px; /* Aumentado el padding izquierdo a 55px */
                            max-width: 100%;
                            width: 100%;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 15px;
                            table-layout: fixed;
                            word-wrap: break-word;
                            font-size: 10px;
                        }
                        th, td {
                            padding: 6px;
                            border: 1px solid #ddd;
                            text-align: left;
                            word-break: break-word;
                            font-size: 9.5px;
                        }
                        th {
                            background-color: #004884;
                            color: white;
                        }
                        .text-center {
                            text-align: center;
                        }
                        .text-right {
                            text-align: right;
                        }
                        h1 {
                            color: #004884;
                            text-align: center;
                            margin-bottom: 5px;
                            font-size: 16px;
                        }
                        h2 {
                            text-align: center;
                            margin-top: 0;
                            margin-bottom: 15px;
                            font-size: 14px;
                        }
                        .footer {
                            text-align: right;
                            margin-top: 30px;
                            font-size: 0.8em;
                            color: #666;
                        }
                    </style>
                `;

                const proyectoId = modal.dataset.proyectoId;
                const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];
                const proyecto = proyectos.find(p => p.id_proyecto === proyectoId) || {};

                const header = `
                    <h1>Historial de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</h1>
                    <h2>${proyecto.nombre_proyecto || 'Proyecto no encontrado'}</h2>
                `;

                const footer = `
                    <div class="footer">
                        Generado el ${new Date().toLocaleDateString('es-CO', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>
                `;

                const pdfContainer = document.createElement('div');
                pdfContainer.innerHTML = `
                    ${printStyles}
                    <div class="pdf-content">
                        ${header}
                        ${contentClone.innerHTML}
                        ${footer}
                    </div>
                `;
                document.body.appendChild(pdfContainer);

                await new Promise(resolve => setTimeout(resolve, 300));

                const options = {
                    margin: 0,
                    filename: `Historial_${tipo}_${proyecto.nombre_proyecto || 'proyecto'}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        scrollX: 0,
                        scrollY: 0,
                        windowWidth: 2000, // aumentamos mas el viewport simulado
                        letterRendering: true
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: [330, 216],
                        orientation: 'landscape'
                    }
                };

                await html2pdf().set(options).from(pdfContainer).save();

                document.body.removeChild(pdfContainer);
                Swal.close();

            } catch (error) {
                console.error('Error al generar PDF:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `No se pudo generar el PDF: ${error.message}`
                });
            } finally {
                isGeneratingPDF = false;
            }
        }
        
        // Event listener mejorado
        document.addEventListener('DOMContentLoaded', function() {
            const btnExportPdf = document.getElementById('btn-export-pdf');
            
            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', function() {
                    const activeTab = document.querySelector('[data-tipo].active');
                    if (activeTab) {
                        exportarAPDF(activeTab.dataset.tipo);
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Seleccione una pestaña',
                            text: 'Por favor active una pestaña (Ventas, Visitas o Desembolsos) antes de exportar'
                        });
                    }
                });
            }
        });

        // Función para generar contenido de ventas en PDF (síncrona ahora)
        function generarContenidoVentasPDF(proyecto) {
            try {
                const historial = JSON.parse(localStorage.getItem('historialVentas')) || [];
                const ventasProyecto = historial.filter(v => v.proyectoId === proyecto.id_proyecto);
                
                // Verificar si hay datos
                if (ventasProyecto.length === 0) {
                    return `
                        <div style="font-family: Arial, sans-serif; padding: 20px;">
                            <h1 style="text-align: center; color: #004884;">Historial de Ventas</h1>
                            <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                            <p style="text-align: center; color: red; margin-top: 50px;">
                                No hay datos de ventas disponibles para este proyecto
                            </p>
                            <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                                Generado el ${new Date().toLocaleDateString('es-CO', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                        </div>
                    `;
                }

                const rows = ventasProyecto.map(v => {
                    const campos = v.campos || {};
                    const fechaInicioVentas = campos['FECHA INICIO DE VENTAS']?.valor || campos['FECHA INICIO DE VENTAS'] || 'N/A';
                    const inmueblesVendidos = campos['INMUEBLES VENDIDOS (unidades)']?.valor || campos['INMUEBLES VENDIDOS (unidades)'] || 0;
                    const porcentajeVentas = campos['% PORCENTAJE DE VENTAS (unidades)']?.valor || campos['% PORCENTAJE DE VENTAS (unidades)'] || 0;
                    const valorVendido = campos['valor inmuebles vendidos']?.valor || campos['valor inmuebles vendidos'] || 0;
                    const carteraRecaudada = campos['cartera RECAUDADA']?.valor || campos['cartera RECAUDADA'] || 0;

                    return `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatFecha(v.fechaCarga)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${v.usuario || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatFecha(fechaInicioVentas)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${inmueblesVendidos}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${(porcentajeVentas * 100).toFixed(2)}%</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(valorVendido)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(carteraRecaudada)}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div style="font-family: Arial, sans-serif; padding: 20px; width: 100%;">
                        <h1 style="text-align: center; color: #004884;">Historial de Ventas</h1>
                        <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                        <p style="text-align: center;">${proyecto.direccion || ''}</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background-color: #004884; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">Fecha Carga</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Usuario</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Inicio Ventas</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Inmuebles Vendidos</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">% Ventas</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Valor Vendido</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Cartera Recaudada</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        
                        <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                            Generado el ${new Date().toLocaleDateString('es-CO', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error generando contenido de ventas:', error);
                return generarErrorPDF('ventas', error.message);
            }
        }

        // Función para generar contenido de visitas en PDF (síncrona ahora)
        function generarContenidoVisitasPDF(proyecto) {
            try {
                const historial = JSON.parse(localStorage.getItem('historialVisitas')) || [];
                const visitasProyecto = historial.filter(v => v.proyectoId === proyecto.id_proyecto);
                
                // Verificar si hay datos
                if (visitasProyecto.length === 0) {
                    return `
                        <div style="font-family: Arial, sans-serif; padding: 20px;">
                            <h1 style="text-align: center; color: #004884;">Historial de Visitas</h1>
                            <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                            <p style="text-align: center; color: red; margin-top: 50px;">
                                No hay datos de visitas disponibles para este proyecto
                            </p>
                            <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                                Generado el ${new Date().toLocaleDateString('es-CO', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                        </div>
                    `;
                }

                const rows = visitasProyecto.map(v => {
                    const campos = v.campos || {};
                    const fechaVisita = campos['FECHA VISITA']?.valor || campos['FECHA VISITA'] || 'N/A';
                    const numeroVisita = campos['NUMERO VISITA']?.valor || campos['NUMERO VISITA'] || 'N/A';
                    const avanceObra = campos['AVANCE OBRA']?.valor || campos['AVANCE OBRA'] || 'N/A';
                    const avanceEsperado = campos['AVANCE ESPERADO PORCENTAJE']?.valor || campos['AVANCE ESPERADO PORCENTAJE'] || 0;
                    const estadoObra = campos['ESTADO EJECUCIÓN OBRA']?.valor || campos['ESTADO EJECUCIÓN OBRA'] || 'N/A';
                    const alertas = campos['RESUMEN ALERTA DEL PROYECTO']?.valor || campos['RESUMEN ALERTA DEL PROYECTO'] || 'Sin alertas';

                    return `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatFecha(fechaVisita)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${numeroVisita}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${v.usuario || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${avanceObra}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${avanceEsperado.toFixed(2)}%</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${estadoObra}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${alertas}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div style="font-family: Arial, sans-serif; padding: 20px; width: 100%;">
                        <h1 style="text-align: center; color: #004884;">Historial de Visitas</h1>
                        <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                        <p style="text-align: center;">${proyecto.direccion || ''}</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background-color: #004884; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">Fecha Visita</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">N° Visita</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Usuario</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Avance Obra</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">% Ejecución</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Estado Obra</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Alertas</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        
                        <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                            Generado el ${new Date().toLocaleDateString('es-CO', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error generando contenido de visitas:', error);
                return generarErrorPDF('visitas', error.message);
            }
        }

        // Función para generar contenido de desembolsos en PDF (síncrona ahora)
        function generarContenidoDesembolsosPDF(proyecto) {
            try {
                const historial = JSON.parse(localStorage.getItem('historialDesembolsosDiarios')) || [];
                const desembolsosProyecto = historial.filter(d => d.proyectoId === proyecto.id_proyecto);
                
                // Verificar si hay datos
                if (desembolsosProyecto.length === 0) {
                    return `
                        <div style="font-family: Arial, sans-serif; padding: 20px;">
                            <h1 style="text-align: center; color: #004884;">Historial de Desembolsos</h1>
                            <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                            <p style="text-align: center; color: red; margin-top: 50px;">
                                No hay datos de desembolsos disponibles para este proyecto
                            </p>
                            <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                                Generado el ${new Date().toLocaleDateString('es-CO', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                        </div>
                    `;
                }

                const rows = desembolsosProyecto.map(d => {
                    const campos = d.campos || {};
                    const valorEntregado = campos.valorEntregado || 0;
                    const valorPorEntregar = campos.valorPorEntregar || 0;
                    const cobertura = campos.cobertura || 0;
                    const superavit = campos.superavit || 0;
                    const requiereVistoBueno = campos.requiereVistoBueno ? 'Sí' : 'No';

                    return `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatFecha(d.fechaCarga)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${d.usuario || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(valorEntregado)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(valorPorEntregar)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${cobertura.toFixed(2)}%</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(superavit)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${requiereVistoBueno}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div style="font-family: Arial, sans-serif; padding: 20px; width: 100%;">
                        <h1 style="text-align: center; color: #004884;">Historial de Desembolsos</h1>
                        <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                        <p style="text-align: center;">${proyecto.direccion || ''}</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background-color: #004884; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">Fecha</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Usuario</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Valor Entregado</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Valor por Entregar</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Cobertura</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Superávit</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Visto Bueno</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        
                        <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                            Generado el ${new Date().toLocaleDateString('es-CO', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error generando contenido de desembolsos:', error);
                return generarErrorPDF('desembolsos', error.message);
            }
        }

        // Función para generar PDF de error
        function generarErrorPDF(tipo, mensajeError) {
            return `
                <div style="font-family: Arial, sans-serif; padding: 20px; color: red;">
                    <h1 style="text-align: center;">Error al generar el reporte de ${tipo}</h1>
                    <h2 style="text-align: center;">Detalles del error:</h2>
                    <p style="text-align: center; margin-top: 30px;">${mensajeError}</p>
                    <p style="text-align: right; margin-top: 50px; font-size: 0.8em;">
                        Generado el ${new Date().toLocaleDateString('es-CO', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </p>
                </div>
            `;
        }

        // Función para formatear fechas
        function formatFecha(valor) {
            if (!valor) return 'N/A';
            
            try {
                // Si es una cadena de fecha ISO
                if (typeof valor === 'string' && valor.includes('T')) {
                    const fecha = new Date(valor);
                    return fecha.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
                
                // Si es un objeto de fecha de Excel (timestamp serial)
                if (typeof valor === 'number') {
                    const fecha = new Date((valor - 25569) * 86400 * 1000);
                    return fecha.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }
                
                // Si ya está formateado
                return valor;
            } catch (e) {
                console.error('Error formateando fecha:', valor, e);
                return 'Formato inválido';
            }
        }

        // Función para formatear moneda
        function formatCurrency(value) {
            if (isNaN(value)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Event listener mejorado para el botón de exportar PDF
        document.addEventListener('DOMContentLoaded', function() {
            const btnExportPdf = document.getElementById('btn-export-pdf');
            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', function() {
                    const tipoActivo = document.querySelector('[data-tipo].active');
                    if (tipoActivo) {
                        exportarAPDF(tipoActivo.dataset.tipo);
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Seleccione un tipo',
                            text: 'Por favor seleccione un tipo de historial (ventas, visitas o desembolsos) antes de exportar'
                        });
                    }
                });
            } else {
                console.error('El botón btn-export-pdf no fue encontrado en el DOM');
            }
        });
        // Event listener para el botón de exportar PDF
        document.addEventListener('DOMContentLoaded', function() {
            const btnExportPdf = document.getElementById('btn-export-pdf');
            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', function() {
                    const tipoActivo = document.querySelector('[data-tipo].active');
                    if (tipoActivo) {
                        exportarAPDF(tipoActivo.dataset.tipo);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Por favor seleccione un tipo de historial primero'
                        });
                    }
                });
            }
        });
        let paginaActual = 1;
        let tamanoPagina = 10;
        let proyectosFiltrados = [];

        async function cargarProyectos(filtros = {}) {
            const userRole = obtenerRolUsuario();
    
            try {
                    // Obtener proyectos del servidor
                    const response = await fetch('/api/proyectos');
                    if (!response.ok) throw new Error('Error al cargar proyectos');
                    let proyectos = await response.json();

                    // Ordenar y filtrar (mantén tu lógica existente)
                    const parseFecha = (v) => {
                        if (!v) return 0;
                        const d = new Date(v);
                        return isNaN(d.getTime()) ? 0 : d.getTime();
                    };

                    proyectos.sort((a, b) => parseFecha(b.fecha_creacion) - parseFecha(a.fecha_creacion));


                // Filtrar
                proyectos = proyectos.filter(p => {
                    let ok = true;

                    // Nuevo filtro por ID Proyecto
                    if (filtros.id_proyecto) {
                        const busq = filtros.id_proyecto.toLowerCase();
                        ok = ok && (p.id_proyecto || '').toString().toLowerCase().includes(busq);
                    }

                    if (filtros.proyecto) {
                        const busq = filtros.proyecto.toLowerCase();
                        ok = ok && (
                            (p.id_proyecto || '').toString().toLowerCase().includes(busq) ||
                            (p.nombre_proyecto || '').toLowerCase().includes(busq)
                        );
                    }
                    if (filtros.titular) {
                        const busq = filtros.titular.toLowerCase();
                        ok = ok && (p.titular_credito || '').toLowerCase().includes(busq);
                    }
                    if (filtros.nit) {
                        const busq = (filtros.nit || '').replace(/\D+/g, ''); // solo dígitos
                        ok = ok && (
                            ((p.nit_titular || '').toString().replace(/\D+/g, '')).includes(busq) ||
                            ((p.nit_grupo_riesgo || '').toString().replace(/\D+/g, '')).includes(busq)
                        );
                    }
                    if (filtros.estado_proyecto) {
                        const estadoProyecto = String(p.estado || 'sin aprobar').trim().toLowerCase();
                        const filtroEstado   = filtros.estado_proyecto.trim().toLowerCase();
                        ok = ok && (estadoProyecto === filtroEstado);
                    }

                    return ok;
                });

                proyectosFiltrados = proyectos; // Guardar filtrados para paginación
                paginaActual = 1; // Reiniciar página al aplicar filtros
                renderPagina(userRole);
                renderPaginacion();

            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudieron cargar los proyectos', 'error');
            }
        }


        function renderPagina(userRole) {
            const tbody = document.getElementById('resultados-body');
            tbody.innerHTML = '';

            const inicio = (paginaActual - 1) * tamanoPagina;
            const fin = inicio + tamanoPagina;
            const pagina = proyectosFiltrados.slice(inicio, fin);

            pagina.forEach(p => {
                const datos = {
                    nombre_proyecto: p.nombre_proyecto || 'Proyecto sin nombre',
                    estado: (p.estado !== undefined && p.estado !== null) ? p.estado : 'sin aprobar',
                    titular: p.titular_credito || 'Sin titular',
                    nit: p.nit_titular || p.nit_grupo_riesgo || 'Sin NIT',
                    arquitecto: p.arquitecto || p.gerente || 'Sin arquitecto',
                    avance: Math.min(Math.max(p.avance || 0, 0), 100),
                    perito: p.perito || '—'
                };

                const puedeEditar = ['admin', 'auxiliar'].includes(userRole);

                // Badge por estado
                let badge = '';
                switch ((datos.estado || '').toLowerCase()) {
                    case 'sin aprobar': badge = '<span class="badge bg-secondary">Sin aprobar</span>'; break;
                    case 'aprobado sin desembolsar': badge = '<span class="badge bg-primary">Aprobado sin desembolsar</span>'; break;
                    case 'en preoperativo': badge = '<span class="badge bg-info text-dark">En preoperativo</span>'; break;
                    case 'en construcción': badge = '<span class="badge bg-warning text-dark">En construcción</span>'; break;
                    case 'en escrituración': badge = '<span class="badge bg-success">En escrituración</span>'; break;
                    case 'cancelado': badge = '<span class="badge bg-danger">Cancelado</span>'; break;
                    default: badge = `<span class="badge bg-light text-dark">${datos.estado}</span>`;
                }

                tbody.innerHTML += `
                <tr>
                    <td>${datos.nombre_proyecto}</td>
                    <td>${badge}</td> <!-- Estado -->
                    <td>${datos.titular}</td>
                    <td>${datos.nit}</td>
                    <td>${datos.arquitecto}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" style="width:${datos.avance}%">
                                ${datos.avance}%
                            </div>
                        </div>
                    </td>
                    <td>${datos.perito}</td>
                    <td>
                        <div class="acciones-container">
                            <button class="btn btn-accion btn-accion-primary"
                                    onclick="verProyecto('${p.id_proyecto}')"
                                    data-bs-toggle="tooltip" title="Ver detalles">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            ${puedeEditar ? `
                                <button class="btn btn-accion btn-accion-secondary"
                                        onclick="editarProyecto('${p.id_proyecto}')"
                                        data-bs-toggle="tooltip" title="Editar proyecto">
                                    <i class="fas fa-edit"></i> Editar Grupo
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-accion btn-accion-secondary"
                                            data-bs-toggle="dropdown" title="Más acciones">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end animate__fadeIn">
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="mostrarModalGestion('titular','${p.id_proyecto}')">
                                                <i class="fas fa-user-edit me-2 text-primary"></i>
                                                Cambio Titular
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="mostrarModalGestion('nombre','${p.id_proyecto}')">
                                                <i class="fas fa-signature me-2 text-info"></i>
                                                Cambio Nombre
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="mostrarModalGestion('unidades','${p.id_proyecto}')">
                                                <i class="fas fa-cubes me-2 text-warning"></i>
                                                Gestión Unidades
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="mostrarModalGestion('desistimiento','${p.id_proyecto}')">
                                                <i class="fas fa-ban me-2 text-danger"></i>
                                                Desistimiento
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="mostrarModalGestion('monto','${p.id_proyecto}')">
                                                <i class="fas fa-coins me-2 text-success"></i>
                                                Ampliación de Monto
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="mostrarModalGestion('vigencia','${p.id_proyecto}')">
                                                <i class="fas fa-calendar-day me-2 text-info"></i>
                                                Ampliación de Vigencia
                                            </button>
                                        </li>
                                        <li>
                                            <button class="dropdown-item"
                                                    onclick="mostrarModalGestion('plazo','${p.id_proyecto}')">
                                                <i class="fas fa-clock me-2 text-warning"></i>
                                                Ampliación de Plazo
                                            </button>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                    </ul>
                                </div>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });

            if (pagina.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">— Sin resultados —</td>
                </tr>
                `;
            }
        }

        function renderPaginacion() {
            const totalPaginas = Math.ceil(proyectosFiltrados.length / tamanoPagina);
            const pagContainer = document.querySelector('.pagination');
            pagContainer.innerHTML = '';

            const btnPrev = document.createElement('li');
            btnPrev.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
            btnPrev.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
            btnPrev.onclick = e => { e.preventDefault(); if (paginaActual > 1) { paginaActual--; renderPagina(obtenerRolUsuario()); renderPaginacion(); } };
            pagContainer.appendChild(btnPrev);

            for (let i = 1; i <= totalPaginas; i++) {
                const btn = document.createElement('li');
                btn.className = `page-item ${paginaActual === i ? 'active' : ''}`;
                btn.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                btn.onclick = e => { e.preventDefault(); paginaActual = i; renderPagina(obtenerRolUsuario()); renderPaginacion(); };
                pagContainer.appendChild(btn);
            }

            const btnNext = document.createElement('li');
            btnNext.className = `page-item ${paginaActual === totalPaginas ? 'disabled' : ''}`;
            btnNext.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
            btnNext.onclick = e => { e.preventDefault(); if (paginaActual < totalPaginas) { paginaActual++; renderPagina(obtenerRolUsuario()); renderPaginacion(); } };
            pagContainer.appendChild(btnNext);
        }

        document.getElementById('page-size-select').addEventListener('change', function() {
            tamanoPagina = parseInt(this.value, 10);
            paginaActual = 1;
            renderPagina(obtenerRolUsuario());
            renderPaginacion();
        });

        window.addEventListener('DOMContentLoaded', () => {
            cargarProyectos({});
        });
    </script>
    <!-- Modal Detalles -->
    <div class="modal fade" id="detalleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Detalles del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalle-content"></div>
            </div>
        </div>
    </div>
    <!-- Modal Editar Proyecto -->
    <div class="modal fade" id="editarModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
            <h5 class="modal-title">Editar Proyecto</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <form id="form-editar">
                <input type="hidden" id="edit-id">
                <div class="mb-3">
                <label class="form-label">Nombre del Proyecto</label>
                <input type="text" class="form-control" id="edit-nombre" required>
                </div>
                <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Titular</label>
                    <input type="text" class="form-control" id="edit-titular" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">NIT</label>
                    <input type="text" class="form-control" id="edit-nit" required>
                </div>
                </div>
                <div class="mb-3">
                <label class="form-label">Avance (%)</label>
                <input type="number" class="form-control" id="edit-avance" min="0" max="100" required>
                </div>
                <div class="participantes-container mb-3">
                <label class="form-label">Participantes</label>
                <div class="participantes-list"></div>
                <button type="button" class="btn btn-sm btn-primary mt-2" onclick="agregarParticipante()">
                    <i class="fas fa-plus"></i> Agregar Participante
                </button>
                </div>
            </form>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-warning" onclick="guardarCambios()">Guardar Cambios</button>
            </div>
        </div>
        </div>
    </div>  
    <!-- Modal Eliminar -->
    <div class="modal fade" id="eliminarModal" tabindex="-1">
        <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">Confirmar Eliminación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
            <p>¿Está seguro que desea eliminar este proyecto? Esta acción no se puede deshacer.</p>
            <input type="hidden" id="delete-id">
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">Eliminar Definitivamente</button>
            </div>
        </div>
        </div>
    </div>
    <!-- Modal para Valores Calculados -->
    <div class="modal fade" id="modalDesembolsos" tabindex="-1" aria-labelledby="modalDesembolsosLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Valores Calculados del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Título con nombre del proyecto e ID -->
                    <div class="project-title">
                        <i class="fas fa-building me-2"></i>
                        <span id="titulo-proyecto">Proyecto sin nombre</span>
                    </div>
                    
                    <!-- Sección de valores calculados -->
                    <div class="values-section">
                        <h5 class="mb-3"><i class="fas fa-calculator me-2"></i>Valores Calculados</h5>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>VALOR ENTREGADO</td>
                                    <td id="modal-valor-entregado" class="value-highlight">$ 0</td>
                                </tr>
                                <tr>
                                    <td>VALOR POR ENTREGAR</td>
                                    <td id="modal-valor-por-entregar" class="value-highlight negative-value">$ 0</td>
                                </tr>
                                <tr>
                                    <td>A DESEMBOLSAR CONSTRUCTOR (% SOLICITADO)</td>
                                    <td id="modal-a-desembolsar" class="value-highlight">$ 0</td>
                                </tr>
                                <tr>
                                    <td>B DESEMBOLSAR CONSTRUCTOR (MÁXIMO %)</td>
                                    <td id="modal-b-desembolsar" class="value-highlight">$ 0</td>
                                </tr>
                                <tr>
                                    <td>SUPERÁVIT (C)</td>
                                    <td id="modal-superavit" class="value-highlight positive-value">$ 0</td>
                                </tr>
                                <tr>
                                    <td>COBERTURA</td>
                                    <td id="modal-cobertura" class="coverage-percentage">0.00%</td>
                                </tr>
                                <tr>
                                    <td>MÁXIMO A DESEMBOLSAR (POLÍTICA)</td>
                                    <td id="modal-maximo-desembolsar" class="value-highlight">$ 0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="filters-info">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <span class="info-label">Última Actualización:</span>
                                    <span id="modal-fecha-carga">No disponible</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <span class="info-label">Usuario:</span>
                                    <span id="modal-usuario">No disponible</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <span class="info-label">Requiere Visto Bueno:</span>
                                    <span id="modal-requiere-visto-bueno">No</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
   <!-- Modal para Gestiones -->
    <div class="modal fade" id="gestionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="gestionModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-gestion">
                        <input type="hidden" id="gestion-id">
                        <input type="hidden" id="gestion-tipo">
                        
                        <!-- Contenido dinámico -->
                        <div id="contenido-titular" class="gestion-contenido" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Titular Actual</label>
                                <input type="text" class="form-control" id="actual-titular" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nuevo Titular</label>
                                <input type="text" class="form-control" id="nuevo-titular" required>
                            </div>
                        </div>

                        <div id="contenido-nombre" class="gestion-contenido" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Nombre Actual</label>
                                <input type="text" class="form-control" id="actual-nombre" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nuevo Nombre</label>
                                <input type="text" class="form-control" id="nuevo-nombre" required>
                            </div>
                        </div>

                        <div id="contenido-unidades" class="gestion-contenido" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Unidades Actuales</label>
                                    <input type="number" class="form-control" id="actual-unidades" disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nuevo Valor</label>
                                    <input type="number" class="form-control" id="nuevo-unidades" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de Modificación</label>
                                <select class="form-select" id="tipo-modificacion" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="ajuste">Ajuste de unidades</option>
                                    <option value="ampliacion">Ampliación</option>
                                    <option value="reduccion">Reducción</option>
                                </select>
                            </div>
                        </div>
                        <!-- Contenido para Desistimiento -->
                            <div id="contenido-desistimiento" class="gestion-contenido" style="display:none;">
                                    <div class="mb-3">
                                        <label class="form-label">Motivo del Desistimiento</label>
                                        <textarea class="form-control" id="motivo-desistimiento" rows="3" required></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Fecha Efectiva</label>
                                        <input type="date" class="form-control" id="fecha-desistimiento" required>
                                    </div>
                            </div>
        
                            <!-- Contenido para Ampliación de Monto -->
                            <div id="contenido-monto" class="gestion-contenido" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Monto Actual</label>
                                            <input type="number" class="form-control" id="actual-monto" disabled>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nuevo Monto</label>
                                            <input type="number" class="form-control" id="nuevo-monto" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Justificación</label>
                                        <textarea class="form-control" rows="2" required></textarea>
                                    </div>
                            </div>
        
                            <!-- Contenido para Ampliación de Vigencia -->
                            <div id="contenido-vigencia" class="gestion-contenido" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Vigencia Actual</label>
                                            <input type="date" class="form-control" id="actual-vigencia" disabled>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nueva Vigencia</label>
                                            <input type="date" class="form-control" id="nueva-vigencia" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Razón de la Ampliación</label>
                                        <textarea class="form-control" rows="2" required></textarea>
                                    </div>
                            </div>
        
                             <!-- Contenido para Ampliación de Plazo -->
                            <div id="contenido-plazo" class="gestion-contenido" style="display:none;">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Plazo Actual (meses)</label>
                                            <input type="number" class="form-control" id="actual-plazo" disabled>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Nuevo Plazo</label>
                                            <input type="number" class="form-control" id="nuevo-plazo" required>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Explicación del Cambio</label>
                                        <textarea class="form-control" rows="2" required></textarea>
                                    </div>
                            </div>
                        <!-- Sección común para todas las gestiones -->
                        <div class="mt-4">
                            <label class="form-label">Comentarios</label>
                            <textarea class="form-control" rows="3" 
                                    placeholder="Justificación de la modificación" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarGestion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Historial -->
    <div class="modal fade" id="historialModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Historial del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-tipo="ventas">Ventas</button>
                            <button type="button" class="btn btn-outline-primary" data-tipo="visitas">Visitas</button>
                            <button type="button" class="btn btn-outline-primary" data-tipo="desembolsos">Desembolsos</button>
                        </div>
                        <button id="btn-export-pdf" class="btn btn-success float-end">
                            <i class="fas fa-file-pdf me-2"></i>Exportar a PDF
                        </button>
                    </div>
                    
                    <div id="contenido-ventas" class="historial-contenido">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabla-ventas">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N°</th>
                                        <th>Fecha Carga</th>
                                        <th>Usuario</th>
                                        <th>Inicio Ventas</th>
                                        <th>Inmuebles Vendidos</th>
                                        <th>% Ventas (Unidades)</th>
                                        <th>Valor Vendido</th>
                                        <th>Cartera Recaudada</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="contenido-visitas" class="historial-contenido" style="display:none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabla-visitas">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N°</th>
                                        <th>Fecha Visita</th>
                                        <th>Usuario</th>
                                        <th>N° Visita</th>
                                        <th>Avance Obra</th>
                                        <th>% Ejecución</th>
                                        <th>Estado Obra</th>
                                        <th>Alertas</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="contenido-desembolsos" class="historial-contenido" style="display:none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabla-desembolsos">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N°</th>
                                        <th>Fecha</th>
                                        <th>Usuario</th>
                                        <th>Valor Entregado</th>
                                        <th>Valor por Entregar</th>
                                        <th>Cobertura</th>
                                        <th>Superávit</th>
                                        <th>Requiere Visto Bueno</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer Estándar Bancolombia -->
     <!-- Footer -->
     <div class="footer">
        <div class="container-aligned">
            <p>© 2025 Bancolombia. Todos los derechos reservados.</p>
            <p>
                <a href="#">Términos y condiciones</a> | 
                <a href="#">Política de privacidad</a> | 
                <a href="#">Ayuda</a>
            </p>
            <p>
                <i class="fas fa-phone"></i> Línea de atención: 01 8000 912 345 | 
                <i class="fas fa-map-marker-alt"></i> Sede principal: Medellín, Colombia
            </p>
        </div>
    </div>
</body>
</html>