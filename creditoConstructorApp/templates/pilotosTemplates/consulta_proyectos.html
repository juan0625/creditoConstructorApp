<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bancolombia - Consulta de Proyectos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* ===== Colores principales (grises equivalentes) ===== */
            --bancolombia-blue: #2C2A29;
            --bancolombia-light-blue: #5A5A5A;
            --bancolombia-green: #707070;
            --bancolombia-yellow: #D9D9D9;

            /* ===== Neutrales ===== */
            --bancolombia-gray: #F5F5F5;
            --bancolombia-dark-gray: #1E1E1E;
            --text-secondary: #5A5A5A;
            --border-light: #E0E0E0;
            --pure-white: #FFFFFF;
        }

        body {
            font-family: "Cambria", serif;
            font-size: 18px;
            background-color: var(--bancolombia-gray);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* 1. Botón Primario (Azul original → Gris oscuro) */
        .btn-primary {
            background-color: var(--bancolombia-blue);
            color: var(--pure-white);
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary:hover {
            background-color: #1E1E1E;
            /* 10% más oscuro al hover */
        }

        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            margin-bottom: 20px;
        }


        .logo-container img {
            height: 50px;
        }

        .consultar-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
            margin-bottom: 30px;
            /* Nuevas propiedades añadidas */
            position: relative;
            overflow: visible;
            z-index: 1;
        }

        .section-title {
            color: var(--bancolombia-blue);
            border-bottom: 2px solid var(--bancolombia-light-blue);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .btn-bancolombia {
            background-color: var(--bancolombia-blue);
            color: white;
        }

        .btn-bancolombia:hover {
            background-color: var(--bancolombia-light-blue);
            color: white;
        }

        .filtro-card {
            border-left: 4px solid var(--bancolombia-light-blue);
            margin-bottom: 20px;
        }

        .resultados-table {
            margin-top: 30px;
        }

        .resultados-table table {
            font-size: 0.85rem;
            /* Reduce solo el tamaño de letra */
        }

        .resultados-table th {
            background-color: var(--bancolombia-blue);
            color: white;
        }

        .resultados-table td {
            white-space: nowrap;
            /* Evita saltos de línea */
            padding: 8px 12px;
            /* Padding más compacto */
        }

        .table-responsive {
            overflow-y: visible !important;
            max-height: none !important;
        }

        .footer {
            background-color: var(--bancolombia-blue);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 40px;
        }

        .footer a {
            color: var(--bancolombia-yellow);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .user-info {
            text-align: right;
            padding: 10px 20px;
            background-color: var(--bancolombia-gray);
            color: var(--bancolombia-dark-gray);
            font-size: 0.9rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Ajustes para mejor alineación */
        .container-aligned {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }

        .breadcrumb-item.active {
            color: var(--bancolombia-blue);
            font-weight: 600;
        }

        /* Efecto hover para el logo */
        .logo-container img:hover {
            transform: scale(1.05);
        }

        .logo-container {
            text-align: center;
            padding: 10px 0;
            margin: 0 auto;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .participante-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f8f9fa;
        }

        .acciones-container {
            position: relative;
            display: flex;
            gap: 5px;
        }

        .btn-accion {
            padding: 5px 10px;
            border-radius: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.85rem;
        }

        .btn-accion-primary {
            background-color: var(--bancolombia-blue);
            color: white;
            border: 1px solid var(--bancolombia-blue);
        }

        .btn-accion-primary:hover {
            background-color: var(--bancolombia-light-blue);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 72, 132, 0.2);
        }

        .btn-accion-secondary {
            background-color: var(--bancolombia-gray);
            color: var(--bancolombia-dark-gray);
            border: 1px solid #ccc;
        }

        .btn-accion-secondary:hover {
            background-color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .acciones-extendidas {
            position: absolute;
            right: 0;
            bottom: 100%;
            /* Cambiamos top por bottom */
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 1000;
            min-width: 280px;
            max-height: 400px;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 8px;
            /* Espacio entre botón y menú */
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
            /* Nueva animación */
        }

        /* Animación para aparecer hacia arriba */
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Clase adicional para cuando hay espacio abajo */
        .menu-abajo {
            top: 100%;
            bottom: auto;
            animation: slideDown 0.3s ease-out;
        }

        .acciones-container:hover .acciones-extendidas {
            display: flex;
        }

        .btn-accion-extendida {
            width: 100%;
            justify-content: start;
            text-align: left;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .acciones-container:hover .acciones-extendidas {
            display: flex;
            flex-wrap: nowrap;
            overflow: visible;
        }

        /* Ajustes para mejor visibilidad */
        .btn-accion-extendida:hover {
            transform: none;
            background-color: #f8f9fa;
            box-shadow: none;
        }

        .btn-accion-extendida i {
            min-width: 20px;
            margin-right: 10px;
        }

        .historial-contenido {
            max-height: 500px;
            overflow-y: auto;
        }

        #btn-export-pdf {
            margin-left: 10px;
        }

        /* ESTILOS CORREGIDOS PARA EL MODAL */
        .modal-content {
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, var(--bancolombia-blue), var(--bancolombia-light-blue));
            color: white;
            border-radius: 8px 8px 0 0;
            padding: 15px 20px;
        }

        .modal-title {
            font-weight: 600;
            font-size: 1.3rem;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            border-top: 1px solid var(--border-light);
            padding: 15px 20px;
        }

        .values-section {
            background-color: var(--bancolombia-gray);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--bancolombia-blue);
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
        }

        .summary-table th {
            background-color: var(--bancolombia-blue);
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .summary-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-light);
        }

        .summary-table tr:nth-child(even) {
            background-color: var(--pure-white);
        }

        .value-highlight {
            font-weight: 600;
        }

        .positive-value {
            color: #28a745;
        }

        .negative-value {
            color: #dc3545;
        }

        .coverage-percentage {
            font-weight: 700;
            color: #e67e22;
        }

        .filters-info {
            background-color: var(--bancolombia-yellow);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .info-label {
            font-weight: 600;
            color: var(--bancolombia-blue);
        }

        .project-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--bancolombia-blue);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--bancolombia-yellow);
        }

        #modalDesembolsos .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Pasar el rol del usuario desde el servidor
        const USUARIO_ROL = '{{ session.usuario.rol }}';
    </script>
    <link rel="shortcut icon" href="{{ url_for('static', filename='LogoBancolombia.ico') }}">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>

<body>
    <!-- Header con logo y usuario -->
    <div class="header">
        <div class="container-aligned">
            <div class="user-info">
                <span class="role-badge me-3">{{ session.usuario.rol | title }}</span>
                <i class="fas fa-user-circle"></i> {{ session.usuario.nombre }}
                | <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
            </div>
            <div class="logo-container">
                <img src="https://www.uam.edu.co/wp-content/uploads/2022/09/logo-bancolombia1.png" alt="Bancolombia">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('menu_principal') }}"><i
                                    class="fas fa-home"></i> Menú Principal</a></li>
                        <li class="breadcrumb-item active" aria-current="page"><i class="fas fa-user-tie"></i> Módulo
                            Pilotos</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <!-- Contenido principal -->
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3"><i class="fas fa-search me-2"></i> Consulta de Proyectos</h1>
            <a href="{{ url_for('modulo_pilotos') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver
            </a>
        </div>

        <!-- Card de Filtros -->
        <div class="consultar-container">
            <h2 class="section-title"><i class="fas fa-filter me-2"></i>Filtros de Búsqueda</h2>

            <form id="form-consulta">
                <div class="row">
                    <!-- Filtro 1: Datos Generales -->
                    <div class="col-md-6">
                        <div class="card filtro-card">
                            <div class="card-body">
                                <h5 class="card-title text-bancolombia">Datos Generales</h5>
                                <div class="mb-3">
                                    <label class="form-label">ID Proyecto</label>
                                    <input type="text" class="form-control" name="id_proyecto" id="id_proyecto">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nombre Proyecto</label>
                                    <input type="text" class="form-control" name="proyecto">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Titular</label>
                                    <input type="text" class="form-control" name="titular">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">NIT</label>
                                    <input type="text" class="form-control" name="nit">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filtro 2: Usuarios -->
                    <div class="col-md-6">
                        <div class="card filtro-card">
                            <div class="card-body">
                                <h5 class="card-title text-bancolombia">Usuarios</h5>
                                <div class="mb-3">
                                    <label class="form-label">Arquitecto</label>
                                    <select class="form-select" name="arquitecto">
                                        <option value="">Todos</option>
                                        <option value="ANA MARIA MONTOYA OROZCO">ANA MARIA MONTOYA OROZCO</option>
                                        <option value="JUAN CARLOS VASQUEZ CORREA">JUAN CARLOS VASQUEZ CORREA</option>
                                        <option value="MANUELA ESCOBAR GAVIRIA">MANUELA ESCOBAR GAVIRIA</option>
                                        <option value="MARIA DANIELA GOMEZ MURCIA">MARIA DANIELA GOMEZ MURCIA</option>
                                        <option value="MAURICIO ANDRES LOPEZ PINEDA">MAURICIO ANDRES LOPEZ PINEDA
                                        </option>
                                        <option value="NATALIA RODRIGUEZ CASTILLO">NATALIA RODRIGUEZ CASTILLO</option>
                                        <option value="PEDRO ANDRES DELGADILLO ROBAYO">PEDRO ANDRES DELGADILLO ROBAYO
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Perito</label>
                                    <select class="form-select" name="perito">
                                        <option value="">Todos</option>
                                        <option value="ÁLVARO GARCIA RONDEROS">ÁLVARO GARCIA RONDEROS</option>
                                        <option value="ANDRES HIDALGO">ANDRES HIDALGO</option>
                                        <option value="ARMANDO JOSE RODRIGUEZ PAVA">ARMANDO JOSE RODRIGUEZ PAVA</option>
                                        <option value="BEATRIZ BARRIOS ARRAZOLA">BEATRIZ BARRIOS ARRAZOLA</option>
                                        <option value="BEATRIZ SAN CLEMENTE">BEATRIZ SAN CLEMENTE</option>
                                        <option value="CARLOS EDUARDO RODRIGUEZ">CARLOS EDUARDO RODRIGUEZ</option>
                                        <option value="CARMEN CECILIA REYES">CARMEN CECILIA REYES</option>
                                        <option value="DARIO GONZALEZ VALENCIA">DARIO GONZALEZ VALENCIA</option>
                                        <option value="DIEGO ECHEVERRI">DIEGO ECHEVERRI</option>
                                        <option value="EDGAR GAMBOA">EDGAR GAMBOA</option>
                                        <option value="ENRIQUE TATIS PEREZ">ENRIQUE TATIS PEREZ</option>
                                        <option value="GABRIEL MUÑOZ">GABRIEL MUÑOZ</option>
                                        <option value="GERARDO RIVERA">GERARDO RIVERA</option>
                                        <option value="GLORIA ELENA DUQUE">GLORIA ELENA DUQUE</option>
                                        <option value="GUIDO JACOME">GUIDO JACOME</option>
                                        <option value="HÉCTOR ARTURO CASTILLO MEDINA">HÉCTOR ARTURO CASTILLO MEDINA
                                        </option>
                                        <option value="HERNANDO MEJIA DUQUE">HERNANDO MEJIA DUQUE</option>
                                        <option value="HERNANDO PÁEZ">HERNANDO PÁEZ</option>
                                        <option value="HILDA MARIA SÁENZ">HILDA MARIA SÁENZ</option>
                                        <option value="HUGO F KERGUELEM G">HUGO F KERGUELEM G</option>
                                        <option value="JAIME CARDENAS">JAIME CARDENAS</option>
                                        <option value="JORGE GOMEZ PAVAJEAU">JORGE GOMEZ PAVAJEAU</option>
                                        <option value="JOSE GUSTAVO SILVA PEREZ">JOSE GUSTAVO SILVA PEREZ</option>
                                        <option value="JOSE RICARDO CASTAÑO">JOSE RICARDO CASTAÑO</option>
                                        <option value="JUAN BERNARDO VELASQUEZ PORTILLO">JUAN BERNARDO VELASQUEZ
                                            PORTILLO</option>
                                        <option value="JUAN MANUEL DIEZ RUSCHER">JUAN MANUEL DIEZ RUSCHER</option>
                                        <option value="JUAN PABÓN HERNÁNDEZ">JUAN PABÓN HERNÁNDEZ</option>
                                        <option value="LUIS FERNANDO VELEZ">LUIS FERNANDO VELEZ</option>
                                        <option value="MARGARITA POLANCO">MARGARITA POLANCO</option>
                                        <option value="MARIA MARGARITA CABELLO">MARIA MARGARITA CABELLO</option>
                                        <option value="MAURICIO URICOECHEA">MAURICIO URICOECHEA</option>
                                        <option value="MAURICIO WAKED MACHADO">MAURICIO WAKED MACHADO</option>
                                        <option value="MIGUEL RAFAEL MENDEZ">MIGUEL RAFAEL MENDEZ</option>
                                        <option value="MÓNICA I SAAVEDRA MAC AUSLAND">MÓNICA I SAAVEDRA MAC AUSLAND
                                        </option>
                                        <option value="OCTAVIO VASQUEZ BERMÚDEZ">OCTAVIO VASQUEZ BERMÚDEZ</option>
                                        <option value="ORLANDO HERNANDEZ LEAL">ORLANDO HERNANDEZ LEAL</option>
                                        <option value="PIEDAD INES BURGOS BURGOS">PIEDAD INES BURGOS BURGOS</option>
                                        <option value="PREVEO - MARIA MARCELA CLAVIJO Y MIGUEL ANGEL NEITA">PREVEO -
                                            MARIA MARCELA CLAVIJO Y MIGUEL ANGEL NEITA</option>
                                        <option value="ROLANDO MEJIA">ROLANDO MEJIA</option>
                                        <option value="RUBÉN DARIO CARRILLO">RUBÉN DARIO CARRILLO</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Gerente</label>
                                    <select class="form-select" name="gerente">
                                        <option value="">Todos</option>
                                        <option value="ADELA YANNETH MEDINA">ADELA YANNETH MEDINA</option>
                                        <option value="ALBERTO ENRIQUE PINZON">ALBERTO ENRIQUE PINZON</option>
                                        <option value="ALEJANDRA GALEANO CASTAÑEDA">ALEJANDRA GALEANO CASTAÑEDA</option>
                                        <option value="ALEJANDRA PATRICIA ORTIZ GUTIERREZ">ALEJANDRA PATRICIA ORTIZ
                                            GUTIERREZ</option>
                                        <option value="ANDREA DEL PILAR HERNANDEZ SALAZAR">ANDREA DEL PILAR HERNANDEZ
                                            SALAZAR</option>
                                        <option value="ANDREA PAOLA CASTILLO MONGUI">ANDREA PAOLA CASTILLO MONGUI
                                        </option>
                                        <option value="ANDRES FELIPE BELTRAN RUEDA">ANDRES FELIPE BELTRAN RUEDA</option>
                                        <option value="ANGIE ALEXANDRA JEREZ QUIROGA">ANGIE ALEXANDRA JEREZ QUIROGA
                                        </option>
                                        <option value="ANGIE BOLENA LOPEZ SOTO">ANGIE BOLENA LOPEZ SOTO</option>
                                        <option value="ARGENIS DEL ROCIO GUTIERREZ">ARGENIS DEL ROCIO GUTIERREZ</option>
                                        <option value="ASTRID BIBIANA HERRERA URIBE">ASTRID BIBIANA HERRERA URIBE
                                        </option>
                                        <option value="ASTRID ELENA PEÑA MARRIAGA">ASTRID ELENA PEÑA MARRIAGA</option>
                                        <option value="ASTRID SOFIA CORREA SEPULVEDA">ASTRID SOFIA CORREA SEPULVEDA
                                        </option>
                                        <option value="BLEIDY YOHANA TORRADO SANGUINO CHONA">BLEIDY YOHANA TORRADO
                                            SANGUINO CHONA</option>
                                        <option value="CARLOS ARTURO LONDOÑO MONTALVO">CARLOS ARTURO LONDOÑO MONTALVO
                                        </option>
                                        <option value="CARLOS AUGUSTO ZORRO CALDERON">CARLOS AUGUSTO ZORRO CALDERON
                                        </option>
                                        <option value="CARLOS FERNANDO DAZA GUERRERO">CARLOS FERNANDO DAZA GUERRERO
                                        </option>
                                        <option value="CATALINA GUTIERREZ VELILLA">CATALINA GUTIERREZ VELILLA</option>
                                        <option value="CATHERINE MATIZ ESPINOSA">CATHERINE MATIZ ESPINOSA</option>
                                        <option value="CINDY ESTEPHANIA GIGLIOLI GIRALDO">CINDY ESTEPHANIA GIGLIOLI
                                            GIRALDO</option>
                                        <option value="DANIEL MAURICIO HERNANDEZ PAREDES">DANIEL MAURICIO HERNANDEZ
                                            PAREDES</option>
                                        <option value="DANIELA FIGUEROA LONDOÑO">DANIELA FIGUEROA LONDOÑO</option>
                                        <option value="DAVID SEBASTIAN CASTAÑO GIRALDO">DAVID SEBASTIAN CASTAÑO GIRALDO
                                        </option>
                                        <option value="DIANA MILENA CRUZ ORTEGA">DIANA MILENA CRUZ ORTEGA</option>
                                        <option value="DIANA MILENA GIL ARIAS">DIANA MILENA GIL ARIAS</option>
                                        <option value="EDGAR FERNEY ÑUSTES ALMANZA">EDGAR FERNEY ÑUSTES ALMANZA</option>
                                        <option value="EDIT YOHANA CARMONA FORONDA">EDIT YOHANA CARMONA FORONDA</option>
                                        <option value="ELIANA SOFIA CORENA GONZALEZ">ELIANA SOFIA CORENA GONZALEZ
                                        </option>
                                        <option value="ELIZABETH MEDINA QUINTERO">ELIZABETH MEDINA QUINTERO</option>
                                        <option value="FABIAN ANDRES MEJIA PULGARIN">FABIAN ANDRES MEJIA PULGARIN
                                        </option>
                                        <option value="FERNANDO ROBAYO LOPEZ">FERNANDO ROBAYO LOPEZ</option>
                                        <option value="GLORIA ANGELICA LUNA NIÑO">GLORIA ANGELICA LUNA NIÑO</option>
                                        <option value="GLORIA ELIZABETH LASSO MORENO">GLORIA ELIZABETH LASSO MORENO
                                        </option>
                                        <option value="HERMES RICARDO RINCON PONCE">HERMES RICARDO RINCON PONCE</option>
                                        <option value="INGRID EDITH FRANCO SOLER">INGRID EDITH FRANCO SOLER</option>
                                        <option value="INGRID JOHANNA ARISTIZABAL">INGRID JOHANNA ARISTIZABAL</option>
                                        <option value="IRMA CONSTANZA PAEZ DIAZ">IRMA CONSTANZA PAEZ DIAZ</option>
                                        <option value="ISABEL CRISTINA CADAVID OROZCO">ISABEL CRISTINA CADAVID OROZCO
                                        </option>
                                        <option value="JACKELINE VARON MARTINEZ">JACKELINE VARON MARTINEZ</option>
                                        <option value="JADER ANTONIO VELASQUEZ AYALA">JADER ANTONIO VELASQUEZ AYALA
                                        </option>
                                        <option value="JAIR FELIPE ZORRILLA GUEVARA">JAIR FELIPE ZORRILLA GUEVARA
                                        </option>
                                        <option value="JEANNE CEBALLOS VILLA">JEANNE CEBALLOS VILLA</option>
                                        <option value="JEIMMY STEPHANY CORREA RAMIREZ">JEIMMY STEPHANY CORREA RAMIREZ
                                        </option>
                                        <option value="JOSE ERNESTO RIVERA RUEDA">JOSE ERNESTO RIVERA RUEDA</option>
                                        <option value="JOYCE SMITH CRUZ RODRIGUEZ">JOYCE SMITH CRUZ RODRIGUEZ</option>
                                        <option value="JUAN CAMILO NOREÑA OSORIO">JUAN CAMILO NOREÑA OSORIO</option>
                                        <option value="JUAN FERNANDO OROZCO MONTOYA">JUAN FERNANDO OROZCO MONTOYA
                                        </option>
                                        <option value="JUAN FERNANDO PEREZ VELASQUEZ">JUAN FERNANDO PEREZ VELASQUEZ
                                        </option>
                                        <option value="JULIANA PALOMARES ARANGO">JULIANA PALOMARES ARANGO</option>
                                        <option value="KAREN LILIANA WILCHES DE ANGELIS">KAREN LILIANA WILCHES DE
                                            ANGELIS</option>
                                        <option value="KAROL ANGELICA HERRERA RUIZ">KAROL ANGELICA HERRERA RUIZ</option>
                                        <option value="KELLY JOHANNA ROJAS TRUJILLO">KELLY JOHANNA ROJAS TRUJILLO
                                        </option>
                                        <option value="LAURA LUCIA FLOREZ YANEZ">LAURA LUCIA FLOREZ YANEZ</option>
                                        <option value="LAURA MARIA CORREA CALDERON">LAURA MARIA CORREA CALDERON</option>
                                        <option value="LENIN ANIBAL BUSTOS MENDEZ">LENIN ANIBAL BUSTOS MENDEZ</option>
                                        <option value="LILIA ROSA MOLINA LLERENA">LILIA ROSA MOLINA LLERENA</option>
                                        <option value="LINA MARIA CASTAÑO URIBE">LINA MARIA CASTAÑO URIBE</option>
                                        <option value="LINA MARIA TORO PALACIO">LINA MARIA TORO PALACIO</option>
                                        <option value="LORENA DEL MAR SANDOVAL POLANCO">LORENA DEL MAR SANDOVAL POLANCO
                                        </option>
                                        <option value="LUISA FERNANDA CASTAÑO BENITEZ">LUISA FERNANDA CASTAÑO BENITEZ
                                        </option>
                                        <option value="LUZ ADRIANA GRAJALES ALVAREZ">LUZ ADRIANA GRAJALES ALVAREZ
                                        </option>
                                        <option value="LUZ MERY QUINTERO CARDONA">LUZ MERY QUINTERO CARDONA</option>
                                        <option value="MARGARITA MARIA HORMAZA GALLEGO">MARGARITA MARIA HORMAZA GALLEGO
                                        </option>
                                        <option value="MARIA FERNANDA REYES MORENO">MARIA FERNANDA REYES MORENO</option>
                                        <option value="MARIA FRANCY SAAVEDRA PINZON">MARIA FRANCY SAAVEDRA PINZON
                                        </option>
                                        <option value="MARIA PAULINA SARMIENTO ECHEVERRI">MARIA PAULINA SARMIENTO
                                            ECHEVERRI</option>
                                        <option value="MILTON YESID CASTILLO PARRA">MILTON YESID CASTILLO PARRA</option>
                                        <option value="MONICA DEL CARMEN TAFUR ARIZA">MONICA DEL CARMEN TAFUR ARIZA
                                        </option>
                                        <option value="NANCY EYDY PINEDA CIFUENTES">NANCY EYDY PINEDA CIFUENTES</option>
                                        <option value="NANCY MIRELLA ROJAS ORTIZ">NANCY MIRELLA ROJAS ORTIZ</option>
                                        <option value="NELLY KARINA ARCHILA ARENAS">NELLY KARINA ARCHILA ARENAS</option>
                                        <option value="NIDYA ESPERANZA BURGOS GAYON">NIDYA ESPERANZA BURGOS GAYON
                                        </option>
                                        <option value="NILSON PEÑA BOTELLO">NILSON PEÑA BOTELLO</option>
                                        <option value="NORMA CONSTANZA GIL GARCIA">NORMA CONSTANZA GIL GARCIA</option>
                                        <option value="OLGA CECILIA GARCIA MUNERA">OLGA CECILIA GARCIA MUNERA</option>
                                        <option value="PAOLA ANDREA AMAYA MORENO">PAOLA ANDREA AMAYA MORENO</option>
                                        <option value="PAOLA ANDREA GALINDO LOZA">PAOLA ANDREA GALINDO LOZA</option>
                                        <option value="PAOLA ANDREA LOZADA GARCES">PAOLA ANDREA LOZADA GARCES</option>
                                        <option value="PATRICIA CIPACON AGUILLON">PATRICIA CIPACON AGUILLON</option>
                                        <option value="PAULA ANDREA GAVIRIA BASTIDAS">PAULA ANDREA GAVIRIA BASTIDAS
                                        </option>
                                        <option value="RAUL IGNACIO CASALLAS MELO">RAUL IGNACIO CASALLAS MELO</option>
                                        <option value="REINALDO SILVA">REINALDO SILVA</option>
                                        <option value="RUBEN DARIO URIBE MEJIA">RUBEN DARIO URIBE MEJIA</option>
                                        <option value="SANDRA MILENA MORENO ZAPATA">SANDRA MILENA MORENO ZAPATA</option>
                                        <option value="SANDRA PATRICIA LINARES MORENO">SANDRA PATRICIA LINARES MORENO
                                        </option>
                                        <option value="SANDRA PATRICIA ROMAN CASTAÑEDA">SANDRA PATRICIA ROMAN CASTAÑEDA
                                        </option>
                                        <option value="SANTIAGO ESCOBAR DELGADO">SANTIAGO ESCOBAR DELGADO</option>
                                        <option value="SEBASTIAN ARBELAEZ AGUDELO">SEBASTIAN ARBELAEZ AGUDELO</option>
                                        <option value="SEBASTIAN HURTADO ARBELAEZ">SEBASTIAN HURTADO ARBELAEZ</option>
                                        <option value="SILVIA JANETH MORA MONROY">SILVIA JANETH MORA MONROY</option>
                                        <option value="TATIANA COSTA OSSA">TATIANA COSTA OSSA</option>
                                        <option value="VACANTE">VACANTE</option>
                                        <option value="VICTOR FERNANDO REDONDO LANCHEROS">VICTOR FERNANDO REDONDO
                                            LANCHEROS</option>
                                        <option value="VICTOR HUGO CORREA MONTOYA">VICTOR HUGO CORREA MONTOYA</option>
                                        <option value="VICTOR MANUEL SALAZAR ARENAS">VICTOR MANUEL SALAZAR ARENAS
                                        </option>
                                        <option value="WILMAR DARIO PRADA PARRA">WILMAR DARIO PRADA PARRA</option>
                                        <option value="WILSON ARLEY CARO CASTAÑO">WILSON ARLEY CARO CASTAÑO</option>
                                        <option value="YAMILE DEL ROCIO GARCIA MELO">YAMILE DEL ROCIO GARCIA MELO
                                        </option>
                                        <option value="YERLY MARIA GUTIERREZ MUÑOZ">YERLY MARIA GUTIERREZ MUÑOZ</option>
                                        <option value="YOLANDA BELLO RODRIGUEZ">YOLANDA BELLO RODRIGUEZ</option>
                                        <option value="YOLIMA PACHON PACHON">YOLIMA PACHON PACHON</option>
                                        <option value="YUDI ASTRID MARTINEZ JIMENEZ">YUDI ASTRID MARTINEZ JIMENEZ
                                        </option>
                                        <option value="ZEILA HORTENCIA TAPIAS MURILLO">ZEILA HORTENCIA TAPIAS MURILLO
                                        </option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Constructor</label>
                                    <select class="form-select" name="grupoPrincipal">
                                        <option value="">Todos</option>
                                        <option value="A BOTERO Y CIA">A BOTERO Y CIA</option>
                                        <option value="A UNO PROMOTORES">A UNO PROMOTORES</option>
                                        <option value="A+C CONSTRUCTORA">A+C CONSTRUCTORA</option>
                                        <option value="A2 CONSTRUCTORA SAS">A2 CONSTRUCTORA SAS</option>
                                        <option value="A3 COUNSULTING">A3 COUNSULTING</option>
                                        <option value="AB INGENIERIA SAS">AB INGENIERIA SAS</option>
                                        <option value="ACIERTO INMOBILIARIO SA">ACIERTO INMOBILIARIO SA</option>
                                        <option value="ACRECER">ACRECER</option>
                                        <option value="ACTUAL COLOMBIA SAS">ACTUAL COLOMBIA SAS</option>
                                        <option value="AED CONSTRUCTORES SAS">AED CONSTRUCTORES SAS</option>
                                        <option value="AJP CONSTRUCTORA SAS">AJP CONSTRUCTORA SAS</option>
                                        <option value="AKILA SAS">AKILA SAS</option>
                                        <option value="AKORN">AKORN</option>
                                        <option value="ALAMMO DESARROLLADORA DE PROYECTOS SAS">ALAMMO DESARROLLADORA DE
                                            PROYECTOS SAS</option>
                                        <option value="ALCANTARA CONSTRUCTORA SAS">ALCANTARA CONSTRUCTORA SAS</option>
                                        <option value="AMARILO SAS">AMARILO SAS</option>
                                        <option value="AMBIENTTI CONSTRUCTORA INMOBILIARIA">AMBIENTTI CONSTRUCTORA
                                            INMOBILIARIA</option>
                                        <option value="ANDES DESARROLLADORA S.A.S.">ANDES DESARROLLADORA S.A.S.</option>
                                        <option value="AP INGENIERÍA LTDA">AP INGENIERÍA LTDA</option>
                                        <option value="ARANJUEZ CONSTRUCCIONES INMOBILIARIAS">ARANJUEZ CONSTRUCCIONES
                                            INMOBILIARIAS</option>
                                        <option value="ARCHI MULTIDISEÑOS Y CONSTRUCCIONES SAS">ARCHI MULTIDISEÑOS Y
                                            CONSTRUCCIONES SAS</option>
                                        <option value="ARCONSA">ARCONSA</option>
                                        <option value="AREA CUADRADA">AREA CUADRADA</option>
                                        <option value="AREA URBANA DISEÑO Y CONSTRUCCION SAS">AREA URBANA DISEÑO Y
                                            CONSTRUCCION SAS</option>
                                        <option value="ARIAS SERNA Y SARAVIA">ARIAS SERNA Y SARAVIA</option>
                                        <option value="ARKTEC CONSTRUCTORA SAS">ARKTEC CONSTRUCTORA SAS</option>
                                        <option value="ARQUIAMBIENTAL SAS">ARQUIAMBIENTAL SAS</option>
                                        <option value="ARQUITECTOS CONSTRUCTORES ASOCIADOS">ARQUITECTOS CONSTRUCTORES
                                            ASOCIADOS</option>
                                        <option value="ARQUITECTURA Y CONCRETO">ARQUITECTURA Y CONCRETO</option>
                                        <option value="ARQUIURBE LTDA">ARQUIURBE LTDA</option>
                                        <option value="ARTEFACTO">ARTEFACTO</option>
                                        <option value="ARVINCO">ARVINCO</option>
                                        <option value="ASUL SAS">ASUL SAS</option>
                                        <option value="ATLANTIS CONSTRUCTORA LTDA">ATLANTIS CONSTRUCTORA LTDA</option>
                                        <option value="AVA BUILDER SAS">AVA BUILDER SAS</option>
                                        <option value="AVENIDA COLOMBIA PEF">AVENIDA COLOMBIA PEF</option>
                                        <option value="BARREIRO GARCES">BARREIRO GARCES</option>
                                        <option value="BASA CONSTRUCCIONES SAS">BASA CONSTRUCCIONES SAS</option>
                                        <option value="BEMSA">BEMSA</option>
                                        <option value="BESCO COLOMBIA SAS">BESCO COLOMBIA SAS</option>
                                        <option value="BIENES Y BIENES SA">BIENES Y BIENES SA</option>
                                        <option value="BOHIOS URBANOS SAS">BOHIOS URBANOS SAS</option>
                                        <option value="BONILLA ZEA">BONILLA ZEA</option>
                                        <option value="BP CONSTRUCTORES S.A.S.">BP CONSTRUCTORES S.A.S.</option>
                                        <option value="BRAZZO CONSTRUCTORES">BRAZZO CONSTRUCTORES</option>
                                        <option value="BREK SAS">BREK SAS</option>
                                        <option value="BRICCON SAS">BRICCON SAS</option>
                                        <option value="C MAQUINARIA Y CONSTRUICCION SAS">C MAQUINARIA Y CONSTRUICCION
                                            SAS</option>
                                        <option value="C.A.S.A.">C.A.S.A.</option>
                                        <option value="CA VENTURES COLOMBIA S.A.S.">CA VENTURES COLOMBIA S.A.S.</option>
                                        <option value="CADINCO">CADINCO</option>
                                        <option value="CAJA DE COMPENSACION FAMILIAR COMFENALCO ANTIOQUIA">CAJA DE
                                            COMPENSACION FAMILIAR COMFENALCO ANTIOQUIA</option>
                                        <option value="CANALES DESARROLLADORES S.A.S">CANALES DESARROLLADORES S.A.S
                                        </option>
                                        <option value="CANO H INGENIERIA S.A.S">CANO H INGENIERIA S.A.S</option>
                                        <option value="CASACTIVA">CASACTIVA</option>
                                        <option value="CENTRO SUR SA">CENTRO SUR SA</option>
                                        <option value="CG CONSTRUCTORA S.A.S">CG CONSTRUCTORA S.A.S</option>
                                        <option value="CGR INGENIERIA Y GERENCIA DE PROYECTOS SAS">CGR INGENIERIA Y
                                            GERENCIA DE PROYECTOS SAS</option>
                                        <option value="CH ARQUITECTOS S.A.S">CH ARQUITECTOS S.A.S</option>
                                        <option value="CHACÓN CONSTRUCCIONES SAS">CHACÓN CONSTRUCCIONES SAS</option>
                                        <option value="CINCO URBANA SAS">CINCO URBANA SAS</option>
                                        <option value="CIRO CHIPATECUA">CIRO CHIPATECUA</option>
                                        <option value="CNV CONSTRUCCIONES SAS">CNV CONSTRUCCIONES SAS</option>
                                        <option value="COALA ARQUITECTURA Y CONSTRUCCION">COALA ARQUITECTURA Y
                                            CONSTRUCCION</option>
                                        <option value="COHALA CONSTRUCCIONES S.A.S.">COHALA CONSTRUCCIONES S.A.S.
                                        </option>
                                        <option value="COINGSA S.A.S">COINGSA S.A.S</option>
                                        <option value="COLOMBIANA DE CONSTRUCCIONES SAS">COLOMBIANA DE CONSTRUCCIONES
                                            SAS</option>
                                        <option value="CONACIERTO INGENIERIA ARQUITECTURA S.A.S.">CONACIERTO INGENIERIA
                                            ARQUITECTURA S.A.S.</option>
                                        <option value="CONALTURA S.A.">CONALTURA S.A.</option>
                                        <option value="CONASEL INGENIERIA S.A.S.">CONASEL INGENIERIA S.A.S.</option>
                                        <option value="CONENCO">CONENCO</option>
                                        <option value="CONEXO INMOBILIARIO SAS">CONEXO INMOBILIARIO SAS</option>
                                        <option value="CONHOGAR S.A.S.">CONHOGAR S.A.S.</option>
                                        <option value="CONINSA SAS">CONINSA SAS</option>
                                        <option value="CONINTEL S.A.">CONINTEL S.A.</option>
                                        <option value="CONSORCIO MORAS">CONSORCIO MORAS</option>
                                        <option value="CONSORCIO MORENO TAFURT">CONSORCIO MORENO TAFURT</option>
                                        <option value="CONSTRUCCION URBANA S.A.S">CONSTRUCCION URBANA S.A.S</option>
                                        <option value="CONSTRUCCIONES BUEN VIVIR S.A.">CONSTRUCCIONES BUEN VIVIR S.A.
                                        </option>
                                        <option value="CONSTRUCCIONES CARAN S.A.S">CONSTRUCCIONES CARAN S.A.S</option>
                                        <option value="CONSTRUCCIONES CFC Y ASOCIADOS">CONSTRUCCIONES CFC Y ASOCIADOS
                                        </option>
                                        <option value="CONSTRUCCIONES MACRO S.A.S">CONSTRUCCIONES MACRO S.A.S</option>
                                        <option value="CONSTRUCCIONES PALACIOS">CONSTRUCCIONES PALACIOS</option>
                                        <option value="CONSTRUCCIONES RCG">CONSTRUCCIONES RCG</option>
                                        <option value="CONSTRUCCIONES RIVAS MORA SAS">CONSTRUCCIONES RIVAS MORA SAS
                                        </option>
                                        <option value="CONSTRUCCIONES URBANAS S.A.S.">CONSTRUCCIONES URBANAS S.A.S.
                                        </option>
                                        <option value="CONSTRUCCIONES Y URBANIZACIONES SAS">CONSTRUCCIONES Y
                                            URBANIZACIONES SAS</option>
                                        <option value="CONSTRUCTORA 1A S.A.S">CONSTRUCTORA 1A S.A.S</option>
                                        <option value="CONSTRUCTORA ALHAMBRA - FORJAR">CONSTRUCTORA ALHAMBRA - FORJAR
                                        </option>
                                        <option value="CONSTRUCTORA ALPES S.A">CONSTRUCTORA ALPES S.A</option>
                                        <option value="CONSTRUCTORA ARQUIMEG">CONSTRUCTORA ARQUIMEG</option>
                                        <option value="CONSTRUCTORA ASCENSO">CONSTRUCTORA ASCENSO</option>
                                        <option value="CONSTRUCTORA BALCONES S.A.S">CONSTRUCTORA BALCONES S.A.S</option>
                                        <option value="CONSTRUCTORA BOLIVAR CALI S.A.">CONSTRUCTORA BOLIVAR CALI S.A.
                                        </option>
                                        <option value="CONSTRUCTORA BOLIVAR S.A.">CONSTRUCTORA BOLIVAR S.A.</option>
                                        <option value="CONSTRUCTORA CANALKI S.A.S">CONSTRUCTORA CANALKI S.A.S</option>
                                        <option value="CONSTRUCTORA CAPITAL BOGOTA">CONSTRUCTORA CAPITAL BOGOTA</option>
                                        <option value="CONSTRUCTORA CAPITAL MEDELLÍN">CONSTRUCTORA CAPITAL MEDELLÍN
                                        </option>
                                        <option value="CONSTRUCTORA CARVAJAL Y RIVERA SAS">CONSTRUCTORA CARVAJAL Y
                                            RIVERA SAS</option>
                                        <option value="CONSTRUCTORA COLPATRIA S.A.">CONSTRUCTORA COLPATRIA S.A.</option>
                                        <option value="CONSTRUCTORA CONCONCRETO">CONSTRUCTORA CONCONCRETO</option>
                                        <option value="CONSTRUCTORA CONCRETAR S.A.S.">CONSTRUCTORA CONCRETAR S.A.S.
                                        </option>
                                        <option value="CONSTRUCTORA CONFUTURO">CONSTRUCTORA CONFUTURO</option>
                                        <option value="CONSTRUCTORA CONTEX SAS">CONSTRUCTORA CONTEX SAS</option>
                                        <option value="CONSTRUCTORA COSENZA">CONSTRUCTORA COSENZA</option>
                                        <option value="CONSTRUCTORA COVIN S.A.">CONSTRUCTORA COVIN S.A.</option>
                                        <option value="CONSTRUCTORA DARCO SAS">CONSTRUCTORA DARCO SAS</option>
                                        <option value="CONSTRUCTORA DEL TORO">CONSTRUCTORA DEL TORO</option>
                                        <option value="CONSTRUCTORA EL CASTILLO">CONSTRUCTORA EL CASTILLO</option>
                                        <option value="CONSTRUCTORA EL RUIZ">CONSTRUCTORA EL RUIZ</option>
                                        <option value="CONSTRUCTORA GARPRO SAS">CONSTRUCTORA GARPRO SAS</option>
                                        <option value="CONSTRUCTORA GARZON HOLGUIN GYH">CONSTRUCTORA GARZON HOLGUIN GYH
                                        </option>
                                        <option value="CONSTRUCTORA HABITAMOS SAS">CONSTRUCTORA HABITAMOS SAS</option>
                                        <option value="CONSTRUCTORA HABITAT DE LOS ANDES">CONSTRUCTORA HABITAT DE LOS
                                            ANDES</option>
                                        <option value="CONSTRUCTORA INLASA S.A.S">CONSTRUCTORA INLASA S.A.S</option>
                                        <option value="CONSTRUCTORA INMOBILAIRIA FRATELLI S.A.S.">CONSTRUCTORA
                                            INMOBILAIRIA FRATELLI S.A.S.</option>
                                        <option value="CONSTRUCTORA J Y P SAS">CONSTRUCTORA J Y P SAS</option>
                                        <option value="CONSTRUCTORA JIMENEZ S.A.">CONSTRUCTORA JIMENEZ S.A.</option>
                                        <option value="CONSTRUCTORA JK SALCEDO SAS">CONSTRUCTORA JK SALCEDO SAS</option>
                                        <option value="CONSTRUCTORA JR SAS">CONSTRUCTORA JR SAS</option>
                                        <option value="CONSTRUCTORA KOVOK S.A.S.">CONSTRUCTORA KOVOK S.A.S.</option>
                                        <option value="CONSTRUCTORA LA BUCARAMANGA SAS">CONSTRUCTORA LA BUCARAMANGA SAS
                                        </option>
                                        <option value="CONSTRUCTORA LARES">CONSTRUCTORA LARES</option>
                                        <option value="CONSTRUCTORA MADECONS SA">CONSTRUCTORA MADECONS SA</option>
                                        <option value="CONSTRUCTORA MARQUIS S.A.">CONSTRUCTORA MARQUIS S.A.</option>
                                        <option value="CONSTRUCTORA MATISSE S.A.S">CONSTRUCTORA MATISSE S.A.S</option>
                                        <option value="CONSTRUCTORA MELENDEZ S.A.">CONSTRUCTORA MELENDEZ S.A.</option>
                                        <option value="CONSTRUCTORA MMVR S.A.S">CONSTRUCTORA MMVR S.A.S</option>
                                        <option value="CONSTRUCTORA MONSERRATE">CONSTRUCTORA MONSERRATE</option>
                                        <option value="CONSTRUCTORA MURAGLIA S.A.">CONSTRUCTORA MURAGLIA S.A.</option>
                                        <option value="CONSTRUCTORA OPEN">CONSTRUCTORA OPEN</option>
                                        <option value="CONSTRUCTORA ORIGEN">CONSTRUCTORA ORIGEN</option>
                                        <option value="CONSTRUCTORA PLINCO S.A.">CONSTRUCTORA PLINCO S.A.</option>
                                        <option value="CONSTRUCTORA PRIMAR SA">CONSTRUCTORA PRIMAR SA</option>
                                        <option value="CONSTRUCTORA PROYECTOS URBANOS SAS">CONSTRUCTORA PROYECTOS
                                            URBANOS SAS</option>
                                        <option value="CONSTRUCTORA RIVER PARK SAS">CONSTRUCTORA RIVER PARK SAS</option>
                                        <option value="CONSTRUCTORA SOLANILLAS S.A">CONSTRUCTORA SOLANILLAS S.A</option>
                                        <option value="CONSTRUCTORA SOLIDER S.A.S.">CONSTRUCTORA SOLIDER S.A.S.</option>
                                        <option value="CONSTRUCTORA SUDAMERICANA">CONSTRUCTORA SUDAMERICANA</option>
                                        <option value="CONSTRUCTORA TEYPRO">CONSTRUCTORA TEYPRO</option>
                                        <option value="CONSTRUCTORA TORRES DE LA FRANCIA">CONSTRUCTORA TORRES DE LA
                                            FRANCIA</option>
                                        <option value="CONSTRUCTORA VIVIR BIEN">CONSTRUCTORA VIVIR BIEN</option>
                                        <option value="CONSTRUCTORA Y COMERCIALIZADORA CAMU">CONSTRUCTORA Y
                                            COMERCIALIZADORA CAMU</option>
                                        <option value="CONSTRUCTORA Y COMERCIALIZADORA POPORO">CONSTRUCTORA Y
                                            COMERCIALIZADORA POPORO</option>
                                        <option value="CONSTRUCTORA Y DESARROLLOS RENGIFO">CONSTRUCTORA Y DESARROLLOS
                                            RENGIFO</option>
                                        <option value="CONSTRUCTORA Y PROMOTORA EL PROGRESO">CONSTRUCTORA Y PROMOTORA EL
                                            PROGRESO</option>
                                        <option value="CONSTRUCTORA YADEL S.A.S.">CONSTRUCTORA YADEL S.A.S.</option>
                                        <option value="CONSTRUCTUM SAS">CONSTRUCTUM SAS</option>
                                        <option value="CONSTRUMAX">CONSTRUMAX</option>
                                        <option value="CONSTRUSERVICIOS BYH LTDA">CONSTRUSERVICIOS BYH LTDA</option>
                                        <option value="CONSTRUTEC">CONSTRUTEC</option>
                                        <option value="CONVEL SAS">CONVEL SAS</option>
                                        <option value="CORAL CONSTRUCTORES">CORAL CONSTRUCTORES</option>
                                        <option value="COTESAB S.A.S">COTESAB S.A.S</option>
                                        <option value="CREANDO ARQUITECTURA S.A.S.">CREANDO ARQUITECTURA S.A.S.</option>
                                        <option value="CREARCIMIENTOS PROPIEDAD RAIZ">CREARCIMIENTOS PROPIEDAD RAIZ
                                        </option>
                                        <option value="CUBYCO CONSTRUCTORES S.A.">CUBYCO CONSTRUCTORES S.A.</option>
                                        <option value="CVA CONTRUCTORA SAS">CVA CONTRUCTORA SAS</option>
                                        <option value="CYMADE">CYMADE</option>
                                        <option value="DEEB ASOCIADOS S.A.S">DEEB ASOCIADOS S.A.S</option>
                                        <option value="DEGA S.A.S.">DEGA S.A.S.</option>
                                        <option value="DESARROLLOS INMOBILIARIOS FUTURO SAS">DESARROLLOS INMOBILIARIOS
                                            FUTURO SAS</option>
                                        <option value="DIPROCON INGENIERIA">DIPROCON INGENIERIA</option>
                                        <option value="DISTEMACO S.A.S">DISTEMACO S.A.S</option>
                                        <option value="DIVERSIFICAR SA">DIVERSIFICAR SA</option>
                                        <option value="DM DISEÑO CONSTRUCCION SAS">DM DISEÑO CONSTRUCCION SAS</option>
                                        <option value="DOM REAL ESTATE">DOM REAL ESTATE</option>
                                        <option value="DUQUE RENGIFO">DUQUE RENGIFO</option>
                                        <option value="DYCO S.A.S.">DYCO S.A.S.</option>
                                        <option value="ECOINSA INGENIERIA S.A.S.">ECOINSA INGENIERIA S.A.S.</option>
                                        <option value="ECOSSUR S.A.S">ECOSSUR S.A.S</option>
                                        <option value="EDC CONSTRUCCIONES S.A.S">EDC CONSTRUCCIONES S.A.S</option>
                                        <option value="EDIFICADORA RIOVISTA S.A.S">EDIFICADORA RIOVISTA S.A.S</option>
                                        <option value="EDIFICALIA S.A.S">EDIFICALIA S.A.S</option>
                                        <option value="EL POMAR CONSTRUCCIONES SAS">EL POMAR CONSTRUCCIONES SAS</option>
                                        <option value="ENPROYECTOS S.A.S">ENPROYECTOS S.A.S</option>
                                        <option value="ESDIEZ CONSTRUCTORA S.A.S">ESDIEZ CONSTRUCTORA S.A.S</option>
                                        <option value="ESFÉRICA S.A.S">ESFÉRICA S.A.S</option>
                                        <option value="ESPACIO VITAL CONSTRUCTORES SA">ESPACIO VITAL CONSTRUCTORES SA
                                        </option>
                                        <option value="ESPECIALMENTE S.A.S.">ESPECIALMENTE S.A.S.</option>
                                        <option value="ESTRUCTURAR INGENIEROS SAS">ESTRUCTURAR INGENIEROS SAS</option>
                                        <option value="FAKTOR">FAKTOR</option>
                                        <option value="FCP AVENIDA COLOMBIA PEF II">FCP AVENIDA COLOMBIA PEF II</option>
                                        <option value="FCR SAS">FCR SAS</option>
                                        <option value="FENIX CONSTRUCCIONES S.A.">FENIX CONSTRUCCIONES S.A.</option>
                                        <option value="FIC">FIC</option>
                                        <option value="G4 INGENIEROS CIVILES S.A.S.">G4 INGENIEROS CIVILES S.A.S.
                                        </option>
                                        <option value="GERENCIA MÁS PROYECTOS S.A.S">GERENCIA MÁS PROYECTOS S.A.S
                                        </option>
                                        <option value="GESTION Y GERENCIA">GESTION Y GERENCIA</option>
                                        <option value="GIDACOL SAS">GIDACOL SAS</option>
                                        <option value="GONZALEZ PIZANO">GONZALEZ PIZANO</option>
                                        <option value="GRAMA">GRAMA</option>
                                        <option value="GRAN MORADA CONSTRUCCIONES">GRAN MORADA CONSTRUCCIONES</option>
                                        <option value="GRUPO ACCANTO">GRUPO ACCANTO</option>
                                        <option value="GRUPO AR">GRUPO AR</option>
                                        <option value="GRUPO BGR">GRUPO BGR</option>
                                        <option value="GRUPO CONSTRUCTOR CALIBIO">GRUPO CONSTRUCTOR CALIBIO</option>
                                        <option value="GRUPO CONSTRUCTOR COLOMBIANO GCC S.A.S">GRUPO CONSTRUCTOR
                                            COLOMBIANO GCC S.A.S</option>
                                        <option value="GRUPO EMPRESARIAL KINKU">GRUPO EMPRESARIAL KINKU</option>
                                        <option value="GRUPO GALEANO GEORGE">GRUPO GALEANO GEORGE</option>
                                        <option value="GRUPO GUASANDI (ANTES CDO)">GRUPO GUASANDI (ANTES CDO)</option>
                                        <option value="GRUPO INMOBILIARIO PAISAJE URBANO SAS">GRUPO INMOBILIARIO PAISAJE
                                            URBANO SAS</option>
                                        <option value="GRUPO INMOBILIARIO Y CONSTRUCTOR VALOR SA">GRUPO INMOBILIARIO Y
                                            CONSTRUCTOR VALOR SA</option>
                                        <option value="GRUPO LORCA">GRUPO LORCA</option>
                                        <option value="GRUPO OIKOS S.A.">GRUPO OIKOS S.A.</option>
                                        <option value="GRUPO QUARTO">GRUPO QUARTO</option>
                                        <option value="GRUPO SOLERIUM">GRUPO SOLERIUM</option>
                                        <option value="GRUPO VS LIMITADA">GRUPO VS LIMITADA</option>
                                        <option value="HABITUS CONSTRUCCIONES">HABITUS CONSTRUCCIONES</option>
                                        <option value="HAYUELOS DE COLOMBIA S.A.S">HAYUELOS DE COLOMBIA S.A.S</option>
                                        <option value="HITOS URBANOS S.A.S">HITOS URBANOS S.A.S</option>
                                        <option value="IARCO S.A.">IARCO S.A.</option>
                                        <option value="ICONO URBANO S.A.">ICONO URBANO S.A.</option>
                                        <option value="IKON CONSTRUCTORA">IKON CONSTRUCTORA</option>
                                        <option value="IMOVAL">IMOVAL</option>
                                        <option value="INACAR S.A">INACAR S.A</option>
                                        <option value="INDIVA DESIGN S.A.S.">INDIVA DESIGN S.A.S.</option>
                                        <option value="INGEARCO Y GRUPO CIUDADELA">INGEARCO Y GRUPO CIUDADELA</option>
                                        <option value="INGENAL S.A.">INGENAL S.A.</option>
                                        <option value="INGENIA CONSTRUCCIONES S.A.S">INGENIA CONSTRUCCIONES S.A.S
                                        </option>
                                        <option value="INGENIERÍA ARQUITECTURA Y MADERA S.A.S">INGENIERÍA ARQUITECTURA Y
                                            MADERA S.A.S</option>
                                        <option value="INGENIERIA INMOBILIARIA S.A.">INGENIERIA INMOBILIARIA S.A.
                                        </option>
                                        <option value="INGENIERIA Y HERRAMIENTAS S.A.S">INGENIERIA Y HERRAMIENTAS S.A.S
                                        </option>
                                        <option value="INGENIERIA Y VIVIENDA SAS">INGENIERIA Y VIVIENDA SAS</option>
                                        <option value="INGENOVA ING">INGENOVA ING</option>
                                        <option value="INGESAENZ SAS">INGESAENZ SAS</option>
                                        <option value="INMOBILIARIA DALI">INMOBILIARIA DALI</option>
                                        <option value="INMOBILIARIA PROACTIVA SA">INMOBILIARIA PROACTIVA SA</option>
                                        <option value="INMOVEL">INMOVEL</option>
                                        <option value="INSERCO">INSERCO</option>
                                        <option value="INTEGRA GERENCIA Y CONSTRUCCIONES SAS">INTEGRA GERENCIA Y
                                            CONSTRUCCIONES SAS</option>
                                        <option value="INTORNO">INTORNO</option>
                                        <option value="INUBERCO">INUBERCO</option>
                                        <option value="INVERSIONES HARI SAS">INVERSIONES HARI SAS</option>
                                        <option value="INVERSIONES HYH LTDA">INVERSIONES HYH LTDA</option>
                                        <option value="INVERSIONES LA CAROLINA S.A.S.">INVERSIONES LA CAROLINA S.A.S.
                                        </option>
                                        <option value="INVERSIONES LA PENINSULA LTDA">INVERSIONES LA PENINSULA LTDA
                                        </option>
                                        <option value="INVERSIONES NT3 S.A.S">INVERSIONES NT3 S.A.S</option>
                                        <option value="INVERSIONES PROMEXPORT S.A.S.">INVERSIONES PROMEXPORT S.A.S.
                                        </option>
                                        <option value="INVERSIONES RACUELLAR">INVERSIONES RACUELLAR</option>
                                        <option value="INVERSIONES RODAS - INVERSIONES MAGLA">INVERSIONES RODAS -
                                            INVERSIONES MAGLA</option>
                                        <option value="INVERSIONES TERRA S.A.">INVERSIONES TERRA S.A.</option>
                                        <option value="INVERSIONES TORRELAVEGA SAS">INVERSIONES TORRELAVEGA SAS</option>
                                        <option value="INVERSIONES VALLE DEL PACIFICO INVERFIN">INVERSIONES VALLE DEL
                                            PACIFICO INVERFIN</option>
                                        <option value="INVERSIONES Y CONSTRUCCIONES HC S.A.S.">INVERSIONES Y
                                            CONSTRUCCIONES HC S.A.S.</option>
                                        <option value="INVERSIONISTAS INMOBILIARIOS S.A.S">INVERSIONISTAS INMOBILIARIOS
                                            S.A.S</option>
                                        <option value="IPC INMOBILIARIO SAS">IPC INMOBILIARIO SAS</option>
                                        <option value="J. FELIPE ARDILA">J. FELIPE ARDILA</option>
                                        <option value="JAER GERENCIA DE PROYECTOS">JAER GERENCIA DE PROYECTOS</option>
                                        <option value="JARAMILLO ARQUITECTOS">JARAMILLO ARQUITECTOS</option>
                                        <option value="JARAMILLO MORA">JARAMILLO MORA</option>
                                        <option value="JS INGENERIA Y CONSTRUCCIONES SAS">JS INGENERIA Y CONSTRUCCIONES
                                            SAS</option>
                                        <option value="JULIO CESAR GUERRERO">JULIO CESAR GUERRERO</option>
                                        <option value="KREAR CONSTRUCTORES S.A.S">KREAR CONSTRUCTORES S.A.S</option>
                                        <option value="KROMO">KROMO</option>
                                        <option value="L&L CONSTRUCCIONES CON DISEÑO SAS">L&L CONSTRUCCIONES CON DISEÑO
                                            SAS</option>
                                        <option value="LAS CAMELIAS CONSTRUCCIONES SAS">LAS CAMELIAS CONSTRUCCIONES SAS
                                        </option>
                                        <option value="LEGF CONSTRUCTORA SAS">LEGF CONSTRUCTORA SAS</option>
                                        <option value="LEON AGUILERA S.A.">LEON AGUILERA S.A.</option>
                                        <option value="LG INVERSIONES - GRUPO DESARROLLADOR SABANA">LG INVERSIONES -
                                            GRUPO DESARROLLADOR SABANA</option>
                                        <option value="LINARES CONSTRUCCIONES (antes GERENCIAR)">LINARES CONSTRUCCIONES
                                            (antes GERENCIAR)</option>
                                        <option value="LONDOÑO GOMEZ">LONDOÑO GOMEZ</option>
                                        <option value="LOPEZ CUBILLOS CONSTRUCCIONES SAS">LOPEZ CUBILLOS CONSTRUCCIONES
                                            SAS</option>
                                        <option value="LUQUE OSPINA">LUQUE OSPINA</option>
                                        <option value="M+D CONSTRUCTORA">M+D CONSTRUCTORA</option>
                                        <option value="M+GROUP">M+GROUP</option>
                                        <option value="MAGATA CONSTRUCTORA SAS">MAGATA CONSTRUCTORA SAS</option>
                                        <option value="MANDAL CONSTRUCCIONES S.A.S.">MANDAL CONSTRUCCIONES S.A.S.
                                        </option>
                                        <option value="MARVAL SA">MARVAL SA</option>
                                        <option value="MAYA Y ASOCIADOS SAS">MAYA Y ASOCIADOS SAS</option>
                                        <option value="MEJIA VILLEGAS CONSTRUCTORES S.A.">MEJIA VILLEGAS CONSTRUCTORES
                                            S.A.</option>
                                        <option value="MENSULA S.A.">MENSULA S.A.</option>
                                        <option value="MEVIC">MEVIC</option>
                                        <option value="MG CONSTRUCCIONES Y EQUIPOS S.A.S.">MG CONSTRUCCIONES Y EQUIPOS
                                            S.A.S.</option>
                                        <option value="MGJ">MGJ</option>
                                        <option value="MIPKO CONSTRUCTORES S.A.S.">MIPKO CONSTRUCTORES S.A.S.</option>
                                        <option value="MORANDI CONSTRUCCIONES">MORANDI CONSTRUCCIONES</option>
                                        <option value="MOSEL S.A.S.">MOSEL S.A.S.</option>
                                        <option value="MOVEC SAS">MOVEC SAS</option>
                                        <option value="MUISCA CONSTRUCCIONES SAS">MUISCA CONSTRUCCIONES SAS</option>
                                        <option value="MULTICONSTRUCCIONES JP">MULTICONSTRUCCIONES JP</option>
                                        <option value="NODOS GERENCIA Y CONSTRUCCIÓN SAS">NODOS GERENCIA Y CONSTRUCCIÓN
                                            SAS</option>
                                        <option value="NT GROUP SAS">NT GROUP SAS</option>
                                        <option value="NUCLEO CONSTRUCTORA S.A.S.">NUCLEO CONSTRUCTORA S.A.S.</option>
                                        <option value="NUEVO HORIZONTE">NUEVO HORIZONTE</option>
                                        <option value="OBRAS CIVILES Y ACABADOS">OBRAS CIVILES Y ACABADOS</option>
                                        <option value="OBRAS Y MAQUINAS S.A.S">OBRAS Y MAQUINAS S.A.S</option>
                                        <option value="ODICCO LTDA">ODICCO LTDA</option>
                                        <option value="ONCE CONSTRUCTORA S.A.S.">ONCE CONSTRUCTORA S.A.S.</option>
                                        <option value="OPA CONSTRUCTORES S.A.">OPA CONSTRUCTORES S.A.</option>
                                        <option value="OPTIMA S.A.">OPTIMA S.A.</option>
                                        <option value="OPTIMO INVERSIONES S.A.S.">OPTIMO INVERSIONES S.A.S.</option>
                                        <option value="ORGANIZACION CENTENARIO">ORGANIZACION CENTENARIO</option>
                                        <option value="ORGANIZACION EDYFICA SA">ORGANIZACION EDYFICA SA</option>
                                        <option value="ORMECO">ORMECO</option>
                                        <option value="P&P CONSTRUCTORA S.A.S">P&P CONSTRUCTORA S.A.S</option>
                                        <option value="PACTAR DESARROLLADOR INMOBILIARIO S.A.S.">PACTAR DESARROLLADOR
                                            INMOBILIARIO S.A.S.</option>
                                        <option value="PADILLA MORENO">PADILLA MORENO</option>
                                        <option value="PALACIO OFICINA DE CONSTRUCCIONES S.A">PALACIO OFICINA DE
                                            CONSTRUCCIONES S.A</option>
                                        <option value="PCA SOLUCIONES ARQUITECTONICAS SAS">PCA SOLUCIONES
                                            ARQUITECTONICAS SAS</option>
                                        <option value="PEDRO GOMEZ Y CIA">PEDRO GOMEZ Y CIA</option>
                                        <option value="PETRUS LURA S.A.S">PETRUS LURA S.A.S</option>
                                        <option value="PLANEACIÓN Y EDIFICACIÓN S.A.S.">PLANEACIÓN Y EDIFICACIÓN S.A.S.
                                        </option>
                                        <option value="PLATAFORMA CONSTRUCTORES SAS">PLATAFORMA CONSTRUCTORES SAS
                                        </option>
                                        <option value="POTENCO S.A.S">POTENCO S.A.S</option>
                                        <option value="PPM INVERSIONES S.A.">PPM INVERSIONES S.A.</option>
                                        <option value="PRANHA S.A">PRANHA S.A</option>
                                        <option value="PROACTIV SAS">PROACTIV SAS</option>
                                        <option value="PRODEGI S.A.S.">PRODEGI S.A.S.</option>
                                        <option value="PRODESA">PRODESA</option>
                                        <option value="PROGRESSIVE HORIZON">PROGRESSIVE HORIZON</option>
                                        <option value="PROHOGAR">PROHOGAR</option>
                                        <option value="PROIN">PROIN</option>
                                        <option value="PROINSA SAS">PROINSA SAS</option>
                                        <option value="PROJECT CONSTRUCTION S.A.S">PROJECT CONSTRUCTION S.A.S</option>
                                        <option value="PROKSOL">PROKSOL</option>
                                        <option value="PROMOTORA 775 S.A.S. Y PROMOTORA MAGNO LOFT">PROMOTORA 775 S.A.S.
                                            Y PROMOTORA MAGNO LOFT</option>
                                        <option value="PROMOTORA AIKI">PROMOTORA AIKI</option>
                                        <option value="PROMOTORA ALTO DE PALMAS SAS">PROMOTORA ALTO DE PALMAS SAS
                                        </option>
                                        <option value="PROMOTORA AOSTA S.A">PROMOTORA AOSTA S.A</option>
                                        <option value="PROMOTORA APOTEMA SAS">PROMOTORA APOTEMA SAS</option>
                                        <option value="PROMOTORA AZORE S.A.S">PROMOTORA AZORE S.A.S</option>
                                        <option value="PROMOTORA CAMPESTRE">PROMOTORA CAMPESTRE</option>
                                        <option value="PROMOTORA CIBELS S.A.S">PROMOTORA CIBELS S.A.S</option>
                                        <option value="PROMOTORA FORESTA">PROMOTORA FORESTA</option>
                                        <option value="PROMOTORA G 15 S.A.S">PROMOTORA G 15 S.A.S</option>
                                        <option value="PROMOTORA MINT">PROMOTORA MINT</option>
                                        <option value="PROMOTORA NIVEL SAS">PROMOTORA NIVEL SAS</option>
                                        <option value="PROMOTORA NURIA">PROMOTORA NURIA</option>
                                        <option value="PROMOTORA SAN MIGUEL S.A.S">PROMOTORA SAN MIGUEL S.A.S</option>
                                        <option value="PROMOTORA SEAPORT S.A.S">PROMOTORA SEAPORT S.A.S</option>
                                        <option value="PROMOTORA SUNNO ZN SAS">PROMOTORA SUNNO ZN SAS</option>
                                        <option value="PROMOTORA TORICES DEL MAR S.A.S.">PROMOTORA TORICES DEL MAR
                                            S.A.S.</option>
                                        <option value="PROMOTORA VIVENDI SAS">PROMOTORA VIVENDI SAS</option>
                                        <option value="PROURBE SA">PROURBE SA</option>
                                        <option value="PROYECTAMOS Y EDIFICAMOS">PROYECTAMOS Y EDIFICAMOS</option>
                                        <option value="PROYECTO ESTRATEGIA LTDA">PROYECTO ESTRATEGIA LTDA</option>
                                        <option value="PROYECTOS DE INGENIERÍA AVANZADA PRINZA">PROYECTOS DE INGENIERÍA
                                            AVANZADA PRINZA</option>
                                        <option value="PROYECTOS E INVERSIONES MPL SAS">PROYECTOS E INVERSIONES MPL SAS
                                        </option>
                                        <option value="PROYECTOS GIRARDOT Y ALREDEDORES">PROYECTOS GIRARDOT Y
                                            ALREDEDORES</option>
                                        <option value="PROYECTOS URBANOS 3L S.A.S.">PROYECTOS URBANOS 3L S.A.S.</option>
                                        <option value="PROYECTOS URBANOS DE COLOMBIA S.A.S.">PROYECTOS URBANOS DE
                                            COLOMBIA S.A.S.</option>
                                        <option value="Q-BICA">Q-BICA</option>
                                        <option value="QUINTERO ARBELAEZ SAS">QUINTERO ARBELAEZ SAS</option>
                                        <option value="RCH CONSTRUCTORES ASOCIADOS S.A.S.">RCH CONSTRUCTORES ASOCIADOS
                                            S.A.S.</option>
                                        <option value="RESIDERE S.A.S">RESIDERE S.A.S</option>
                                        <option value="RFP CONSTRUCTORES S.A.S.">RFP CONSTRUCTORES S.A.S.</option>
                                        <option value="ROBLE CONSTRUCCIONES SAS">ROBLE CONSTRUCCIONES SAS</option>
                                        <option value="RODRIGUEZ BRIÑEZ S.A.S.">RODRIGUEZ BRIÑEZ S.A.S.</option>
                                        <option value="RUIZ AREVALO CONSTRUCTORA S.A.">RUIZ AREVALO CONSTRUCTORA S.A.
                                        </option>
                                        <option value="SAHA CONSTRUCCIONES">SAHA CONSTRUCCIONES</option>
                                        <option value="SAVE INVERSIONES Y PROYECTOS S.A.S">SAVE INVERSIONES Y PROYECTOS
                                            S.A.S</option>
                                        <option value="SEIKA S.A.S.">SEIKa S.A.S.</option>
                                        <option value="SERVING">SERVING</option>
                                        <option value="SINTAGMA S.A.S">SINTAGMA S.A.S</option>
                                        <option value="SKEMA PROMOTORA S.A">SKEMA PROMOTORA S.A</option>
                                        <option value="SOCIEDAD PROMOTORA CAFETERA DE CONSTRUCCIONES">SOCIEDAD PROMOTORA
                                            CAFETERA DE CONSTRUCCIONES</option>
                                        <option value="SOCOCIL S.A.S">SOCOCIL S.A.S</option>
                                        <option value="SOHNOS SAS">SOHNOS SAS</option>
                                        <option value="SOLARI INVERSIONES Y DESARROLLOS INMOBILIARIOS SAS">SOLARI
                                            INVERSIONES Y DESARROLLOS INMOBILIARIOS SAS</option>
                                        <option value="SOLUCIONES CIVILES">SOLUCIONES CIVILES</option>
                                        <option value="SOLUCIONES CONSTRUCTIVAS S.A.S">SOLUCIONES CONSTRUCTIVAS S.A.S
                                        </option>
                                        <option value="SOLUCIONES DE VIVIENDA SV S.A.S">SOLUCIONES DE VIVIENDA SV S.A.S
                                        </option>
                                        <option value="SOLUCIONES SIVIS S.A.S">SOLUCIONES SIVIS S.A.S</option>
                                        <option value="SOPROTEC SAS">SOPROTEC SAS</option>
                                        <option value="STOGON CONSTRUCTORA S.A.S">STOGON CONSTRUCTORA S.A.S</option>
                                        <option value="SUMAS CONSTRUCCIONES SAS">SUMAS CONSTRUCCIONES SAS</option>
                                        <option value="SUPERHAVIT-AT">SUPERHAVIT-AT</option>
                                        <option value="TELVAL S.A.S.">TELVAL S.A.S.</option>
                                        <option value="TERRAPIN SAS">TERRAPIN SAS</option>
                                        <option value="TIERRA GRATA & CO">TIERRA GRATA & CO</option>
                                        <option value="TORORTIZ S.A.S.">TORORTIZ S.A.S.</option>
                                        <option value="TOUS CONSTRUCTORA">TOUS CONSTRUCTORA</option>
                                        <option value="TRAMETAL">TRAMETAL</option>
                                        <option value="TRAMONTANA CONSTRUCTORA SAS">TRAMONTANA CONSTRUCTORA SAS</option>
                                        <option value="TRAZOS URBANOS S.A.S.">TRAZOS URBANOS S.A.S.</option>
                                        <option value="TRIPLE AAA S.A.S">TRIPLE AAA S.A.S</option>
                                        <option value="TRUJILLO GUTIERREZ">TRUJILLO GUTIERREZ</option>
                                        <option value="TU CASA PROYECTOS S.A.S.">TU CASA PROYECTOS S.A.S.</option>
                                        <option value="UMBRAL">UMBRAL</option>
                                        <option value="UNION TEMPORAL SANTAMARIA">UNION TEMPORAL SANTAMARIA</option>
                                        <option value="URAKI CONSTRUCTORA">URAKI CONSTRUCTORA</option>
                                        <option value="URBAMARES">URBAMARES</option>
                                        <option value="URBANISMO Y DESARROLLOS INMOBILIARIOS SAS">URBANISMO Y
                                            DESARROLLOS INMOBILIARIOS SAS</option>
                                        <option value="URBANIZAR PEREIRA SAS">URBANIZAR PEREIRA SAS</option>
                                        <option value="VALLE CIPRES S.A.S">VALLE CIPRES S.A.S</option>
                                        <option value="VAVILCO">VAVILCO</option>
                                        <option value="VECTOR CONSTRUCCIONES S.A.S.">VECTOR CONSTRUCCIONES S.A.S.
                                        </option>
                                        <option value="VERDU CONTRUCCIONES SAS">VERDU CONTRUCCIONES SAS</option>
                                        <option value="VERSION URBANA">VERSION URBANA</option>
                                        <option value="VERTICE">VERTICE</option>
                                        <option value="VERTICES URBANOS SAS">VERTICES URBANOS SAS</option>
                                        <option value="VERTIZE">VERTIZE</option>
                                        <option value="VICTORIA ADMINISTRADORES">VICTORIA ADMINISTRADORES</option>
                                        <option value="VIVAL ARQUITECTOS">VIVAL ARQUITECTOS</option>
                                        <option value="VIVIENDAS Y PROYECTOS S.A.S">VIVIENDAS Y PROYECTOS S.A.S</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Auxiliar</label>
                                    <select class="form-select" name="auxiliar">
                                        <option value="">Todos</option>
                                        <option value="DANIEL CICERO">DANIEL CICERO</option>
                                        <option value="YENIFER PEREZ">YENIFER PEREZ</option>
                                        <option value="CARLOS DAVID ECHEVERRI">CARLOS DAVID ECHEVERRI</option>
                                        <option value="LILIANA DUARTE">LILIANA DUARTE</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filtro 3: Avances -->
                <div class="row mt-3">
                    <div class="col-md-6">
                        <div class="card filtro-card">
                            <div class="card-body">
                                <h5 class="card-title text-bancolombia">Estado Proyecto</h5>
                                <select class="form-select" name="estado_proyecto" id="estado_proyecto">
                                    <option value="">Todos</option>
                                    <option value="sin aprobar">Sin aprobar</option>
                                    <option value="aprobado sin desembolsar">Aprobado sin desembolsar</option>
                                    <option value="en preoperativo">En preoperativo</option>
                                    <option value="en construcción">En construcción</option>
                                    <option value="en escrituración">En escrituración</option>
                                    <option value="cancelado">Cancelado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <!-- Filtro 4: Desembolsos - Versión modificada -->
                    <div class="col-md-6">
                        <div class="card filtro-card">
                            <div class="card-body">
                                <h5 class="card-title text-bancolombia">Desembolsos</h5>
                                <button class="btn btn-bancolombia w-100" id="btn-ver-desembolsos">
                                    <i class="fas fa-search me-2"></i>Ver Desembolsos
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Botones -->
                    <div class="d-flex justify-content-end mt-4">
                        <button type="reset" class="btn btn-outline-secondary me-3">
                            <i class="fas fa-eraser me-2"></i>Limpiar
                        </button>
                        <button type="submit" class="btn btn-bancolombia">
                            <i class="fas fa-search me-2"></i>Buscar
                        </button>
                    </div>
            </form>
        </div>

        <!-- Resultados -->
        <div class="consultar-container">
            <h2 class="section-title"><i class="fas fa-table me-2"></i>Resultados</h2>
            <div class="d-flex justify-content-end mt-4">
                <div class="d-flex justify-content-end mt-4 align-items-center gap-2">
                    <label for="page-size-select" class="mb-0 me-2">Mostrar</label>
                    <select id="page-size-select" class="form-select form-select-sm" style="width: auto;">
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                    </select>
                </div>
            </div>
            <button type="button" class="btn btn-success" id="btn-exportar">
                <i class="fas fa-file-export me-2"></i>Exportar a Excel
            </button>
            <div class="table-responsive resultados-table">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID Proyecto</th>
                            <th>Proyecto</th>
                            <th>Estado</th>
                            <th>NIT</th>
                            <th>Titular</th>
                            <th>Arquitecto</th>
                            <th>Perito</th>
                            <th>Gerente</th>
                            <th>Constructor</th>
                            <th>Auxiliar</th>
                            <th>% Avance</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="resultados-body">
                        <!-- Dinámico -->
                    </tbody>
                </table>
            </div>
        </div>
        <!-- Paginación -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item disabled">
                    <a class="page-link" href="#" tabindex="-1">Anterior</a>
                </li>
                <li class="page-item active"><a class="page-link" href="#">1</a></li>
                <li class="page-item"><a class="page-link" href="#">2</a></li>
                <li class="page-item"><a class="page-link" href="#">3</a></li>
                <li class="page-item">
                    <a class="page-link" href="#">Siguiente</a>
                </li>
            </ul>
        </nav>
    </div>
    </div>


    <!-- Script para manejar la búsqueda -->

    <script>

        const USUARIO_NOMBRE = '{{ session.usuario.nombre }}'; // Nueva variable

        // Función para formatear valores monetarios
        function formatearMoneda(valor) {
            if (valor === null || valor === undefined) return '$ 0';
            return '$ ' + valor.toLocaleString('es-CO', { maximumFractionDigits: 0 });
        }

        // Función para formatear fechas
        function formatearFecha(fechaStr) {
            if (!fechaStr) return 'No disponible';

            try {
                const fecha = new Date(fechaStr);
                return fecha.toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                return 'Fecha inválida';
            }
        }

        // Función segura para establecer contenido de elementos
        function safeSetTextContent(elementId, text) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = text;
            } else {
                console.error(`Elemento con ID '${elementId}' no encontrado`);
            }
        }

        // Función para obtener el nombre del proyecto desde localStorage
        function obtenerNombreProyecto(idProyecto) {
            try {
                // 1. Buscar en historialDesembolsosDiarios
                const historialDesembolsosDiarios = JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');
                const proyectoDiario = historialDesembolsosDiarios.find(item =>
                    item.proyectoId == idProyecto && item.proyectoNombre
                );

                if (proyectoDiario) {
                    return proyectoDiario.proyectoNombre;
                }

                // 2. Buscar en historialVentas
                const historialVentas = JSON.parse(localStorage.getItem('historialVentas') || '[]');
                const proyectoVentas = historialVentas.find(item =>
                    item.proyectoId == idProyecto && item.proyectoNombre
                );

                if (proyectoVentas) {
                    return proyectoVentas.proyectoNombre;
                }

                // 3. Buscar en proyectos
                const proyecto = proyectosGlobal.find(p => p.id_proyecto == idProyecto);
                return proyecto ? proyecto.nombre_proyecto : "Proyecto sin nombre";

            } catch (e) {
                console.error('Error al obtener nombre del proyecto:', e);
                return "Proyecto sin nombre";
            }
        }

        // Función para obtener datos del proyecto
        function obtenerDatosProyecto(idProyecto) {
            try {
                // Normalizar idProyecto a string para comparaciones seguras
                const idStr = String(idProyecto).trim();

                // Intentar leer ambas posibles claves (compatibilidad retroactiva)
                const historial1 = JSON.parse(localStorage.getItem('historialDesembolsos') || '[]');
                const historial2 = JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');

                // Unir ambas fuentes (siempre array)
                const historial = []
                    .concat(Array.isArray(historial1) ? historial1 : [])
                    .concat(Array.isArray(historial2) ? historial2 : []);

                // Asegurar que sea array
                if (!Array.isArray(historial) || historial.length === 0) return null;

                // Filtrar por proyecto comparando como string (evita ===/tipo)
                const desembolsosProyecto = historial.filter(item => String(item.proyectoId).trim() === idStr);

                if (desembolsosProyecto.length === 0) return null;

                // Tomar el ultimo registrado por fecha (siempre validar fecha)
                return desembolsosProyecto.sort((a, b) => {
                    const fa = a.fechaCarga ? new Date(a.fechaCarga) : new Date(0);
                    const fb = b.fechaCarga ? new Date(b.fechaCarga) : new Date(0);
                    return fb - fa;
                })[0];
            } catch (e) {
                console.error("Error al obtener desembolsos (obtenerDatosProyecto):", e);
                return null;
            }
        }




        // Inicializar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function () {
            // Asignar el evento click al botón
            const btn = document.getElementById('btn-ver-desembolsos');
            if (btn) {
                btn.addEventListener('click', verValores);
            } else {
                console.error("Botón 'btn-ver-desembolsos' no encontrado");
            }
        });

        // Función principal para mostrar valores
        function verValores() {
            // Obtener ID del proyecto ingresado
            const idProyectoInput = document.getElementById('id_proyecto');

            // Verificar si el input existe
            if (!idProyectoInput) {
                console.error("Elemento 'id_proyecto' no encontrado");
                Swal.fire({
                    icon: 'error',
                    title: 'Error interno',
                    text: 'No se encontró el campo ID del proyecto'
                });
                return;
            }

            const idProyecto = idProyectoInput.value.trim();

            // Verificar si se ingresó un ID
            if (!idProyecto) {
                Swal.fire({
                    icon: 'error',
                    title: 'Campo requerido',
                    text: 'Debe ingresar el ID del proyecto para ver los valores'
                });
                return;
            }

            // Obtener nombre del proyecto
            const nombreProyecto = obtenerNombreProyecto(idProyecto);

            // Obtener datos del proyecto
            const datos = obtenerDatosProyecto(idProyecto);

            // Verificar si se encontraron datos
            if (!datos) {
                Swal.fire({
                    icon: 'error',
                    title: 'Datos no encontrados',
                    text: `No se encontraron valores calculados para el proyecto con ID: ${idProyecto}`
                });
                return;
            }

            // Obtener valores calculados
            const valores = datos.campos || {};

            // Actualizar título del proyecto
            safeSetTextContent('titulo-proyecto', `${nombreProyecto} (ID: ${idProyecto})`);

            // Actualizar valores calculados
            safeSetTextContent('modal-valor-entregado', formatearMoneda(valores.valorEntregado));
            safeSetTextContent('modal-valor-por-entregar', formatearMoneda(valores.valorPorEntregar));
            safeSetTextContent('modal-a-desembolsar', formatearMoneda(valores.formulaA));
            safeSetTextContent('modal-b-desembolsar', formatearMoneda(valores.formulaB));
            safeSetTextContent('modal-superavit', formatearMoneda(valores.superavit));

            // Manejar cobertura
            const cobertura = valores.cobertura || 0;
            safeSetTextContent('modal-cobertura', cobertura.toFixed(2) + '%');

            safeSetTextContent('modal-maximo-desembolsar', formatearMoneda(valores.maximoDesembolsar));

            // Actualizar información adicional
            safeSetTextContent('modal-fecha-carga', formatearFecha(datos.fechaCarga));
            safeSetTextContent('modal-usuario', datos.usuario || 'No disponible');

            const requiereVistoBueno = valores.requiereVistoBueno ? 'Sí' : 'No';
            safeSetTextContent('modal-requiere-visto-bueno', requiereVistoBueno);

            document.querySelectorAll('.modal-backdrop').forEach(b => b.remove());

            const modal = bootstrap.Modal.getOrCreateInstance(
                document.getElementById('modalDesembolsos'),
                {
                    backdrop: true,  // Permite cerrar haciendo clic fuera
                    keyboard: true   // Permite cerrar con ESC
                }
            );
            modal.show();

        }

        // Función de formato de fecha mejorada
        function formatFecha(valor) {
            try {
                if (!valor) return 'Sin registros';

                // Manejar diferentes formatos de fecha
                const fecha = new Date(valor);
                if (isNaN(fecha)) {
                    // Intentar extraer fecha de cadenas complejas
                    const match = valor.match(/(\d{2})[/-](\d{2})[/-](\d{4})/);
                    return match ? `${match[1]}/${match[2]}/${match[3]}` : 'Fecha inválida';
                }
                return fecha.toLocaleDateString('es-CO');
            } catch (e) {
                console.error('Error formateando fecha:', valor, e);
                return 'Formato inválido';
            }
        }


        function obtenerRolUsuario() {
            return document.querySelector('.role-badge').textContent.trim().toLowerCase();
        }

        // Función para cargar (y filtrar) proyectos
        // function cargarProyectos(filtros = {}) {
        //     const userRole = obtenerRolUsuario();
        //     let proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];

        //     // Ordena por fecha_creacion descendente (convirtiendo a Date)
        //     proyectos.sort((a, b) => {
        //         const fa = a.fecha_creacion ? new Date(a.fecha_creacion) : new Date(0);
        //         const fb = b.fecha_creacion ? new Date(b.fecha_creacion) : new Date(0);
        //         return fb - fa;
        //     });

        //     // Aplica filtros solo si hay valor en el formulario
        //     proyectos = proyectos.filter(p => {
        //         let ok = true;

        //         if (filtros.proyecto) {
        //             const busq = filtros.proyecto.toLowerCase();
        //             ok = ok && (
        //                 (p.id_proyecto || '').toString().toLowerCase().includes(busq) ||
        //                 (p.nombre_proyecto || '').toLowerCase().includes(busq)
        //             );
        //         }

        //         if (filtros.titular) {
        //             const busq = filtros.titular.toLowerCase();
        //             ok = ok && (p.titular_credito || '').toLowerCase().includes(busq);
        //         }

        //         if (filtros.nit) {
        //             const busq = filtros.nit.toLowerCase();
        //             ok = ok && (
        //                 (p.nit_titular || '').toLowerCase().includes(busq) ||
        //                 (p.nit_grupo_riesgo || '').toLowerCase().includes(busq)
        //             );
        //         }

        //         if (filtros.estado_proyecto) {
        //             const estadoProyecto = String(p.estado || 'sin aprobar').trim().toLowerCase();
        //             const filtroEstado = filtros.estado_proyecto.trim().toLowerCase();
        //             ok = ok && estadoProyecto === filtroEstado;
        //         }
        //         if (filtros.arquitecto) {
        //                 const busq = filtros.arquitecto.toLowerCase();
        //                 ok = ok && (p.arquitecto || '').toLowerCase().includes(busq);
        //         }
        //         if (filtros.gerente) {
        //                 const busq = filtros.gerente.toLowerCase();
        //                 ok = ok && (p.gerente || '').toLowerCase().includes(busq);
        //         }

        //         return ok;
        //     });

        //     // Renderizado
        //     const tbody = document.getElementById('resultados-body');
        //     tbody.innerHTML = '';

        //     proyectos.forEach(p => {
        //         const datos = {
        //             nombre_proyecto: p.nombre_proyecto || 'Proyecto sin nombre',
        //             estado: (p.estado !== undefined && p.estado !== null) ? p.estado : 'sin aprobar',
        //             titular: p.titular_credito || 'Sin titular',
        //             nit: p.nit_titular || p.nit_grupo_riesgo || 'Sin NIT',
        //             arquitecto: p.arquitecto || p.gerente || 'Sin arquitecto',
        //             avance: Math.min(Math.max(p.avance || 0, 0), 100),
        //             perito: p.perito || '—'
        //         };

        //         const puedeEditar = ['admin','auxiliar'].includes(userRole);

        //         let badge = '';
        //         switch ((datos.estado || '').toLowerCase()) {
        //             case 'sin aprobar': badge = '<span class="badge bg-secondary">Sin aprobar</span>'; break;
        //             case 'aprobado sin desembolsar': badge = '<span class="badge bg-primary">Aprobado sin desembolsar</span>'; break;
        //             case 'en preoperativo': badge = '<span class="badge bg-info text-dark">En preoperativo</span>'; break;
        //             case 'en construcción': badge = '<span class="badge bg-warning text-dark">En construcción</span>'; break;
        //             case 'en escrituración': badge = '<span class="badge bg-success">En escrituración</span>'; break;
        //             case 'cancelado': badge = '<span class="badge bg-danger">Cancelado</span>'; break;
        //             default: badge = `<span class="badge bg-light text-dark">${datos.estado}</span>`;
        //         }

        //         tbody.innerHTML += `
        //         <tr>
        //             <td>${datos.nombre_proyecto}</td>
        //             <td>${badge}</td> <!-- Estado -->
        //             <td>${datos.titular}</td>
        //             <td>${datos.nit}</td>
        //             <td>${datos.arquitecto}</td>
        //             <td>
        //                 <div class="progress">
        //                     <div class="progress-bar" style="width:${datos.avance}%">
        //                         ${datos.avance}%
        //                     </div>
        //                 </div>
        //             </td>
        //             <td>${datos.perito}</td>
        //             <td>
        //                 <div class="acciones-container">
        //                     <button class="btn btn-accion btn-accion-primary"
        //                             onclick="verProyecto('${p.id_proyecto}')"
        //                             data-bs-toggle="tooltip" title="Ver detalles">
        //                         <i class="fas fa-eye"></i> Ver
        //                     </button>
        //                 ${puedeEditar ? `
        //                 <button class="btn btn-accion btn-accion-secondary"
        //                         onclick="editarProyecto('${p.id_proyecto}')"
        //                         data-bs-toggle="tooltip" title="Editar proyecto">
        //                     <i class="fas fa-edit"></i> Editar Grupo
        //                 </button>
        //                 <div class="dropdown">
        //                     <button class="btn btn-accion btn-accion-secondary"
        //                             data-bs-toggle="dropdown" title="Más acciones">
        //                     <i class="fas fa-ellipsis-h"></i>
        //                     </button>
        //                     <ul class="dropdown-menu dropdown-menu-end animate__fadeIn">
        //                     <li>
        //                         <button class="dropdown-item"
        //                                 onclick="mostrarModalGestion('titular','${p.id_proyecto}')">
        //                         <i class="fas fa-user-edit me-2 text-primary"></i>
        //                         Cambio Titular
        //                         </button>
        //                     </li>
        //                     <li>
        //                         <button class="dropdown-item"
        //                                 onclick="mostrarModalGestion('nombre','${p.id_proyecto}')">
        //                         <i class="fas fa-signature me-2 text-info"></i>
        //                         Cambio Nombre
        //                         </button>
        //                     </li>
        //                     <li>
        //                         <button class="dropdown-item"
        //                                 onclick="mostrarModalGestion('unidades','${p.id_proyecto}')">
        //                         <i class="fas fa-cubes me-2 text-warning"></i>
        //                         Gestión Unidades
        //                         </button>
        //                     </li>
        //                     <li>
        //                         <button class="dropdown-item"
        //                                 onclick="mostrarModalGestion('desistimiento','${p.id_proyecto}')">
        //                         <i class="fas fa-ban me-2 text-danger"></i>
        //                         Desistimiento
        //                         </button>
        //                     </li>
        //                     <li>
        //                         <button class="dropdown-item"
        //                                 onclick="mostrarModalGestion('monto','${p.id_proyecto}')">
        //                         <i class="fas fa-coins me-2 text-success"></i>
        //                         Ampliación de Monto
        //                         </button>
        //                     </li>
        //                     <li>
        //                         <button class="dropdown-item"
        //                                 onclick="mostrarModalGestion('vigencia','${p.id_proyecto}')">
        //                         <i class="fas fa-calendar-day me-2 text-info"></i>
        //                         Ampliación de Vigencia
        //                         </button>
        //                     </li>
        //                     <li>
        //                         <button class="dropdown-item"
        //                                 onclick="mostrarModalGestion('plazo','${p.id_proyecto}')">
        //                         <i class="fas fa-clock me-2 text-warning"></i>
        //                         Ampliación de Plazo
        //                         </button>
        //                     </li>
        //                     <li><hr class="dropdown-divider"></li>
        //                     </ul>
        //                 </div>
        //                 ` : ''}
        //             </div>
        //             </td>
        //         </tr>
        //         `;
        //     });

        //     // Si no quedan proyectos, aviso
        //     if (proyectos.length === 0) {
        //         tbody.innerHTML = `
        //         <tr>
        //             <td colspan="7" class="text-center">— Sin resultados —</td>
        //         </tr>
        //         `;
        //     }
        // }

        // Opcional: al cargar la página muestro todos
        window.addEventListener('DOMContentLoaded', async () => {
            await cargarProyectos({});
        });

        // Funcion para abrir modal de edicion
        async function editarProyecto(id) {
            try {
                // Peticion al backend
                const response = await fetch(`/api/proyectos/${id}`);
                const result = await response.json();

                if (!result.success) {
                    Swal.fire('Error', 'Proyecto no encontrado', 'error');
                    return;
                }

                const p = result.proyecto;

                // Obtener avance desde historialVisitas
                let avanceDesdeVisitas = null;
                try {
                    if (typeof obtenerAvanceProyecto === 'function') {
                        avanceDesdeVisitas = obtenerAvanceProyecto(id);
                    }
                } catch (e) {
                    console.warn('editarProyecto: error al obtener avance desde historialVisitas', e);
                    avanceDesdeVisitas = null;
                }

                // fallback si no hay avance en historialVisitas
                let avanceParaEditar = Number(avanceDesdeVisitas ?? p.avance ?? p.avanceObra ?? 0);
                if (!Number.isFinite(avanceParaEditar)) avanceParaEditar = 0;
                avanceParaEditar = Math.min(Math.max(avanceParaEditar, 0), 100);

                // Rellenar campos
                document.getElementById('edit-id').value = p.id_proyecto ?? id;
                document.getElementById('edit-nombre').value = p.nombre_proyecto || '';
                document.getElementById('edit-titular').value = p.titular_credito || '';
                document.getElementById('edit-nit').value = p.nit_titular || '';
                document.getElementById('edit-avance').value = avanceParaEditar; // siempre numero, incluso 0

                // Rellenar lista de participantes
                const lista = document.querySelector('.participantes-list');
                lista.innerHTML = '';
                if (Array.isArray(p.participantes)) {
                    p.participantes.forEach(pt => {
                        const row = document.createElement('div');
                        row.classList.add('participante-item', 'mb-2', 'row');
                        row.innerHTML = `
                            <div class="col"><input type="text" class="form-control" placeholder="Nombre" value="${pt.nombre || ''}"></div>
                            <div class="col"><input type="text" class="form-control" placeholder="Rol" value="${pt.rol || ''}"></div>
                            <div class="col"><input type="number" class="form-control" placeholder="%" min="0" max="100" value="${pt.participacion || 0}"></div>
                            <div class="col-auto">
                                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.participante-item').remove()">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>`;
                        lista.appendChild(row);
                    });
                }

                // Mostrar modal
                bootstrap.Modal.getOrCreateInstance(document.getElementById('editarModal')).show();

                console.log('editarProyecto -> id:', id, 'avance usado:', avanceParaEditar);

            } catch (error) {
                console.error('Error al cargar proyecto:', error);
                Swal.fire('Error', 'No se pudo cargar el proyecto para edicion', 'error');
            }
        }



        // Añade un nuevo bloque de inputs para un participante
        function agregarParticipante() {
            const lista = document.querySelector('.participantes-list');
            const row = document.createElement('div');
            row.classList.add('participante-item', 'mb-2', 'row');
            row.innerHTML = `
                <div class="col"><input type="text" class="form-control" placeholder="Nombre"></div>
                <div class="col"><input type="text" class="form-control" placeholder="Rol"></div>
                <div class="col"><input type="number" class="form-control" placeholder="%" min="0" max="100"></div>
                <div class="col-auto">
                <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.participante-item').remove()">
                    <i class="fas fa-trash"></i>
                </button>
                </div>`;
            lista.appendChild(row);
        }

        function generarMenuAcciones(proyecto) {
            return `
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('desistimiento','${proyecto.id}')">
                        <i class="fas fa-ban me-2 text-danger"></i>
                        Desistimiento
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('monto','${proyecto.id}')">
                        <i class="fas fa-coins me-2 text-success"></i>
                        Ampliación de Monto
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('vigencia','${proyecto.id}')">
                        <i class="fas fa-calendar-day me-2 text-info"></i>
                        Ampliación de Vigencia
                    </button>
                </li>
                <li>
                    <button class="dropdown-item" 
                            onclick="mostrarModalGestion('plazo','${proyecto.id}')">
                        <i class="fas fa-clock me-2 text-warning"></i>
                        Ampliación de Plazo
                    </button>
                </li>
            `;
        }

        // [REMOVED DUPLICATED FUNCTION]


        function ensureCampoObject(campoOrVal) {
            // Si ya tiene estructura {valor:..., tipo:..., fuente:..., celda:...} la devolvemos tal cual.
            if (campoOrVal && typeof campoOrVal === 'object' && ('valor' in campoOrVal)) return campoOrVal;
            // Si viene primitivo, lo convertimos a { valor: X, tipo: inferido }
            const tipo = (typeof campoOrVal === 'number') ? 'entero' : (campoOrVal instanceof Date ? 'fecha' : 'texto');
            return { valor: campoOrVal, tipo };
        }

        // [REMOVED DUPLICATED FUNCTION]


        // ---------------------------
        // pushVisitaRegistro (corregido)
        // - preserva tipo/fuente/celda originales y solo cambia valor cuando corresponde
        // - setea FECHA VISITA y NUMERO VISITA manteniendo metadata si existia
        // ---------------------------
        function pushVisitaRegistro(proyectoId, usuario, camposEntrada, opciones = {}) {
            try {
                const raw = localStorage.getItem('historialVisitas') || '[]';
                const visitas = Array.isArray(JSON.parse(raw)) ? JSON.parse(raw) : [];

                const idStr = String(proyectoId ?? '').replace(/\s+/g, '').toLowerCase();

                const visitasProyecto = visitas.filter(v => String(v.proyectoId ?? '').replace(/\s+/g, '').toLowerCase() === idStr);

                // sacar los numeros existentes desde campos["NUMERO VISITA"].valor
                const numerosExistentes = visitasProyecto
                    .map(v => {
                        const n = v?.campos?.['NUMERO VISITA']?.valor;
                        return Number.isFinite(Number(n)) ? Number(n) : null;
                    })
                    .filter(n => n !== null);
                const maxExistente = numerosExistentes.length ? Math.max(...numerosExistentes) : 0;
                const numeroSiguiente = maxExistente + 1;

                // primer cargue (registro mas antiguo) si se necesita
                let primerCargue = null;
                if (visitasProyecto.length) {
                    const ordenadas = visitasProyecto.slice().sort((a, b) => {
                        const fa = new Date(a.fechaCarga || a.fecha || 0).getTime();
                        const fb = new Date(b.fechaCarga || b.fecha || 0).getTime();
                        return fa - fb;
                    });
                    primerCargue = ordenadas[0];
                }

                // Normalizar camposEntrada manteniendo estructura si ya existe
                const camposNormalized = {};
                const entrada = camposEntrada || {};
                for (const key of Object.keys(entrada)) {
                    const val = entrada[key];
                    if (val && typeof val === 'object' && ('valor' in val)) {
                        // clonamos para evitar mutaciones
                        camposNormalized[key] = { ...val };
                    } else {
                        // lo envolvemos con metadatos por defecto si viene primitivo
                        const tipoInferido = (typeof val === 'number') ? 'entero' : 'texto';
                        camposNormalized[key] = { valor: val, tipo: tipoInferido, fuente: 'directo' };
                    }
                }

                const nowIso = new Date().toISOString();

                // FECHA VISITA: mantener tipo/fuente/celda si ya existian, solo setear valor
                const fechaVisitaIso = opciones.fechaVisitaOverride ? new Date(opciones.fechaVisitaOverride).toISOString() : nowIso;
                if (!camposNormalized['FECHA VISITA']) camposNormalized['FECHA VISITA'] = { valor: fechaVisitaIso, tipo: 'fecha', fuente: 'sistema' };
                else camposNormalized['FECHA VISITA'].valor = fechaVisitaIso, camposNormalized['FECHA VISITA'].tipo = camposNormalized['FECHA VISITA'].tipo || 'fecha';

                // NUMERO VISITA: escribir numeroSiguiente respetando metadata si existe
                if (!camposNormalized['NUMERO VISITA']) camposNormalized['NUMERO VISITA'] = { valor: numeroSiguiente, tipo: 'entero', fuente: 'sistema' };
                else camposNormalized['NUMERO VISITA'].valor = numeroSiguiente, camposNormalized['NUMERO VISITA'].tipo = camposNormalized['NUMERO VISITA'].tipo || 'entero';

                // AVANCE OBRA: si se pasa override, solo actualizar valor y tipo (preservar celda/fuente si existe)
                if (typeof opciones.avanceOverride !== 'undefined') {
                    if (!camposNormalized['AVANCE OBRA']) camposNormalized['AVANCE OBRA'] = { valor: opciones.avanceOverride, tipo: 'porcentaje', fuente: 'directo' };
                    else {
                        camposNormalized['AVANCE OBRA'].valor = opciones.avanceOverride;
                        camposNormalized['AVANCE OBRA'].tipo = camposNormalized['AVANCE OBRA'].tipo || 'porcentaje';
                        camposNormalized['AVANCE OBRA'].fuente = camposNormalized['AVANCE OBRA'].fuente || 'directo';
                    }
                }

                // ESTADO EJECUCIÓN OBRA: override si viene, preservando tipo/fuente/celda
                if (typeof opciones.estadoOverride !== 'undefined') {
                    if (!camposNormalized['ESTADO EJECUCIÓN OBRA']) {
                        camposNormalized['ESTADO EJECUCIÓN OBRA'] = { valor: opciones.estadoOverride, tipo: 'texto', fuente: 'directo' };
                    } else {
                        camposNormalized['ESTADO EJECUCIÓN OBRA'].valor = opciones.estadoOverride;
                        camposNormalized['ESTADO EJECUCIÓN OBRA'].tipo = camposNormalized['ESTADO EJECUCIÓN OBRA'].tipo || 'texto';
                        camposNormalized['ESTADO EJECUCIÓN OBRA'].fuente = camposNormalized['ESTADO EJECUCIÓN OBRA'].fuente || 'directo';
                        // conservar .celda si existia
                    }
                }

                const nuevoRegistro = {
                    proyectoId: String(proyectoId),
                    campos: camposNormalized,
                    usuario: usuario || (window?.SESSION_USUARIO || 'Sistema'),
                    fechaCarga: nowIso
                };

                visitas.push(nuevoRegistro);
                localStorage.setItem('historialVisitas', JSON.stringify(visitas));

                console.log('pushVisitaRegistro -> agregado registro:', nuevoRegistro, { primerCargue, numeroSiguiente });
                return { nuevoRegistro, primerCargue, numeroSiguiente };
            } catch (err) {
                console.error('pushVisitaRegistro error:', err);
                return null;
            }
        }


        // ---------------------------
        // guardarCambios (corrigido)
        // - actualiza proyecto en localStorage
        // - llama a pushVisitaRegistro preservando la metadata original
        // - actualiza proyectos[idx].estado con el valor de campos['ESTADO EJECUCIÓN OBRA']
        // - vuelve a llamar al backend para regenerar el Excel principal
        // ---------------------------
        async function guardarCambios() {
            try {
                const proyectos = Array.isArray(JSON.parse(localStorage.getItem('proyectos') || '[]'))
                    ? JSON.parse(localStorage.getItem('proyectos') || '[]')
                    : [];

                const id = String(document.getElementById('edit-id')?.value || '').trim();
                if (!id) throw new Error('ID de proyecto no encontrado');

                const idx = proyectos.findIndex(p => String(p.id_proyecto ?? '').replace(/\s+/g, '').toLowerCase() === String(id).replace(/\s+/g, '').toLowerCase());
                if (idx === -1) throw new Error('Proyecto no existe en los registros');

                const form = document.getElementById('form-editar');
                if (!form) throw new Error('Formulario no encontrado');

                // obtener avance desde input o desde el proyecto existente
                let avanceVal = parseFloat(form.querySelector('#edit-avance')?.value);
                if (isNaN(avanceVal)) {
                    avanceVal = proyectos[idx].avance ?? proyectos[idx].avanceObra ?? null;
                }
                if (typeof avanceVal === 'number') {
                    avanceVal = Math.min(Math.max(Math.round(avanceVal * 100) / 100, 0), 100);
                }

                // calcular nuevo estado simple
                let nuevoEstado = proyectos[idx].estado || proyectos[idx].estadoEjecucion || 'sin definir';
                if (typeof avanceVal === 'number' && avanceVal >= 98) nuevoEstado = 'en escrituración';

                // Actualizamos campos del proyecto sin borrar metadata
                const updated = {
                    ...proyectos[idx],
                    avance: avanceVal,
                    avanceObra: avanceVal,
                    // NO sobrescribimos estado aun, lo actualizaremos despues con lo que quede en campos (si aplica)
                    ultimaModificacion: new Date().toISOString(),
                    usuarioModificacion: typeof USUARIO_NOMBRE !== 'undefined' ? USUARIO_NOMBRE : (window?.SESSION_USUARIO || 'Sistema')
                };

                proyectos[idx] = updated;
                localStorage.setItem('proyectos', JSON.stringify(proyectos));

                // Preparar camposBase: tomar primer cargue si existe para conservar metadatos del excel original
                const historialRaw = Array.isArray(JSON.parse(localStorage.getItem('historialVisitas') || '[]')) ? JSON.parse(localStorage.getItem('historialVisitas') || '[]') : [];
                const visitasProyecto = (historialRaw || []).filter(v => String(v.proyectoId ?? '').replace(/\s+/g, '').toLowerCase() === String(id).replace(/\s+/g, '').toLowerCase());
                let camposBase = {};
                if (visitasProyecto.length) {
                    const ordenadas = visitasProyecto.slice().sort((a, b) => {
                        const fa = new Date(a.fechaCarga || a.fecha || 0).getTime();
                        const fb = new Date(b.fechaCarga || b.fecha || 0).getTime();
                        return fa - fb;
                    });
                    camposBase = ordenadas[0].campos || {};
                } else {
                    camposBase = {
                        'ID PROYECTO': { valor: updated.id_proyecto || id, tipo: 'entero', fuente: 'directo' }
                    };
                }

                // Llamar helper para insertar el nuevo registro. El helper preserva celda/tipo/fuente
                const usuario = updated.usuarioModificacion || window?.SESSION_USUARIO || 'Sistema';
                const resultado = pushVisitaRegistro(id, usuario, camposBase, {
                    fechaVisitaOverride: new Date().toISOString(),
                    avanceOverride: typeof avanceVal === 'number' ? avanceVal : undefined,
                    estadoOverride: nuevoEstado
                });

                // Si push devolvio nuevo registro, actualizamos el estado del proyecto a partir del campo preciso
                if (resultado && resultado.nuevoRegistro) {
                    const estadoCampo = resultado.nuevoRegistro.campos?.['ESTADO EJECUCIÓN OBRA'] || resultado.nuevoRegistro.campos?.['ESTADO OBRA'];
                    const estadoValor = estadoCampo ? estadoCampo.valor : undefined;
                    if (typeof estadoValor !== 'undefined' && estadoValor !== null) {
                        proyectos[idx].estado = estadoValor;
                        // tambien guardamos metadata si quieres (no cambian estructuras de proyecto existentes)
                        localStorage.setItem('proyectos', JSON.stringify(proyectos));
                    }
                }

                // ---- REGENERA EXCEL PRINCIPAL en backend (se vuelve a llamar al endpoint)
                try {
                    const resp = await fetch('/exportar_excel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ proyectos })
                    });
                    if (resp.ok) {
                        const data = await resp.json().catch(() => null);
                        console.log('Excel regenerado en backend:', data || 'OK');
                    } else {
                        console.warn('Exportar Excel fallo. status:', resp.status);
                    }
                } catch (err) {
                    console.error('Error enviando cambios al backend para exportar Excel:', err);
                }
                // ---- fin export

                // refrescar UI y cerrar modal
                cargarProyectos({});
                bootstrap.Modal.getInstance(document.getElementById('editarModal'))?.hide();

                Swal.fire({
                    icon: 'success',
                    title: '¡Guardado!',
                    text: 'Cambios actualizados correctamente y Excel regenerado',
                    timer: 1500
                });

            } catch (error) {
                console.error('Error al guardar:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'No se pudieron guardar los cambios'
                });
            }
        }

        // Eliminar proyecto
        async function eliminarProyecto(id) {
            if (confirm('¿Estás seguro de que deseas eliminar este proyecto?')) {
                try {
                    const response = await fetch(`/api/proyectos/${id}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Proyecto eliminado correctamente');
                        await cargarProyectos(); // Recargar la lista
                    } else {
                        alert('Error al eliminar el proyecto: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar proyecto:', error);
                    alert('Error al eliminar el proyecto');
                }
            }
        }

        function confirmarEliminacion() {
            const id = document.getElementById('delete-id').value;
            let proyectos = JSON.parse(localStorage.getItem('proyectos') || '[]');
            proyectos = proyectos.filter(p => p.id !== id);
            localStorage.setItem('proyectos', JSON.stringify(proyectos));
            cargarProyectos();
            bootstrap.Modal.getInstance(document.getElementById('eliminarModal')).hide();
        }

        // Funciones para manejar participantes
        function agregarParticipante() {
            const container = document.querySelector('.participantes-list');
            const index = container.children.length;

            container.innerHTML += `
                <div class="participante-item mb-2">
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="text" class="form-control" placeholder="Nombre" data-index="${index}">
                        </div>
                        <div class="col-3">
                            <select class="form-select" data-index="${index}">
                                <option>Arquitecto</option>
                                <option>Ingeniero</option>
                                <option>Cliente</option>
                            </select>
                        </div>
                        <div class="col-3">
                            <input type="number" class="form-control" placeholder="Participación %" data-index="${index}">
                        </div>
                        <div class="col-2">
                            <button class="btn btn-danger btn-sm" onclick="eliminarParticipante(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function eliminarParticipante(index) {
            document.querySelectorAll('.participante-item')[index].remove();
        }

        function getBadgeEstado(estado) {
            switch ((estado || '').toLowerCase()) {
                case 'sin aprobar':
                    return '<span class="badge bg-secondary">Sin aprobar</span>';
                case 'aprobado sin desembolsar':
                    return '<span class="badge bg-primary">Aprobado sin desembolsar</span>';
                case 'en preoperativo':
                    return '<span class="badge bg-info text-dark">En preoperativo</span>';
                case 'en construcción':
                    return '<span class="badge bg-warning text-dark">En construcción</span>';
                case 'en escrituración':
                    return '<span class="badge bg-success">En escrituración</span>';
                case 'cancelado':
                case 'desistido':
                    return '<span class="badge bg-danger">' + (estado || 'Cancelado') + '</span>';
                default:
                    return `<span class="badge bg-light text-dark">${estado || 'Activo'}</span>`;
            }
        }


        async function verProyecto(id) {
            try {
                // 1. Buscar proyecto usando API
                const response = await fetch(`/api/proyectos/${id}`);
                const result = await response.json();

                if (!result.success) {
                    Swal.fire('Error', `Proyecto con ID ${id} no existe`, 'error');
                    return;
                }

                let proyecto = result.proyecto;

                // 🔹 Override con datos de localStorage (si existen)
                const proyectosLocal = JSON.parse(localStorage.getItem('proyectos') || '[]');
                const override = proyectosLocal.find(p => _idEq(p.id_proyecto, id));
                if (override) proyecto = { ...proyecto, ...override };

                // 2. Obtener avance: primero historialVisitas, si no existe fallback a la propiedad en proyecto
                const avanceDesdeVisitas = (typeof obtenerAvanceProyecto === 'function') ? obtenerAvanceProyecto(id) : null;
                const avanceFallback = proyecto.avanceObra ?? proyecto.avance ?? proyecto.campos?.['AVANCE OBRA'] ?? proyecto.campos?.avance_obra ?? 0;
                const avanceNumero = Number(avanceDesdeVisitas ?? avanceFallback) || 0;
                const avanceNormalized = Math.min(Math.max(avanceNumero, 0), 100);

                // 3. Construir contenido dinámico (IMPORTANTE: no backticks anidados)
                const proyectoIdSeguro = proyecto.id_proyecto ?? proyecto.proyectoId ?? proyecto.id ?? '';
                const contenidoHTML = `
                    <div class="container-fluid">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4>${proyecto.nombre_proyecto || 'Proyecto sin nombre'}</h4>
                            <!-- BOTON: sin onclick inline; usamos data-proyecto-id -->
                            <button class="btn btn-primary btn-sm btn-ver-historial"
                                    data-proyecto-id=${JSON.stringify(proyectoIdSeguro)}>
                                <i class="fas fa-history me-2"></i>Ver Historial
                            </button>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>ID Proyecto:</strong> ${proyecto.id_proyecto || proyectoIdSeguro}</p>
                                <p><strong>Titular:</strong> ${proyecto.titular_credito || 'No registrado'}</p>
                                <p><strong>NIT:</strong> ${proyecto.nit_titular || proyecto.nit || 'Sin NIT'}</p>
                                <p><strong>Vigencia:</strong> ${proyecto.vigencia_en_meses ?? 'No definida'} meses</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Avance:</strong></p>
                                <div class="progress">
                                    <div id="verProyecto-avance-bar" class="progress-bar" 
                                        role="progressbar" style="width: ${avanceNormalized}%"
                                        aria-valuenow="${avanceNormalized}" aria-valuemin="0" aria-valuemax="100">
                                        ${avanceNormalized}%
                                    </div>
                                </div>

                                <p class="mt-2"><strong>Estado:</strong> ${getBadgeEstado(proyecto.estado)}</p>
                            </div>
                        </div>

                        ${proyecto.participantes?.length ? '<!-- participantes -->' : ''}
                        ${proyecto.gestiones?.length ? '<!-- gestiones -->' : ''}
                    </div>`;

                // 4. Inyectar contenido y mostrar modal
                const detalleContent = document.getElementById('detalle-content');
                if (detalleContent) detalleContent.innerHTML = contenidoHTML;

                const detalleModalEl = document.getElementById('detalleModal');
                if (detalleModalEl) {
                    try { new bootstrap.Modal(detalleModalEl).show(); } catch (e) { /* ignore */ }
                }

                console.log('verProyecto -> id:', id, 'estado usado:', proyecto.estado);

            } catch (error) {
                console.error('Error en verProyecto:', error);
                Swal.fire('Error', 'No se pudo cargar el detalle del proyecto', 'error');
            }
        }


        // 2) Al enviar el formulario, evita el submit y llama a cargarProyectos
        document.getElementById('form-consulta').addEventListener('submit', function (e) {
            e.preventDefault();
            const filtros = {
                id_proyecto: (this.elements['id_proyecto']?.value || '').trim(),
                proyecto: (this.elements['proyecto']?.value || '').trim(),
                titular: (this.elements['titular']?.value || '').trim(),
                nit: (this.elements['nit']?.value || '').trim(),
                estado_proyecto: document.getElementById('estado_proyecto').value,
                arquitecto: (this.elements['arquitecto']?.value || '').trim(),
                perito: (this.elements['perito']?.value || '').trim(),
                gerente: (this.elements['gerente']?.value || '').trim(),
                grupoPrincipal: (this.elements['grupoPrincipal']?.value || '').trim(),
                auxiliar: (this.elements['auxiliar']?.value || '').trim()
            };
            cargarProyectos(filtros);
        });

        // Exportar a Excel
        // Helper: obtiene un id robusto del proyecto
        function getIdProyecto(proyecto) {
            const idDesdeCampos = proyecto?.campos?.['ID PROYECTO']?.valor ?? proyecto?.campos?.['ID_PROYECTO']?.valor;
            return proyecto?.id_proyecto ?? proyecto?.proyectoId ?? proyecto?.id ?? idDesdeCampos ?? '';
        }

        // Helper: formatea fecha (ajusta formato si quieres otro)
        function formatFecha(fecha) {
            if (!fecha) return '';
            const d = new Date(fecha);
            if (isNaN(d.getTime())) return '';
            // dd/mm/yyyy hh:mm
            const pad = n => String(n).padStart(2, '0');
            return `${pad(d.getDate())}/${pad(d.getMonth() + 1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        // Escapa valores para CSV (dobla comillas y rodea con comillas)
        function escapeCsv(value) {
            if (value === null || value === undefined) return '""';
            const s = String(value);
            return `"${s.replace(/"/g, '""')}"`;
        }

        document.getElementById('btn-exportar').addEventListener('click', () => {
            const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];

            // Cabeceras (en una sola línea)
            const headers = [
                'Id Proyecto',
                'Proyecto',
                'NIT',
                'Titular',
                'Arquitecto',
                'Perito',
                'Gerente',
                'Constructor',
                'Auxiliar',
                '% Avance',
                'FechaCreacion'
            ];

            const filas = [];
            // Agregar cabecera (separador: coma). No escapamos nombres de encabezado para legibilidad.
            filas.push(headers.join(','));

            // Filas de datos
            proyectos.forEach(proyecto => {
                const id = getIdProyecto(proyecto);
                const rowValues = [
                    id,
                    proyecto.nombre_proyecto || '',
                    proyecto.nit || proyecto.nit_titular || '',
                    proyecto.titular || proyecto.titular_credito || '',
                    // constructor o grupoPrincipal según lo que uses
                    proyecto.arquitecto || '',
                    proyecto.perito || '',
                    // gerente puede ser objeto
                    (typeof proyecto.gerente === 'object' ? (proyecto.gerente?.nombre ?? '') : (proyecto.gerente ?? '')),
                    proyecto.grupoPrincipal || proyecto.constructor || proyecto.razon_social || '',
                    proyecto.auxiliar || '',
                    proyecto.avance != null ? proyecto.avance : 0,
                    formatFecha(proyecto.fecha_creacion || proyecto.createdAt || proyecto.fechaCreacion)
                ];

                // Escapar cada valor y unir con comas
                filas.push(rowValues.map(v => escapeCsv(v)).join(','));
            });

            // Crear blob y descargar (uso \r\n para compatibilidad con Excel en Windows)
            const csvContent = filas.join('\r\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'proyectos.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        });


        // Mostrar modal de gestión
        async function mostrarModalGestion(tipo, proyectoId) {
            try {
                // Primero obtener los datos del proyecto
                const response = await fetch(`/api/proyectos/${proyectoId}`);
                const result = await response.json();

                if (!result.success) {
                    alert('Proyecto no encontrado');
                    return;
                }

                const proyecto = result.proyecto;

                // Configurar el modal según el tipo de gestión
                document.getElementById('gestionModalTitle').textContent = `Gestión: ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`;
                document.getElementById('gestion-tipo').value = tipo;
                document.getElementById('gestion-id').value = proyectoId;

                // Ocultar todos los contenidos primero
                document.querySelectorAll('.gestion-contenido').forEach(el => {
                    el.style.display = 'none';
                });

                // Mostrar el contenido específico según el tipo
                const contenido = document.getElementById(`contenido-${tipo}`);
                if (contenido) {
                    contenido.style.display = 'block';

                    // Llenar campos según el tipo
                    switch (tipo) {
                        case 'titular':
                            document.getElementById('actual-titular').value = proyecto.titular_credito || '';
                            break;
                        case 'nombre':
                            document.getElementById('actual-nombre').value = proyecto.nombre_proyecto || '';
                            break;
                        case 'unidades':
                            document.getElementById('actual-unidades').value = proyecto.total_inmuebles || 0;
                            break;
                        case 'desistimiento':
                            // Establecer fecha actual por defecto
                            document.getElementById('fecha-desistimiento').value = new Date().toISOString().split('T')[0];
                            break;
                        case 'monto':
                            document.getElementById('actual-monto').value = proyecto.total_valor_aprobado || 0;
                            break;
                        case 'vigencia':
                            // Puedes establecer la vigencia actual si está disponible
                            if (proyecto.vigencia_en_meses) {
                                const fechaActual = new Date();
                                fechaActual.setMonth(fechaActual.getMonth() + parseInt(proyecto.vigencia_en_meses));
                                document.getElementById('actual-vigencia').value = fechaActual.toISOString().split('T')[0];
                            }
                            break;
                        case 'plazo':
                            document.getElementById('actual-plazo').value = proyecto.plazo_ajustado || proyecto.meses_programacion || 0;
                            break;
                    }
                }

                // Mostrar el modal
                const modal = new bootstrap.Modal(document.getElementById('gestionModal'));
                modal.show();

            } catch (error) {
                console.error('Error al cargar datos para el modal:', error);
                alert('Error al cargar los datos del proyecto');
            }
        }

        // Guardar gestión
        async function guardarGestion() {
            const tipo = document.getElementById('gestion-tipo').value;
            const proyectoId = document.getElementById('gestion-id').value;
            const comentarios = document.querySelector('#form-gestion textarea').value;

            let datosGestion = {
                tipo: tipo,
                fecha: new Date().toISOString(),
                comentarios: comentarios,
                usuario: '{{ session.usuario.nombre }}' // Usuario desde sesión
            };

            // Recoger datos específicos según el tipo
            switch (tipo) {
                case 'titular':
                    datosGestion.actual = document.getElementById('actual-titular').value;
                    datosGestion.nuevo = document.getElementById('nuevo-titular').value;
                    break;
                case 'nombre':
                    datosGestion.actual = document.getElementById('actual-nombre').value;
                    datosGestion.nuevo = document.getElementById('nuevo-nombre').value;
                    break;
                case 'unidades':
                    datosGestion.actual = document.getElementById('actual-unidades').value;
                    datosGestion.nuevo = document.getElementById('nuevo-unidades').value;
                    datosGestion.tipo_modificacion = document.getElementById('tipo-modificacion').value;
                    break;
                case 'desistimiento':
                    datosGestion.motivo = document.getElementById('motivo-desistimiento').value;
                    datosGestion.fecha_efectiva = document.getElementById('fecha-desistimiento').value;
                    break;
                case 'monto':
                    datosGestion.actual = document.getElementById('actual-monto').value;
                    datosGestion.nuevo = document.getElementById('nuevo-monto').value;
                    break;
                case 'vigencia':
                    datosGestion.actual = document.getElementById('actual-vigencia').value;
                    datosGestion.nuevo = document.getElementById('nueva-vigencia').value;
                    break;
                case 'plazo':
                    datosGestion.actual = document.getElementById('actual-plazo').value;
                    datosGestion.nuevo = document.getElementById('nuevo-plazo').value;
                    break;
            }

            try {
                const response = await fetch(`/api/proyectos/${proyectoId}/gestiones`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(datosGestion)
                });

                const result = await response.json();

                if (result.success) {
                    alert('Gestión guardada correctamente');

                    // Cerrar el modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('gestionModal'));
                    modal.hide();

                    // Recargar el proyecto para ver los cambios
                    await cargarProyectos();
                } else {
                    alert('Error al guardar la gestión: ' + result.message);
                }
            } catch (error) {
                console.error('Error al guardar gestión:', error);
                alert('Error al guardar la gestión');
            }
        }

        // Cargar gestiones de un proyecto (para el modal de historial)
        async function cargarGestiones(proyectoId) {
            try {
                const response = await fetch(`/api/proyectos/${proyectoId}`);
                const result = await response.json();

                if (!result.success) {
                    console.error('Error al cargar gestiones:', result.message);
                    return;
                }

                const proyecto = result.proyecto;
                const gestiones = proyecto.gestiones || [];

                // Aquí puedes implementar la visualización de gestiones en tu modal de historial
                console.log('Gestiones del proyecto:', gestiones);

            } catch (error) {
                console.error('Error al cargar gestiones:', error);
            }
        }

        // Eliminar gestión
        async function eliminarGestion(proyectoId, gestionId) {
            if (confirm('¿Estás seguro de que deseas eliminar esta gestión?')) {
                try {
                    const response = await fetch(`/api/proyectos/${proyectoId}/gestiones/${gestionId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Gestión eliminada correctamente');
                        await cargarGestiones(proyectoId); // Recargar las gestiones
                    } else {
                        alert('Error al eliminar la gestión: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error al eliminar gestión:', error);
                    alert('Error al eliminar la gestión');
                }
            }
        }


        // Funciones de utilidad (globales)
        function formatFecha(valor) {
            if (!valor) return 'N/A';
            try {
                if (typeof valor === 'string' && valor.includes('T')) {
                    return new Date(valor).toLocaleDateString('es-CO');
                }
                if (typeof valor === 'number') {
                    return new Date((valor - 25569) * 86400 * 1000).toLocaleDateString('es-CO');
                }
                return valor;
            } catch (e) {
                console.error('Error formateando fecha:', valor, e);
                return 'Formato inválido';
            }
        }

        function formatCurrency(value) {
            if (isNaN(value)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // [REMOVED DUPLICATED FUNCTION]


        // cargarHistorialVentas(idProyecto, ventasDataOpt)
        function cargarHistorialVentas(idProyecto, ventasDataOpt = null) {
            try {
                const idStr = normalizarIdProyecto(idProyecto);

                // Obtener array: preferir ventasDataOpt si es array, si no usar localStorage
                let historial = Array.isArray(ventasDataOpt) ? ventasDataOpt :
                    JSON.parse(localStorage.getItem('historialVentas') || '[]');

                if (!Array.isArray(historial)) historial = [];

                const ventasProyecto = historial.filter(v => _idEq(v.proyectoId, idStr));
                const tbody = document.querySelector('#tabla-ventas tbody');
                if (!tbody) {
                    console.warn('cargarHistorialVentas: #tabla-ventas tbody no encontrado');
                    return;
                }
                tbody.innerHTML = '';

                if (ventasProyecto.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros de ventas</td></tr>';
                    return;
                }

                ventasProyecto.forEach((d, index) => {
                    const campos = d.campos || {};
                    // obtener porcentaje de forma segura; si viene en 0-1 lo convertimos a %
                    let pct = Number(getNestedValue(campos, '% PORCENTAJE DE VENTAS (unidades).valor')
                        ?? getNestedValue(campos, 'PORCENTAJE DE VENTAS.valor')
                        ?? 0);
                    if (!Number.isFinite(pct)) pct = 0;
                    if (Math.abs(pct) <= 1) pct = pct * 100; // si esta en 0..1 lo convertimos

                    const inmueblesVendidos = Number(getNestedValue(campos, 'INMUEBLES VENDIDOS (unidades).valor') ?? 0);
                    const valorInmueblesVendidos = Number(getNestedValue(campos, 'valor inmuebles vendidos.valor') ?? 0);
                    const carteraRecaudada = Number(getNestedValue(campos, 'cartera RECAUDADA.valor') ?? 0);

                    tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formatFecha(d.fechaCarga)}</td>
                        <td>${d.usuario || 'N/A'}</td>
                        <td>${getNestedValue(campos, 'FECHA INICIO DE VENTAS.valor') || 'N/A'}</td>
                        <td>${inmueblesVendidos}</td>
                        <td>${pct.toFixed(2)}%</td>
                        <td>${formatCurrency(valorInmueblesVendidos)}</td>
                        <td>${formatCurrency(carteraRecaudada)}</td>
                    </tr>
                `;
                });
            } catch (error) {
                console.error('Error cargando ventas:', error);
                const tbody = document.querySelector('#tabla-ventas tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar ventas</td></tr>';
            }
        }

        // cargarHistorialVisitas(idProyecto, visitasDataOpt)
        function cargarHistorialVisitas(idProyecto, visitasDataOpt = null) {
            try {
                const idStr = normalizarIdProyecto(idProyecto);

                let historial = Array.isArray(visitasDataOpt) ? visitasDataOpt :
                    JSON.parse(localStorage.getItem('historialVisitas') || '[]');

                if (!Array.isArray(historial)) historial = [];

                const visitasProyecto = historial.filter(v => _idEq(v.proyectoId, idStr));
                const tbody = document.querySelector('#tabla-visitas tbody');
                if (!tbody) {
                    console.warn('cargarHistorialVisitas: #tabla-visitas tbody no encontrado');
                    return;
                }
                tbody.innerHTML = '';

                if (visitasProyecto.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros de visitas</td></tr>';
                    return;
                }

                visitasProyecto.forEach((d, index) => {
                    const campos = d.campos || {};
                    const fechaVisita = getNestedValue(campos, 'FECHA VISITA.valor') || d.fecha || d.fechaCarga || 'N/A';
                    const numeroVisita = getNestedValue(campos, 'NUMERO VISITA.valor') ?? 'N/A';
                    const avanceObra = getNestedValue(campos, 'AVANCE OBRA.valor') ?? 'N/A';
                    let avanceEsperado = Number(getNestedValue(campos, 'AVANCE ESPERADO PORCENTAJE.valor') ?? 0);
                    if (!Number.isFinite(avanceEsperado)) avanceEsperado = 0;
                    if (Math.abs(avanceEsperado) <= 1) avanceEsperado = avanceEsperado * 100; // normalizar a %
                    const estadoEjecucion = getNestedValue(campos, 'ESTADO EJECUCIÓN OBRA.valor') ?? 'N/A';
                    const resumenAlerta = getNestedValue(campos, 'RESUMEN ALERTA DEL PROYECTO.valor') || 'Sin alertas';

                    tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formatFecha(fechaVisita)}</td>
                        <td>${d.usuario || 'N/A'}</td>
                        <td>${avanceObra}</td>
                        <td>${avanceEsperado.toFixed(2)}%</td>
                        <td>${estadoEjecucion}</td>
                        <td>${resumenAlerta}</td>
                    </tr>
                `;
                });
            } catch (error) {
                console.error('Error cargando visitas:', error);
                const tbody = document.querySelector('#tabla-visitas tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar los datos de visitas</td></tr>';
            }
        }

        // --- Util: normaliza id para comparaciones ---
        // ----------------- UTILIDADES (definir una sola vez, al inicio del archivo) -----------------
        // [REMOVED DUPLICATED FUNCTION]

        function _idEq(a, b) {
            return normalizarIdProyecto(a) === normalizarIdProyecto(b);
        }

        // Event delegation para botones "Ver Historial" (definir solo una vez al inicializar la app)
        document.addEventListener('click', function (e) {
            const btn = e.target.closest && e.target.closest('.btn-ver-historial');
            if (!btn) return;

            const raw = btn.dataset.proyectoId;
            let id;
            try { id = raw ? JSON.parse(raw) : raw; } catch (err) { id = raw; }

            try {
                mostrarHistorial(id);
            } catch (err) {
                console.error('Error al abrir historial para', id, err);
                Swal.fire('Error', 'No se pudo abrir el historial', 'error');
            }
        });
        /**
         * Intenta extraer un valor numerico a partir de un objeto `d` buscando
         * por varias llaves posibles dentro de `d.campos` o en `d` mismo.
         * keys: array de nombres posibles, en orden de preferencia.
         * Devuelve number o null si no hay valor valido.
         */
        function obtenerValorCampo(d, keys = []) {
            if (!d) return null;
            const fuente = d.campos && typeof d.campos === 'object' ? d.campos : d;

            for (const k of keys) {
                if (fuente.hasOwnProperty(k)) {
                    const v = fuente[k];
                    // Si es string numerica la convertimos
                    if (typeof v === 'string' && v.trim() !== '') {
                        const n = Number(v.replace(/[^0-9\-\.,]/g, '').replace(',', '.'));
                        if (!isNaN(n)) return n;
                    }
                    if (typeof v === 'number' && !isNaN(v)) return v;
                    // si es object que envuelve valor
                    if (v && typeof v === 'object' && (v.valor !== undefined || v.value !== undefined)) {
                        const cand = v.valor !== undefined ? v.valor : v.value;
                        const n = Number(cand);
                        if (!isNaN(n)) return n;
                    }
                }
            }
            return null;
        }

        // cargarHistorialDesembolsosDiarios(idProyecto, desembolsosDataOpt)
        function cargarHistorialDesembolsosDiarios(idProyecto, desembolsosDataOpt = null) {
            try {
                const idStr = normalizarIdProyecto(idProyecto);

                let historial = Array.isArray(desembolsosDataOpt) ? desembolsosDataOpt :
                    JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');

                if (!Array.isArray(historial)) historial = [];

                const desembolsosProyecto = historial.filter(d => _idEq(d.proyectoId, idStr));
                const tbody = document.querySelector('#tabla-desembolsos tbody');
                if (!tbody) {
                    console.warn('cargarHistorialDesembolsosDiarios: tabla-desembolsos tbody no encontrada');
                    return;
                }
                tbody.innerHTML = '';

                if (desembolsosProyecto.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center">No hay registros de desembolsos</td></tr>';
                    return;
                }

                // Llaves candidatas en orden de preferencia
                const keysValorEntregado = ['valorEntregado', 'valor_entregado', 'valorEntregadoCOP', 'valor_entregado_cop', 'valor'];
                const keysValorPorEntregar = ['valorPorEntregar', 'valor_por_entregar', 'valor_por_entrega', 'valorPendiente', 'valor_por_entregar'];
                const keysCobertura = ['cobertura', 'porcentajeCobertura', 'cobertura_porcentaje'];
                const keysSuperavit = ['superavit', 'superavit_cop', 'superávit'];

                desembolsosProyecto.forEach((d, index) => {
                    const vEntregado = Number(obtenerValorCampo(d, keysValorEntregado) ?? 0);
                    const vPorEntregar = Number(obtenerValorCampo(d, keysValorPorEntregar) ?? 0);
                    let coberturaVal = obtenerValorCampo(d, keysCobertura);
                    coberturaVal = Number(coberturaVal ?? 0);
                    const superavitVal = Number(obtenerValorCampo(d, keysSuperavit) ?? 0);

                    const fecha = d.fechaCarga || d.fecha || d.createdAt || null;
                    const usuario = d.usuario || d.usuarioCreacion || 'N/A';
                    const requiereVisto = (d.campos && (d.campos.requiereVistoBueno || d.campos.requiere_visto_bueno))
                        ? true : (d.requiereVistoBueno || d.requiere_visto_bueno ? true : false);

                    tbody.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${formatFecha(fecha)}</td>
                        <td>${usuario}</td>
                        <td>${formatCurrency(vEntregado)}</td>
                        <td>${formatCurrency(vPorEntregar)}</td>
                        <td>${(Number.isFinite(coberturaVal) ? coberturaVal : 0).toFixed(2)}%</td>
                        <td>${formatCurrency(superavitVal)}</td>
                        <td>${requiereVisto ? 'Sí' : 'No'}</td>
                    </tr>
                `;
                });
            } catch (error) {
                console.error('Error cargando desembolsos:', error);
                const tbody = document.querySelector('#tabla-desembolsos tbody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error al cargar desembolsos</td></tr>';
            }
        }

        // Obtiene appData del backend (usa /api/appData que mostraste)
        async function obtenerAppData() {
            try {
                const res = await fetch('/api/appData', { method: 'GET' });
                if (!res.ok) throw new Error('Respuesta no OK de /api/appData');
                const json = await res.json();

                return {
                    ventas: Array.isArray(json.historialVentas) ? json.historialVentas : (Array.isArray(json.historialventas) ? json.historialventas : []),
                    visitas: Array.isArray(json.historialVisitas) ? json.historialVisitas : (Array.isArray(json.historialvisitas) ? json.historialvisitas : []),
                    desembolsos: Array.isArray(json.historialDesembolsosDiarios) ? json.historialDesembolsosDiarios :
                        (Array.isArray(json.historialDesembolsos) ? json.historialDesembolsos : [])
                };
            } catch (err) {
                console.error('obtenerAppData error:', err);
                // Lanzamos para que el caller decida (no hacer fallback automático)
                throw err;
            }
        }

        // Función mejorada para mostrar el historial
        /**
         * mostrarHistorial: usa datos del backend por defecto.
         * options:
         *   - appData: { ventas, visitas, desembolsos }  (si ya los tienes en memoria)
         *   - fallbackLocalStorage: boolean (false por defecto)
         */
        async function mostrarHistorial(idProyecto, options = {}) {
            try {
                const idStr = normalizarIdProyecto(idProyecto);

                // 1) obtener appData: preferir options.appData si la pasan
                let ventas = [], visitas = [], desembolsos = [];
                if (options && options.appData) {
                    const a = options.appData;
                    ventas = Array.isArray(a.ventas) ? a.ventas : [];
                    visitas = Array.isArray(a.visitas) ? a.visitas : [];
                    desembolsos = Array.isArray(a.desembolsos) ? a.desembolsos : [];
                } else {
                    // pedir al backend
                    try {
                        const a = await obtenerAppData();
                        ventas = a.ventas;
                        visitas = a.visitas;
                        desembolsos = a.desembolsos;
                    } catch (err) {
                        // si fallo y el caller pidió fallback, lo intentamos; si no, mostramos error
                        if (options && options.fallbackLocalStorage) {
                            console.warn('obtenerAppData fallo, usando localStorage por fallback');
                            try {
                                ventas = JSON.parse(localStorage.getItem('historialVentas') || '[]');
                                visitas = JSON.parse(localStorage.getItem('historialVisitas') || '[]');
                                desembolsos = JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');
                            } catch (e) {
                                ventas = visitas = desembolsos = [];
                            }
                        } else {
                            console.error('No se pudo obtener appData y fallbackLocalStorage no activado:', err);
                            Swal.fire('Error', 'No se pudo cargar el historial desde el servidor', 'error');
                            return;
                        }
                    }
                }

                // 2) Filtrar por idProyecto (usamos normalizacion robusta)
                const ventasProyecto = Array.isArray(ventas) ? ventas.filter(v => _idEq(v.proyectoId, idStr)) : [];
                const visitasProyecto = Array.isArray(visitas) ? visitas.filter(v => _idEq(v.proyectoId, idStr)) : [];
                const desembolsosProyecto = Array.isArray(desembolsos) ? desembolsos.filter(d => _idEq(d.proyectoId, idStr)) : [];

                // 3) Si no hay datos desde backend -> mensaje (no depender de localStorage por defecto)
                if (ventasProyecto.length === 0 && visitasProyecto.length === 0 && desembolsosProyecto.length === 0) {
                    Swal.fire({ title: 'Historial vacío', text: 'No hay historial disponible para este proyecto', icon: 'info' });
                    return;
                }

                // 4) Ocultar contenidos y activar la pestaña correspondiente (ventas>visitas>desembolsos)
                document.querySelectorAll('.historial-contenido').forEach(c => c.style.display = 'none');
                document.querySelectorAll('[data-tipo]').forEach(b => b.classList.remove('active'));

                if (ventasProyecto.length > 0) {
                    if (typeof cargarHistorialVentas === 'function') {
                        cargarHistorialVentas(idProyecto, ventasProyecto);
                    } else {
                        console.warn('cargarHistorialVentas no definida');
                    }
                    const boton = document.querySelector('[data-tipo="ventas"]');
                    if (boton) boton.classList.add('active');
                    const cont = document.getElementById('contenido-ventas');
                    if (cont) cont.style.display = 'block';
                } else if (visitasProyecto.length > 0) {
                    if (typeof cargarHistorialVisitas === 'function') {
                        cargarHistorialVisitas(idProyecto, visitasProyecto);
                    } else {
                        console.warn('cargarHistorialVisitas no definida');
                    }
                    const boton = document.querySelector('[data-tipo="visitas"]');
                    if (boton) boton.classList.add('active');
                    const cont = document.getElementById('contenido-visitas');
                    if (cont) cont.style.display = 'block';
                } else {
                    if (typeof cargarHistorialDesembolsosDiarios === 'function') {
                        cargarHistorialDesembolsosDiarios(idProyecto, desembolsosProyecto);
                    } else {
                        console.warn('cargarHistorialDesembolsosDiarios no definida');
                    }
                    const boton = document.querySelector('[data-tipo="desembolsos"]');
                    if (boton) boton.classList.add('active');
                    const cont = document.getElementById('contenido-desembolsos');
                    if (cont) cont.style.display = 'block';
                }

                // 5) Mostrar modal y asignar dataset
                const modal = document.getElementById('historialModal');
                if (modal) {
                    modal.dataset.proyectoId = idProyecto;
                    new bootstrap.Modal(modal).show();
                } else {
                    console.warn('mostrarHistorial: modalHistorial no encontrado');
                }
            } catch (error) {
                console.error('Error mostrando historial:', error);
                Swal.fire('Error', 'No se pudo cargar el historial', 'error');
            }
        }
        // Configuración de event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Cargar proyectos iniciales
            cargarProyectos();

            // Manejar botones de tipo de historial
            document.querySelectorAll('[data-tipo]').forEach(btn => {
                btn.addEventListener('click', function () {
                    const tipo = this.dataset.tipo;
                    const proyectoId = document.getElementById('historialModal').dataset.proyectoId;

                    // Actualizar botones activos
                    document.querySelectorAll('[data-tipo]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');

                    // Ocultar todos los contenidos
                    document.querySelectorAll('.historial-contenido').forEach(c => c.style.display = 'none');

                    // Mostrar contenido seleccionado
                    document.getElementById(`contenido-${tipo}`).style.display = 'block';

                    // Cargar datos según el tipo
                    switch (tipo) {
                        case 'ventas':
                            cargarHistorialVentas(proyectoId);
                            break;
                        case 'visitas':
                            cargarHistorialVisitas(proyectoId);
                            break;
                        case 'desembolsos':
                            cargarHistorialDesembolsosDiarios(proyectoId);
                            break;
                    }
                });
            });

            // Botón de exportar PDF
            document.getElementById('btn-export-pdf').addEventListener('click', function () {
                const tipoActivo = document.querySelector('[data-tipo].active').dataset.tipo;
                exportarAPDF(tipoActivo);
            });
        });

        let isGeneratingPDF = false;

        async function exportarAPDF(tipo) {
            if (isGeneratingPDF) return;
            isGeneratingPDF = true;

            try {
                Swal.fire({
                    title: 'Generando PDF',
                    html: 'Preparando documento...',
                    allowOutsideClick: false,
                    didOpen: () => Swal.showLoading()
                });

                const modal = document.getElementById('historialModal');
                const activeTabContent = modal.querySelector(`#contenido-${tipo}`);

                if (!activeTabContent) {
                    throw new Error(`No se encontró el contenido para ${tipo}`);
                }

                // Crear clon del contenido
                const contentClone = activeTabContent.cloneNode(true);

                // Ocultar elementos no deseados
                const elementsToHide = contentClone.querySelectorAll('.btn, .no-print');
                elementsToHide.forEach(el => el.style.display = 'none');

                // Asegurar que la tabla ocupe todo el ancho disponible
                const tables = contentClone.querySelectorAll('table');
                tables.forEach(table => {
                    table.style.width = '100%';
                    table.style.maxWidth = 'none';
                });

                const printStyles = `
                <style>
                    * {
                        box-sizing: border-box;
                    }
                    body {
                        font-family: Arial, sans-serif;
                        font-size: 10px;
                        margin: 0;
                        padding: 0;
                    }
                    .pdf-content {
                        padding: 10px 15px;
                        width: 100%;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 10px;
                        table-layout: auto;
                        word-wrap: break-word;
                        font-size: 9px;
                    }
                    th, td {
                        padding: 4px;
                        border: 1px solid #ddd;
                        text-align: left;
                        word-break: break-word;
                    }
                    th {
                        background-color: #004884;
                        color: white;
                    }
                    .text-center {
                        text-align: center;
                    }
                    .text-right {
                        text-align: right;
                    }
                    h1 {
                        color: #004884;
                        text-align: center;
                        margin-bottom: 5px;
                        font-size: 16px;
                    }
                    h2 {
                        text-align: center;
                        margin-top: 0;
                        margin-bottom: 10px;
                        font-size: 14px;
                    }
                    .footer {
                        text-align: right;
                        margin-top: 20px;
                        font-size: 0.8em;
                        color: #666;
                    }
                </style>
            `;

                const proyectoId = modal.dataset.proyectoId;
                const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];
                const proyecto = proyectos.find(p => p.id_proyecto === proyectoId) || {};

                const header = `
                <h1>Historial de ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</h1>
                <h2>${proyecto.nombre_proyecto || 'Proyecto no encontrado'}</h2>
            `;

                const footer = `
                <div class="footer">
                    Generado el ${new Date().toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
                </div>
            `;

                const pdfContainer = document.createElement('div');
                pdfContainer.innerHTML = `
                ${printStyles}
                <div class="pdf-content">
                    ${header}
                    ${contentClone.innerHTML}
                    ${footer}
                </div>
            `;

                // Aplicar estilos para asegurar que todo el contenido sea visible
                pdfContainer.style.width = '100%';
                pdfContainer.style.overflow = 'visible';

                document.body.appendChild(pdfContainer);

                await new Promise(resolve => setTimeout(resolve, 500));

                const options = {
                    margin: [5, 5, 5, 5], // Márgenes reducidos: [top, right, bottom, left]
                    filename: `Historial_${tipo}_${proyecto.nombre_proyecto || 'proyecto'}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        scrollX: 0,
                        scrollY: 0,
                        width: pdfContainer.scrollWidth,
                        height: pdfContainer.scrollHeight,
                        windowWidth: pdfContainer.scrollWidth,
                        letterRendering: true,
                        logging: false // Desactivar logs para mejor rendimiento
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: 'a4',
                        orientation: 'landscape'
                    }
                };

                await html2pdf().set(options).from(pdfContainer).save();

                document.body.removeChild(pdfContainer);
                Swal.close();

            } catch (error) {
                console.error('Error al generar PDF:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: `No se pudo generar el PDF: ${error.message}`
                });
            } finally {
                isGeneratingPDF = false;
            }
        }

        // Event listener mejorado
        document.addEventListener('DOMContentLoaded', function () {
            const btnExportPdf = document.getElementById('btn-export-pdf');

            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', function () {
                    const activeTab = document.querySelector('[data-tipo].active');
                    if (activeTab) {
                        exportarAPDF(activeTab.dataset.tipo);
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Seleccione una pestaña',
                            text: 'Por favor active una pestaña (Ventas, Visitas o Desembolsos) antes de exportar'
                        });
                    }
                });
            }
        });

        // Función para generar contenido de ventas en PDF (síncrona ahora)
        function generarContenidoVentasPDF(proyecto) {
            try {
                const historial = JSON.parse(localStorage.getItem('historialVentas')) || [];
                const ventasProyecto = historial.filter(v => v.proyectoId === proyecto.id_proyecto);

                // Verificar si hay datos
                if (ventasProyecto.length === 0) {
                    return `
                        <div style="font-family: Arial, sans-serif; padding: 20px;">
                            <h1 style="text-align: center; color: #004884;">Historial de Ventas</h1>
                            <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                            <p style="text-align: center; color: red; margin-top: 50px;">
                                No hay datos de ventas disponibles para este proyecto
                            </p>
                            <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                                Generado el ${new Date().toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                            </p>
                        </div>
                    `;
                }

                const rows = ventasProyecto.map(v => {
                    const campos = v.campos || {};
                    const fechaInicioVentas = campos['FECHA INICIO DE VENTAS']?.valor || campos['FECHA INICIO DE VENTAS'] || 'N/A';
                    const inmueblesVendidos = campos['INMUEBLES VENDIDOS (unidades)']?.valor || campos['INMUEBLES VENDIDOS (unidades)'] || 0;
                    const porcentajeVentas = campos['% PORCENTAJE DE VENTAS (unidades)']?.valor || campos['% PORCENTAJE DE VENTAS (unidades)'] || 0;
                    const valorVendido = campos['valor inmuebles vendidos']?.valor || campos['valor inmuebles vendidos'] || 0;
                    const carteraRecaudada = campos['cartera RECAUDADA']?.valor || campos['cartera RECAUDADA'] || 0;

                    return `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatFecha(v.fechaCarga)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${v.usuario || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatFecha(fechaInicioVentas)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${inmueblesVendidos}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${(porcentajeVentas * 100).toFixed(2)}%</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(valorVendido)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: right;">${formatCurrency(carteraRecaudada)}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div style="font-family: Arial, sans-serif; padding: 20px; width: 100%;">
                        <h1 style="text-align: center; color: #004884;">Historial de Ventas</h1>
                        <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                        <p style="text-align: center;">${proyecto.direccion || ''}</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background-color: #004884; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">Fecha Carga</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Usuario</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Inicio Ventas</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Inmuebles Vendidos</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">% Ventas</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Valor Vendido</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Cartera Recaudada</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        
                        <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                            Generado el ${new Date().toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error generando contenido de ventas:', error);
                return generarErrorPDF('ventas', error.message);
            }
        }

        // Función para generar contenido de visitas en PDF (síncrona ahora)
        function generarContenidoVisitasPDF(proyecto) {
            try {
                const historial = JSON.parse(localStorage.getItem('historialVisitas')) || [];
                const visitasProyecto = historial.filter(v => v.proyectoId === proyecto.id_proyecto);

                // Verificar si hay datos
                if (visitasProyecto.length === 0) {
                    return `
                        <div style="font-family: Arial, sans-serif; padding: 20px;">
                            <h1 style="text-align: center; color: #004884;">Historial de Visitas</h1>
                            <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                            <p style="text-align: center; color: red; margin-top: 50px;">
                                No hay datos de visitas disponibles para este proyecto
                            </p>
                            <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                                Generado el ${new Date().toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                            </p>
                        </div>
                    `;
                }

                const rows = visitasProyecto.map(v => {
                    const campos = v.campos || {};
                    const fechaVisita = campos['FECHA VISITA']?.valor || campos['FECHA VISITA'] || 'N/A';
                    const numeroVisita = campos['NUMERO VISITA']?.valor || campos['NUMERO VISITA'] || 'N/A';
                    const avanceObra = campos['AVANCE OBRA']?.valor || campos['AVANCE OBRA'] || 'N/A';
                    const avanceEsperado = campos['AVANCE ESPERADO PORCENTAJE']?.valor || campos['AVANCE ESPERADO PORCENTAJE'] || 0;
                    const estadoObra = campos['ESTADO EJECUCIÓN OBRA']?.valor || campos['ESTADO EJECUCIÓN OBRA'] || 'N/A';
                    const alertas = campos['RESUMEN ALERTA DEL PROYECTO']?.valor || campos['RESUMEN ALERTA DEL PROYECTO'] || 'Sin alertas';

                    return `
                        <tr>
                            <td style="padding: 6px; border: 1px solid #ddd;">${formatFecha(fechaVisita)}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${numeroVisita}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${v.usuario || 'N/A'}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${avanceObra}</td>
                            <td style="padding: 6px; border: 1px solid #ddd; text-align: center;">${avanceEsperado.toFixed(2)}%</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${estadoObra}</td>
                            <td style="padding: 6px; border: 1px solid #ddd;">${alertas}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div style="font-family: Arial, sans-serif; padding: 20px; width: 100%;">
                        <h1 style="text-align: center; color: #004884;">Historial de Visitas</h1>
                        <h2 style="text-align: center;">${proyecto.nombre_proyecto}</h2>
                        <p style="text-align: center;">${proyecto.direccion || ''}</p>
                        
                        <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background-color: #004884; color: white;">
                                    <th style="padding: 8px; border: 1px solid #ddd;">Fecha Visita</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">N° Visita</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Usuario</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Avance Obra</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">% Ejecución</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Estado Obra</th>
                                    <th style="padding: 8px; border: 1px solid #ddd;">Alertas</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        
                        <p style="text-align: right; margin-top: 30px; font-size: 0.8em;">
                            Generado el ${new Date().toLocaleDateString('es-CO', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                })}
                        </p>
                    </div>
                `;
            } catch (error) {
                console.error('Error generando contenido de visitas:', error);
                return generarErrorPDF('visitas', error.message);
            }
        }

        // Función para generar contenido de desembolsos en PDF (síncrona ahora)
        function generarContenidoDesembolsosPDF(proyecto) {
            try {
                const historial = JSON.parse(localStorage.getItem('historialDesembolsosDiarios') || '[]');
                const idStr = normalizarIdProyecto(proyecto.id_proyecto || proyecto.proyectoId || proyecto.id);
                const desembolsosProyecto = Array.isArray(historial) ? historial.filter(d => normalizarIdProyecto(d.proyectoId) === idStr) : [];
                console.log('generarContenidoDesembolsosPDF -> proyecto id:', idStr, 'encontrados:', desembolsosProyecto.length);

                if (desembolsosProyecto.length === 0) {
                    return `
                        <div style="font-family: Arial, sans-serif; padding: 20px;">
                            <h1 style="text-align: center; color: #004884;">Historial de Desembolsos</h1>
                            <h2 style="text-align: center;">${proyecto.nombre_proyecto || proyecto.nombre || ''}</h2>
                            <p style="text-align: center; color: red; margin-top: 50px;">
                                No hay datos de desembolsos disponibles para este proyecto
                            </p>
                        </div>
                    `;
                }

                const rows = desembolsosProyecto.map((d, idx) => {
                    const vEntregado = obtenerValorCampo(d, ['valorEntregado', 'valor_entregado', 'valor', 'valorEntregadoCOP']) ?? 0;
                    const vPorEntregar = obtenerValorCampo(d, ['valorPorEntregar', 'valor_por_entregar', 'valorPendiente']) ?? 0;
                    const cobertura = obtenerValorCampo(d, ['cobertura', 'porcentajeCobertura']) ?? 0;
                    const superavit = obtenerValorCampo(d, ['superavit', 'superávit']) ?? 0;
                    return `
                        <tr>
                            <td>${idx + 1}</td>
                            <td>${formatFecha(d.fechaCarga || d.fecha || d.createdAt)}</td>
                            <td>${d.usuario || d.usuarioCreacion || 'N/A'}</td>
                            <td>${formatCurrency(vEntregado)}</td>
                            <td>${formatCurrency(vPorEntregar)}</td>
                            <td>${(Number(cobertura) || 0).toFixed(2)}%</td>
                            <td>${formatCurrency(superavit)}</td>
                            <td>${(d.campos && (d.campos.requiereVistoBueno || d.campos.requiere_visto_bueno)) ? 'Si' : (d.requiereVistoBueno || d.requiere_visto_bueno ? 'Si' : 'No')}</td>
                        </tr>
                    `;
                }).join('');

                return `
                    <div style="font-family: Arial, sans-serif; padding: 20px;">
                        <h1 style="text-align: center; color: #004884;">Historial de Desembolsos</h1>
                        <h2 style="text-align: center;">${proyecto.nombre_proyecto || proyecto.nombre || ''}</h2>
                        <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
                            <thead>
                                <tr style="background:#eee;">
                                    <th>#</th><th>Fecha</th><th>Usuario</th><th>Valor Entregado</th><th>Valor por Entregar</th><th>Cobertura</th><th>Superavit</th><th>Visto Bueno</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                console.error('Error generando contenido de desembolsos:', error);
                return generarErrorPDF('desembolsos', error.message || error.toString());
            }
        }

        // Función para generar PDF de error
        function generarErrorPDF(tipo, mensajeError) {
            return `
                <div style="font-family: Arial, sans-serif; padding: 20px; color: red;">
                    <h1 style="text-align: center;">Error al generar el reporte de ${tipo}</h1>
                    <h2 style="text-align: center;">Detalles del error:</h2>
                    <p style="text-align: center; margin-top: 30px;">${mensajeError}</p>
                    <p style="text-align: right; margin-top: 50px; font-size: 0.8em;">
                        Generado el ${new Date().toLocaleDateString('es-CO', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}
                    </p>
                </div>
            `;
        }

        // Función para formatear fechas
        function formatFecha(valor) {
            if (!valor) return 'N/A';

            try {
                // Si es una cadena de fecha ISO
                if (typeof valor === 'string' && valor.includes('T')) {
                    const fecha = new Date(valor);
                    return fecha.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }

                // Si es un objeto de fecha de Excel (timestamp serial)
                if (typeof valor === 'number') {
                    const fecha = new Date((valor - 25569) * 86400 * 1000);
                    return fecha.toLocaleDateString('es-CO', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }

                // Si ya está formateado
                return valor;
            } catch (e) {
                console.error('Error formateando fecha:', valor, e);
                return 'Formato inválido';
            }
        }

        // Función para formatear moneda
        function formatCurrency(value) {
            if (isNaN(value)) return '$0';
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }

        // Event listener mejorado para el botón de exportar PDF
        document.addEventListener('DOMContentLoaded', function () {
            const btnExportPdf = document.getElementById('btn-export-pdf');
            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', function () {
                    const tipoActivo = document.querySelector('[data-tipo].active');
                    if (tipoActivo) {
                        exportarAPDF(tipoActivo.dataset.tipo);
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Seleccione un tipo',
                            text: 'Por favor seleccione un tipo de historial (ventas, visitas o desembolsos) antes de exportar'
                        });
                    }
                });
            } else {
                console.error('El botón btn-export-pdf no fue encontrado en el DOM');
            }
        });
        // Event listener para el botón de exportar PDF
        document.addEventListener('DOMContentLoaded', function () {
            const btnExportPdf = document.getElementById('btn-export-pdf');
            if (btnExportPdf) {
                btnExportPdf.addEventListener('click', function () {
                    const tipoActivo = document.querySelector('[data-tipo].active');
                    if (tipoActivo) {
                        exportarAPDF(tipoActivo.dataset.tipo);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Por favor seleccione un tipo de historial primero'
                        });
                    }
                });
            }
        });
        let paginaActual = 1;
        let tamanoPagina = 10;
        let proyectosFiltrados = [];

        async function cargarProyectos(filtros = {}) {
            const userRole = obtenerRolUsuario();

            try {
                const response = await fetch('/api/proyectos');
                if (!response.ok) throw new Error('Error al cargar proyectos');
                let proyectos = await response.json();

                // --- aplicar overrides desde localStorage ---
                const proyectosLocal = JSON.parse(localStorage.getItem('proyectos') || '[]');
                proyectos = proyectos.map(p => {
                    const override = proyectosLocal.find(x => x.id_proyecto === p.id_proyecto);
                    return override ? { ...p, ...override } : p;
                });


                // Ordenar y filtrar (mantén tu lógica existente)
                const parseFecha = (v) => {
                    if (!v) return 0;
                    const d = new Date(v);
                    return isNaN(d.getTime()) ? 0 : d.getTime();
                };

                proyectos.sort((a, b) => parseFecha(b.fecha_creacion) - parseFecha(a.fecha_creacion));

                function normalizarTexto(texto) {
                    // Manejar casos donde texto podría ser un objeto, null, undefined, etc.
                    if (texto === null || texto === undefined) {
                        return '';
                    }

                    // Si es un objeto, intentar convertirlo a string
                    if (typeof texto === 'object') {
                        // Si el objeto tiene propiedad nombre o text, usar eso
                        if (texto.nombre) return String(texto.nombre).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").trim();
                        if (texto.text) return String(texto.text).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").trim();
                        // Si no, usar la representación string del objeto
                        return String(texto).toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, " ").trim();
                    }

                    // Para cualquier otro tipo, convertirlo a string
                    return String(texto || '')
                        .toLowerCase()
                        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                        .replace(/\s+/g, " ")
                        .trim();
                }

                function coincidePorPalabras(filtro, valor) {
                    if (!filtro || !valor) return false;

                    // Asegurarse de que ambos sean strings
                    const filtroStr = String(filtro || '');
                    const valorStr = String(valor || '');

                    return filtroStr.includes(valorStr) || valorStr.includes(filtroStr);
                }

                function normalizarEstado(txt) {
                    return String(txt || '')
                        .toLowerCase()
                        .normalize("NFD")
                        .replace(/[\u0300-\u036f]/g, "") // quitar tildes
                        .trim();
                }



                // Filtrar
                proyectos = proyectos.filter(p => {
                    let ok = true;

                    // Nuevo filtro por ID Proyecto
                    if (filtros.id_proyecto) {
                        const busq = filtros.id_proyecto.toLowerCase();
                        ok = ok && (p.id_proyecto || '').toString().toLowerCase().includes(busq);
                    }

                    if (filtros.proyecto) {
                        const busq = filtros.proyecto.toLowerCase();
                        ok = ok && (
                            (p.id_proyecto || '').toString().toLowerCase().includes(busq) ||
                            (p.nombre_proyecto || '').toLowerCase().includes(busq)
                        );
                    }
                    if (filtros.titular) {
                        const busq = filtros.titular.toLowerCase();
                        ok = ok && (p.titular_credito || '').toLowerCase().includes(busq);
                    }
                    if (filtros.nit) {
                        const busq = (filtros.nit || '').replace(/\D+/g, ''); // solo dígitos
                        ok = ok && (
                            ((p.nit_titular || '').toString().replace(/\D+/g, '')).includes(busq) ||
                            ((p.nit_grupo_riesgo || '').toString().replace(/\D+/g, '')).includes(busq)
                        );
                    }
                    if (filtros.estado_proyecto) {
                        ok = ok && (
                            normalizarEstado(p.estado) === normalizarEstado(filtros.estado_proyecto)
                        );
                    }

                    if (filtros.arquitecto) {
                        const busq = normalizarTexto(filtros.arquitecto);
                        const arquitecto = normalizarTexto(p.arquitecto);
                        ok = ok && coincidePorPalabras(busq, arquitecto);
                    }

                    if (filtros.perito) {
                        const busq = normalizarTexto(filtros.perito);
                        const perito = normalizarTexto(p.perito);
                        ok = ok && coincidePorPalabras(busq, perito);
                    }

                    if (filtros.gerente) {
                        const busq = normalizarTexto(filtros.gerente);
                        const gerente = normalizarTexto(p.gerente);
                        ok = ok && coincidePorPalabras(busq, gerente);
                    }

                    if (filtros.grupoPrincipal) {
                        const busq = normalizarTexto(filtros.grupoPrincipal);
                        const grupoPrincipal = normalizarTexto(p.grupoPrincipal);
                        ok = ok && coincidePorPalabras(busq, grupoPrincipal);
                    }

                    if (filtros.auxiliar) {
                        const busq = normalizarTexto(filtros.auxiliar);
                        const auxiliar = normalizarTexto(p.auxiliar);
                        ok = ok && coincidePorPalabras(busq, auxiliar);
                    }

                    return ok;
                });

                proyectosFiltrados = proyectos; // Guardar filtrados para paginación
                paginaActual = 1; // Reiniciar página al aplicar filtros
                renderPagina(userRole);
                renderPaginacion();

            } catch (error) {
                console.error('Error:', error);
                Swal.fire('Error', 'No se pudieron cargar los proyectos', 'error');
            }
        }


        function renderPagina(userRole) {
            const tbody = document.getElementById('resultados-body');
            tbody.innerHTML = '';

            const inicio = (paginaActual - 1) * tamanoPagina;
            const fin = inicio + tamanoPagina;
            const pagina = proyectosFiltrados.slice(inicio, fin);

            pagina.forEach(p => {
                // --- ID robusto: probar varios nombres/combinaciones ---
                const idDesdeCampos = p?.campos?.['ID PROYECTO']?.valor ?? p?.campos?.['ID_PROYECTO']?.valor;
                const idProyecto = p?.id_proyecto ?? p?.proyectoId ?? p?.id ?? idDesdeCampos ?? '';

                // Obtener avance preferentemente desde historialVisitas
                // (asegurate de tener la funcion obtenerAvanceProyecto disponible)
                const avanceNumero = (typeof obtenerAvanceProyecto === 'function')
                    ? (obtenerAvanceProyecto(idProyecto) ?? obtenerValorCampo?.(p, ['avance', 'avance_obra', 'AVANCE OBRA']) ?? 0)
                    : (p.avance ?? obtenerValorCampo?.(p, ['avance', 'avance_obra', 'AVANCE OBRA']) ?? 0);

                const datos = {
                    id_proyecto: idProyecto || 'Sin ID', // coincide con la plantilla que usas
                    nombre_proyecto: p.nombre_proyecto || 'Proyecto sin nombre',
                    estado: (p.estado !== undefined && p.estado !== null) ? p.estado : 'sin aprobar',
                    titular: p.titular_credito || 'Sin titular',
                    nit: p.nit_titular || p.nit_grupo_riesgo || 'Sin NIT',
                    arquitecto: p.arquitecto || 'Sin arquitecto',
                    // normalizar entre 0 y 100
                    avance: Math.min(Math.max(Number(avanceNumero) || 0, 0), 100),
                    perito: p.perito || '—',
                    gerente: typeof p.gerente === 'object' ? p.gerente.nombre || 'Sin gerente' : p.gerente || 'Sin gerente',
                    grupoPrincipal: p.grupoPrincipal || 'Sin Constructor',
                    auxiliar: p.auxiliar || 'Sin auxiliar'
                };

                const puedeEditar = ['admin', 'auxiliar'].includes(userRole);

                // Badge por estado
                let badge = '';
                switch ((datos.estado || '').toLowerCase()) {
                    case 'sin aprobar': badge = '<span class="badge bg-secondary">Sin aprobar</span>'; break;
                    case 'aprobado sin desembolsar': badge = '<span class="badge bg-primary">Aprobado sin desembolsar</span>'; break;
                    case 'en preoperativo': badge = '<span class="badge bg-info text-dark">En preoperativo</span>'; break;
                    case 'en construcción': badge = '<span class="badge bg-warning text-dark">En construcción</span>'; break;
                    case 'en escrituración': badge = '<span class="badge bg-success">En escrituración</span>'; break;
                    case 'cancelado': badge = '<span class="badge bg-danger">Cancelado</span>'; break;
                    default: badge = `<span class="badge bg-light text-dark">${datos.estado}</span>`;
                }

                // Usamos JSON.stringify(idProyecto) al insertar en onclick para escapar correctamente
                tbody.innerHTML += `
                <tr>
                    <td>${datos.id_proyecto}</td>
                    <td>${datos.nombre_proyecto}</td>
                    <td>${badge}</td> <!-- Estado -->
                    <td>${datos.nit}</td>
                    <td>${datos.titular}</td>
                    <td>${datos.arquitecto}</td>
                    <td>${datos.perito}</td>
                    <td>${datos.gerente}</td>
                    <td>${datos.grupoPrincipal}</td>
                    <td>${datos.auxiliar}</td>
                    <td>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width:${datos.avance}%"
                                aria-valuenow="${datos.avance}" aria-valuemin="0" aria-valuemax="100">
                                ${datos.avance}%
                            </div>
                        </div>
                    </td>
                <td>
                        <div class="acciones-container">
                             <button class="btn btn-accion btn-accion-primary"
                                    onclick="verProyecto('${p.id_proyecto}')"
                                    data-bs-toggle="tooltip" title="Ver detalles">
                             <i class="fas fa-eye"></i> Ver
                            </button>
                    ${puedeEditar ? `
                        <button class="btn btn-accion btn-accion-secondary"
                                 onclick="editarProyecto('${p.id_proyecto}')"
                                data-bs-toggle="tooltip" title="Editar proyecto">
                         <i class="fas fa-edit"></i> Editar Grupo
                        </button>
                    <div class="dropdown">
                            <button class="btn btn-accion btn-accion-secondary"
                                 data-bs-toggle="dropdown" title="Más acciones">
                         <i class="fas fa-ellipsis-h"></i>
                            </button>
                             <ul class="dropdown-menu dropdown-menu-end animate__fadeIn">
                            <li>
                               <button class="dropdown-item"
                                         onclick="mostrarModalGestion('titular','${p.id_proyecto}')">
                                <i class="fas fa-user-edit me-2 text-primary"></i>
                                 Cambio Titular
                                 </button>
                             </li>
                             <li>
                                 <button class="dropdown-item"
                                         onclick="mostrarModalGestion('nombre','${p.id_proyecto}')">
                                 <i class="fas fa-signature me-2 text-info"></i>
                                 Cambio Nombre
                                 </button>
                             </li>
                             <li>
                                 <button class="dropdown-item"
                                         onclick="mostrarModalGestion('unidades','${p.id_proyecto}')">
                                 <i class="fas fa-cubes me-2 text-warning"></i>
                                 Gestión Unidades
                                 </button>
                             </li>
                             <li>
                                 <button class="dropdown-item"
                                         onclick="mostrarModalGestion('desistimiento','${p.id_proyecto}')">
                                 <i class="fas fa-ban me-2 text-danger"></i>
                                 Desistimiento
                                 </button>
                             </li>
                             <li>
                                 <button class="dropdown-item"
                                         onclick="mostrarModalGestion('monto','${p.id_proyecto}')">
                                 <i class="fas fa-coins me-2 text-success"></i>
                                 Ampliación de Monto
                                 </button>
                             </li>
                            <li>
                                <button class="dropdown-item"
                                        onclick="mostrarModalGestion('vigencia','${p.id_proyecto}')">
                                 <i class="fas fa-calendar-day me-2 text-info"></i>
                                 Ampliación de Vigencia
                                 </button>
                             </li>
                             <li>
                                <button class="dropdown-item"
                                         onclick="mostrarModalGestion('plazo','${p.id_proyecto}')">
                                 <i class="fas fa-clock me-2 text-warning"></i>
                                Ampliación de Plazo
                                 </button>
                             </li>
                             <li><hr class="dropdown-divider"></li>
                            </ul>
                         </div>
                         ` : ''}
                     </div>
                    </td>
                </tr>
                `;
            });

            if (pagina.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="12" class="text-center">— Sin resultados —</td>
                </tr>
                `;
            }
        }


        function renderPaginacion() {
            const totalPaginas = Math.ceil(proyectosFiltrados.length / tamanoPagina);
            const pagContainer = document.querySelector('.pagination');
            pagContainer.innerHTML = '';

            const btnPrev = document.createElement('li');
            btnPrev.className = `page-item ${paginaActual === 1 ? 'disabled' : ''}`;
            btnPrev.innerHTML = `<a class="page-link" href="#">Anterior</a>`;
            btnPrev.onclick = e => { e.preventDefault(); if (paginaActual > 1) { paginaActual--; renderPagina(obtenerRolUsuario()); renderPaginacion(); } };
            pagContainer.appendChild(btnPrev);

            for (let i = 1; i <= totalPaginas; i++) {
                const btn = document.createElement('li');
                btn.className = `page-item ${paginaActual === i ? 'active' : ''}`;
                btn.innerHTML = `<a class="page-link" href="#">${i}</a>`;
                btn.onclick = e => { e.preventDefault(); paginaActual = i; renderPagina(obtenerRolUsuario()); renderPaginacion(); };
                pagContainer.appendChild(btn);
            }

            const btnNext = document.createElement('li');
            btnNext.className = `page-item ${paginaActual === totalPaginas ? 'disabled' : ''}`;
            btnNext.innerHTML = `<a class="page-link" href="#">Siguiente</a>`;
            btnNext.onclick = e => { e.preventDefault(); if (paginaActual < totalPaginas) { paginaActual++; renderPagina(obtenerRolUsuario()); renderPaginacion(); } };
            pagContainer.appendChild(btnNext);
        }

        document.getElementById('page-size-select').addEventListener('change', function () {
            tamanoPagina = parseInt(this.value, 10);
            paginaActual = 1;
            renderPagina(obtenerRolUsuario());
            renderPaginacion();
        });

        /* ---------- HELPERS PARA AVANCE ---------- */
        /**
         * Intenta normalizar y convertir a numero un valor que puede estar en:
         * 'AVANCE OBRA', 'avance_obra', 'avanceObra', 'avance', 'porcentajeAvance', etc.
         * Acepta valores como "45%", "45,5" o 45 y devuelve numero (ej: 45 or 45.5) o null.
         */
        function parseAvanceValor(v) {
            if (v === null || v === undefined) return null;
            if (typeof v === 'number' && !isNaN(v)) return v;
            if (typeof v === 'string') {
                // quitar espacios y % y convertir coma a punto
                const cleaned = v.replace(/\s/g, '').replace('%', '').replace(',', '.');
                const n = Number(cleaned);
                return isNaN(n) ? null : n;
            }
            // si es objeto con propiedad valor/value
            if (typeof v === 'object') {
                const cand = v.valor ?? v.value ?? v;
                return parseAvanceValor(cand);
            }
            return null;
        }

        /**
         * Devuelve el avance (numero) para un proyecto consultando historialVisitas.
         * Busca los registros de historialVisitas por proyectoId, ordena por fecha
         * y toma el valor de la llave 'AVANCE OBRA' (o variantes).
         * Retorna numero (ej: 45.5) o null si no se encontro.
         */
        function obtenerAvanceProyecto(idProyecto) {
            try {
                const idStr = normalizarIdProyecto(idProyecto);
                const raw = localStorage.getItem('historialVisitas') || '[]';
                const visitas = JSON.parse(raw);
                if (!Array.isArray(visitas) || visitas.length === 0) return null;

                // Filtrar por proyecto
                const visitasProyecto = visitas.filter(v => normalizarIdProyecto(v.proyectoId) === idStr);
                if (visitasProyecto.length === 0) return null;

                // Ordenar por fecha (descendente) - considera varios nombres de fecha
                visitasProyecto.sort((a, b) => {
                    const fa = new Date(a.fecha || a.fechaCarga || a.createdAt || 0).getTime() || 0;
                    const fb = new Date(b.fecha || b.fechaCarga || b.createdAt || 0).getTime() || 0;
                    return fb - fa;
                });

                // Lista de llaves candidatas donde puede estar el avance
                const candidateKeys = [
                    'AVANCE OBRA', 'avance_obra', 'avanceObra', 'avance', 'porcentajeAvance',
                    'avance_obra_porcentaje', 'avancePorcentaje'
                ];

                // buscar en el objeto d.campos primero, luego en la raiz del objeto visita
                const latest = visitasProyecto[0];
                const fuente = (latest.campos && typeof latest.campos === 'object') ? latest.campos : latest;

                for (const k of candidateKeys) {
                    // chequeo directo respetando mayus/minus (algunos JSON pueden tener mayus)
                    if (fuente.hasOwnProperty(k)) {
                        const parsed = parseAvanceValor(fuente[k]);
                        if (parsed !== null) return parsed;
                    }
                }

                // Intento case-insensitive: buscar cualquier propiedad que contenga 'avance' y 'obra' o 'avance'
                const keys = Object.keys(fuente || {});
                for (const key of keys) {
                    const lk = key.toLowerCase();
                    if (lk.includes('avance')) {
                        const parsed = parseAvanceValor(fuente[key]);
                        if (parsed !== null) return parsed;
                    }
                    // si contiene 'avance' y 'obra' preferirlo
                    if (lk.includes('avance') && lk.includes('obra')) {
                        const parsed = parseAvanceValor(fuente[key]);
                        if (parsed !== null) return parsed;
                    }
                }

                return null;
            } catch (err) {
                console.error('obtenerAvanceProyecto error:', err);
                return null;
            }
        }

        /* ---------- UTIL: formatea porcentaje para mostrar en tabla o detalle ---------- */
        function formatPorcentaje(n) {
            if (n === null || n === undefined || isNaN(Number(n))) return '0.00%';
            return Number(n).toFixed(2) + '%';
        }


        window.addEventListener('DOMContentLoaded', () => {
            cargarProyectos({});
        });
    </script>
    <!-- Modal Detalles -->
    <div class="modal fade" id="detalleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Detalles del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detalle-content"></div>
            </div>
        </div>
    </div>
    <!-- Modal Editar Proyecto -->
    <div class="modal fade" id="editarModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">Editar Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-editar">
                        <input type="hidden" id="edit-id">
                        <div class="mb-3">
                            <label class="form-label">Nombre del Proyecto</label>
                            <input type="text" class="form-control" id="edit-nombre" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Titular</label>
                                <input type="text" class="form-control" id="edit-titular" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">NIT</label>
                                <input type="text" class="form-control" id="edit-nit" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Avance (%)</label>
                            <input type="number" class="form-control" id="edit-avance" min="0" max="100" required>
                        </div>
                        <div class="participantes-container mb-3">
                            <label class="form-label">Participantes</label>
                            <div class="participantes-list"></div>
                            <button type="button" class="btn btn-sm btn-primary mt-2" onclick="agregarParticipante()">
                                <i class="fas fa-plus"></i> Agregar Participante
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-warning" onclick="guardarCambios()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Eliminar -->
    <div class="modal fade" id="eliminarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirmar Eliminación</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>¿Está seguro que desea eliminar este proyecto? Esta acción no se puede deshacer.</p>
                    <input type="hidden" id="delete-id">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="confirmarEliminacion()">Eliminar
                        Definitivamente</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Valores Calculados -->
    <div class="modal fade" id="modalDesembolsos" tabindex="-1" aria-labelledby="modalDesembolsosLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Valores Calculados del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Título con nombre del proyecto e ID -->
                    <div class="project-title mb-3">
                        <i class="fas fa-building me-2"></i>
                        <span id="titulo-proyecto">Proyecto sin nombre</span>
                        <!-- Guardar id_proyecto oculto -->
                        <input type="hidden" id="idProyectoSeleccionado" name="id_proyecto" value="">
                    </div>

                    <!-- Selector de columnas -->
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-eye me-2"></i>Escoger datos a mostrar</label>
                        <div id="selector-columnas" class="d-flex flex-wrap gap-3"></div>
                    </div>

                    <!-- Sección de valores calculados -->
                    <div class="values-section">
                        <h5 class="mb-3"><i class="fas fa-calculator me-2"></i>Valores Calculados</h5>
                        <table class="summary-table" id="tablaValores">
                            <thead>
                                <tr>
                                    <th>Concepto</th>
                                    <th>Valor</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-col="valor-entregado">
                                    <td>VALOR ENTREGADO</td>
                                    <td id="modal-valor-entregado" class="value-highlight">$ 0</td>
                                </tr>
                                <tr data-col="valor-por-entregar">
                                    <td>VALOR POR ENTREGAR</td>
                                    <td id="modal-valor-por-entregar" class="value-highlight negative-value">$ 0</td>
                                </tr>
                                <tr data-col="a-desembolsar">
                                    <td>A DESEMBOLSAR CONSTRUCTOR (% SOLICITADO)</td>
                                    <td id="modal-a-desembolsar" class="value-highlight">$ 0</td>
                                </tr>
                                <tr data-col="b-desembolsar">
                                    <td>B DESEMBOLSAR CONSTRUCTOR (MÁXIMO %)</td>
                                    <td id="modal-b-desembolsar" class="value-highlight">$ 0</td>
                                </tr>
                                <tr data-col="superavit">
                                    <td>SUPERÁVIT (C)</td>
                                    <td id="modal-superavit" class="value-highlight positive-value">$ 0</td>
                                </tr>
                                <tr data-col="cobertura">
                                    <td>COBERTURA</td>
                                    <td id="modal-cobertura" class="coverage-percentage">0.00%</td>
                                </tr>
                                <tr data-col="maximo-desembolsar">
                                    <td>MÁXIMO A DESEMBOLSAR (POLÍTICA)</td>
                                    <td id="modal-maximo-desembolsar" class="value-highlight">$ 0</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Información adicional -->
                    <div class="filters-info mb-3">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <span class="info-label">Última Actualización:</span>
                                    <span id="modal-fecha-carga">No disponible</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <span class="info-label">Usuario:</span>
                                    <span id="modal-usuario">No disponible</span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <span class="info-label">Requiere Visto Bueno:</span>
                                    <span id="modal-requiere-visto-bueno">No</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Observación -->
                    {% if session.usuario.rol == 'admin' or session.usuario.rol == 'arquitecto' %}
                    <div class="mt-4">
                        <label class="form-label">Observación del Desembolso</label>
                        <textarea class="form-control" id="observacionDesembolso" rows="3"
                            placeholder="Escriba aquí la observación..."></textarea>
                    </div>
                    {% endif %} 
                    <!-- Historial de observaciones -->
                    <div class="mt-4">
                        <h6><i class="fas fa-history me-2"></i>Historial de Observaciones</h6>
                        <div id="historialObservaciones" class="mt-2"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    {% if session.usuario.rol == 'admin' or session.usuario.rol == 'arquitecto' %}
                    <button type="button" class="btn btn-primary" onclick="guardarObservacion()">Guardar
                        Cambios</button>
                    {% endif %}    
                </div>
            </div>
        </div>
    </div>
    <!-- Modal para Gestiones -->
    <div class="modal fade" id="gestionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="gestionModalTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-gestion">
                        <input type="hidden" id="gestion-id">
                        <input type="hidden" id="gestion-tipo">

                        <!-- Contenido dinámico -->
                        <div id="contenido-titular" class="gestion-contenido" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Titular Actual</label>
                                <input type="text" class="form-control" id="actual-titular" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nuevo Titular</label>
                                <input type="text" class="form-control" id="nuevo-titular" required>
                            </div>
                        </div>

                        <div id="contenido-nombre" class="gestion-contenido" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Nombre Actual</label>
                                <input type="text" class="form-control" id="actual-nombre" disabled>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Nuevo Nombre</label>
                                <input type="text" class="form-control" id="nuevo-nombre" required>
                            </div>
                        </div>

                        <div id="contenido-unidades" class="gestion-contenido" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Unidades Actuales</label>
                                    <input type="number" class="form-control" id="actual-unidades" disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nuevo Valor</label>
                                    <input type="number" class="form-control" id="nuevo-unidades" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Tipo de Modificación</label>
                                <select class="form-select" id="tipo-modificacion" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="ajuste">Ajuste de unidades</option>
                                    <option value="ampliacion">Ampliación</option>
                                    <option value="reduccion">Reducción</option>
                                </select>
                            </div>
                        </div>
                        <!-- Contenido para Desistimiento -->
                        <div id="contenido-desistimiento" class="gestion-contenido" style="display:none;">
                            <div class="mb-3">
                                <label class="form-label">Motivo del Desistimiento</label>
                                <textarea class="form-control" id="motivo-desistimiento" rows="3" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Fecha Efectiva</label>
                                <input type="date" class="form-control" id="fecha-desistimiento" required>
                            </div>
                        </div>

                        <!-- Contenido para Ampliación de Monto -->
                        <div id="contenido-monto" class="gestion-contenido" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Monto Actual</label>
                                    <input type="number" class="form-control" id="actual-monto" disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nuevo Monto</label>
                                    <input type="number" class="form-control" id="nuevo-monto" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Justificación</label>
                                <textarea class="form-control" rows="2" required></textarea>
                            </div>
                        </div>

                        <!-- Contenido para Ampliación de Vigencia -->
                        <div id="contenido-vigencia" class="gestion-contenido" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Vigencia Actual</label>
                                    <input type="date" class="form-control" id="actual-vigencia" disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nueva Vigencia</label>
                                    <input type="date" class="form-control" id="nueva-vigencia" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Razón de la Ampliación</label>
                                <textarea class="form-control" rows="2" required></textarea>
                            </div>
                        </div>

                        <!-- Contenido para Ampliación de Plazo -->
                        <div id="contenido-plazo" class="gestion-contenido" style="display:none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Plazo Actual (meses)</label>
                                    <input type="number" class="form-control" id="actual-plazo" disabled>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nuevo Plazo</label>
                                    <input type="number" class="form-control" id="nuevo-plazo" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Explicación del Cambio</label>
                                <textarea class="form-control" rows="2" required></textarea>
                            </div>
                        </div>
                        <!-- Sección común para todas las gestiones -->
                        <div class="mt-4">
                            <label class="form-label">Comentarios</label>
                            <textarea class="form-control" rows="3" placeholder="Justificación de la modificación"
                                required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="guardarGestion()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Historial -->
    <div class="modal fade" id="historialModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Historial del Proyecto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active"
                                data-tipo="ventas">Ventas</button>
                            <button type="button" class="btn btn-outline-primary" data-tipo="visitas">Visitas</button>
                            <button type="button" class="btn btn-outline-primary"
                                data-tipo="desembolsos">Desembolsos</button>
                        </div>
                        <button id="btn-export-pdf" class="btn btn-success float-end">
                            <i class="fas fa-file-pdf me-2"></i>Exportar a PDF
                        </button>
                    </div>

                    <div id="contenido-ventas" class="historial-contenido">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabla-ventas">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N°</th>
                                        <th>Fecha Carga</th>
                                        <th>Usuario</th>
                                        <th>Inicio Ventas</th>
                                        <th>Inmuebles Vendidos</th>
                                        <th>% Ventas (Unidades)</th>
                                        <th>Valor Vendido</th>
                                        <th>Cartera Recaudada</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="contenido-visitas" class="historial-contenido" style="display:none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabla-visitas">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N°</th>
                                        <th>Fecha Visita</th>
                                        <th>Usuario</th>
                                        <!-- <th>N° Visita</th> -->
                                        <th>Avance Obra</th>
                                        <th>% Ejecución</th>
                                        <th>Estado Obra</th>
                                        <th>Alertas</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="contenido-desembolsos" class="historial-contenido" style="display:none;">
                        <div class="table-responsive">
                            <table class="table table-striped" id="tabla-desembolsos">
                                <thead class="table-dark">
                                    <tr>
                                        <th>N°</th>
                                        <th>Fecha</th>
                                        <th>Usuario</th>
                                        <th>Valor Entregado</th>
                                        <th>Valor por Entregar</th>
                                        <th>Cobertura</th>
                                        <th>Superávit</th>
                                        <th>Requiere Visto Bueno</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Footer Estándar Bancolombia -->
    <!-- Footer -->
    <div class="footer">
        <div class="container-aligned">
            <p>© 2025 Bancolombia. Todos los derechos reservados.</p>
            <p>
                <a href="#">Términos y condiciones</a> |
                <a href="#">Política de privacidad</a> |
                <a href="#">Ayuda</a>
            </p>
            <p>
                <i class="fas fa-phone"></i> Línea de atención: 01 8000 912 345 |
                <i class="fas fa-map-marker-alt"></i> Sede principal: Medellín, Colombia
            </p>
        </div>
    </div>

    <!-- Consolidated helpers and unified functions inserted by assistant -->
    <script>
        /* Utilities */
        function safeParseJSON(raw) {
            try { return JSON.parse(raw || '[]'); } catch (e) { console.warn('safeParseJSON failed', e); return []; }
        }
        function normalizarIdProyecto(id) {
            return String(id ?? '').replace(/\s+/g, '').toLowerCase();
        }
        function stripKeyForCompare(k) {
            if (typeof k !== 'string') return '';
            return k.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/\s+/g, '').toUpperCase();
        }
        function findCampoKey(camposObj, possibleKeys) {
            if (!camposObj || typeof camposObj !== 'object') return null;
            const map = {};
            for (const k of Object.keys(camposObj)) {
                map[stripKeyForCompare(k)] = k;
            }
            for (const candidate of (possibleKeys || ['ESTADO EJECUCIÓN OBRA', 'ESTADO OBRA'])) {
                const nk = stripKeyForCompare(candidate);
                if (nk in map) return map[nk];
            }
            return null;
        }
        function getNestedValue(obj, path) {
            if (!obj || !path) return undefined;
            const parts = path.split('.');
            let cur = obj;
            for (const p of parts) {
                if (cur && Object.prototype.hasOwnProperty.call(cur, p)) cur = cur[p];
                else return undefined;
            }
            return cur;
        }

        /* pushVisitaRegistro: insert a visit record preserving metadata */
        function pushVisitaRegistro(proyectoId, usuario, camposEntrada, opciones = {}) {
            try {
                const raw = localStorage.getItem('historialVisitas') || '[]';
                const visitas = Array.isArray(safeParseJSON(raw)) ? safeParseJSON(raw) : [];

                const idStr = normalizarIdProyecto(proyectoId);
                const visitasProyecto = visitas.filter(v => normalizarIdProyecto(v.proyectoId) === idStr);

                const numerosExistentes = visitasProyecto
                    .map(v => {
                        const n = getNestedValue(v, 'campos.NUMERO VISITA.valor');
                        return Number.isFinite(Number(n)) ? Number(n) : null;
                    })
                    .filter(n => n !== null);
                const maxExistente = numerosExistentes.length ? Math.max(...numerosExistentes) : 0;
                const numeroSiguiente = maxExistente + 1;

                let primerCargue = null;
                if (visitasProyecto.length) {
                    const ordenadas = visitasProyecto.slice().sort((a, b) => new Date(a.fechaCarga || a.fecha || 0) - new Date(b.fechaCarga || b.fecha || 0));
                    primerCargue = ordenadas[0];
                }

                const entrada = camposEntrada || {};
                const camposNormalized = {};
                for (const key of Object.keys(entrada)) {
                    const val = entrada[key];
                    if (val && typeof val === 'object' && ('valor' in val)) {
                        camposNormalized[key] = Object.assign({}, val);
                    } else {
                        const tipoInferido = (typeof val === 'number') ? 'entero' : 'texto';
                        camposNormalized[key] = { valor: val, tipo: tipoInferido, fuente: 'directo' };
                    }
                }

                const nowIso = new Date().toISOString();
                const fechaVisitaIso = opciones.fechaVisitaOverride ? new Date(opciones.fechaVisitaOverride).toISOString() : nowIso;

                // FECHA VISITA
                if (!camposNormalized['FECHA VISITA']) {
                    camposNormalized['FECHA VISITA'] = { valor: fechaVisitaIso, tipo: 'fecha', fuente: 'sistema' };
                } else {
                    camposNormalized['FECHA VISITA'].valor = fechaVisitaIso;
                    camposNormalized['FECHA VISITA'].tipo = camposNormalized['FECHA VISITA'].tipo || 'fecha';
                }

                // NUMERO VISITA
                if (!camposNormalized['NUMERO VISITA']) {
                    camposNormalized['NUMERO VISITA'] = { valor: numeroSiguiente, tipo: 'entero', fuente: 'sistema' };
                } else {
                    camposNormalized['NUMERO VISITA'].valor = numeroSiguiente;
                    camposNormalized['NUMERO VISITA'].tipo = camposNormalized['NUMERO VISITA'].tipo || 'entero';
                }

                // AVANCE OBRA
                if (typeof opciones.avanceOverride !== 'undefined') {
                    if (!camposNormalized['AVANCE OBRA']) {
                        camposNormalized['AVANCE OBRA'] = { valor: opciones.avanceOverride, tipo: 'porcentaje', fuente: 'directo' };
                    } else {
                        camposNormalized['AVANCE OBRA'].valor = opciones.avanceOverride;
                        camposNormalized['AVANCE OBRA'].tipo = camposNormalized['AVANCE OBRA'].tipo || 'porcentaje';
                        camposNormalized['AVANCE OBRA'].fuente = camposNormalized['AVANCE OBRA'].fuente || 'directo';
                    }
                }

                // ESTADO EJECUCIÓN OBRA
                if (typeof opciones.estadoOverride !== 'undefined') {
                    const kExist = findCampoKey(camposNormalized, ['ESTADO EJECUCIÓN OBRA', 'ESTADO OBRA']);
                    if (!kExist) {
                        camposNormalized['ESTADO EJECUCIÓN OBRA'] = { valor: opciones.estadoOverride, tipo: 'texto', fuente: 'directo' };
                    } else {
                        camposNormalized[kExist].valor = opciones.estadoOverride;
                        camposNormalized[kExist].tipo = camposNormalized[kExist].tipo || 'texto';
                        camposNormalized[kExist].fuente = camposNormalized[kExist].fuente || 'directo';
                    }
                }

                const nuevoRegistro = {
                    proyectoId: String(proyectoId),
                    campos: camposNormalized,
                    usuario: usuario || (window?.SESSION_USUARIO || 'Sistema'),
                    fechaCarga: nowIso
                };

                visitas.push(nuevoRegistro);
                localStorage.setItem('historialVisitas', JSON.stringify(visitas));

                const keyEstadoEncontrada = findCampoKey(camposNormalized, ['ESTADO EJECUCIÓN OBRA', 'ESTADO OBRA']);
                const estadoValor = keyEstadoEncontrada ? (camposNormalized[keyEstadoEncontrada]?.valor) : undefined;

                console.log('pushVisitaRegistro -> registro agregado', { nuevoRegistro, primerCargue, numeroSiguiente, estadoValor });
                return { nuevoRegistro, primerCargue, numeroSiguiente, estadoValor };
            } catch (err) {
                console.error('pushVisitaRegistro error:', err);
                return null;
            }
        }

        /* buildExportPayload: ensure exact key "ESTADO EJECUCIÓN OBRA" with full metadata and remove variants */
        function buildExportPayload(proyectosLocal) {
            const payload = JSON.parse(JSON.stringify(proyectosLocal || []));
            const historial = Array.isArray(safeParseJSON(localStorage.getItem('historialVisitas') || '[]')) ? safeParseJSON(localStorage.getItem('historialVisitas') || '[]') : [];
            const norm = id => String(id ?? '').replace(/\s+/g, '').toLowerCase();

            for (const p of payload) {
                try {
                    delete p['estado_ejecución_obra'];
                    delete p['estado_ejecucion_obra'];
                    delete p['estadoEjecucionObra'];

                    const visitas = historial.filter(v => norm(v.proyectoId) === norm(p.id_proyecto || p.proyectoId || p.id));
                    let estadoCampoObj = null;
                    if (visitas.length) {
                        const ult = visitas.slice().sort((a, b) => new Date(b.fechaCarga || b.fecha || 0) - new Date(a.fechaCarga || a.fecha || 0))[0];
                        const k = findCampoKey(ult.campos || {});
                        if (k) estadoCampoObj = ult.campos[k];
                    }
                    if (!estadoCampoObj && typeof p.estado !== 'undefined' && p.estado !== null) {
                        estadoCampoObj = { valor: p.estado, tipo: 'texto', fuente: 'directo' };
                    }
                    if (estadoCampoObj) {
                        p['ESTADO EJECUCIÓN OBRA'] = estadoCampoObj;
                    }
                } catch (err) {
                    console.warn('buildExportPayload error for', p?.id_proyecto || p?.proyectoId, err);
                }
            }
            return payload;
        }

        /* guardarCambios: unified and robust */
        async function guardarCambios() {
            try {
                const proyectos = Array.isArray(safeParseJSON(localStorage.getItem('proyectos') || '[]')) ? safeParseJSON(localStorage.getItem('proyectos') || '[]') : [];
                const id = String(document.getElementById('edit-id')?.value || '').trim();
                if (!id) throw new Error('ID de proyecto no encontrado');

                const idx = proyectos.findIndex(p => normalizarIdProyecto(p.id_proyecto) === normalizarIdProyecto(id));
                if (idx === -1) throw new Error('Proyecto no existe en los registros');

                const form = document.getElementById('form-editar');
                if (!form) throw new Error('Formulario no encontrado');

                let avanceVal = parseFloat(form.querySelector('#edit-avance')?.value);
                if (isNaN(avanceVal)) avanceVal = proyectos[idx].avance ?? proyectos[idx].avanceObra ?? null;
                if (typeof avanceVal === 'number') avanceVal = Math.min(Math.max(Math.round(avanceVal * 100) / 100, 0), 100);

                let nuevoEstado = proyectos[idx].estado || proyectos[idx].estadoEjecucion || 'sin definir';
                if (typeof avanceVal === 'number' && avanceVal >= 98) nuevoEstado = 'en escrituración';

                const updated = {
                    ...proyectos[idx],
                    avance: avanceVal,
                    avanceObra: avanceVal,
                    ultimaModificacion: new Date().toISOString(),
                    usuarioModificacion: typeof USUARIO_NOMBRE !== 'undefined' ? USUARIO_NOMBRE : (window?.SESSION_USUARIO || 'Sistema')
                };
                proyectos[idx] = updated;
                localStorage.setItem('proyectos', JSON.stringify(proyectos));

                const historialRaw = Array.isArray(safeParseJSON(localStorage.getItem('historialVisitas') || '[]')) ? safeParseJSON(localStorage.getItem('historialVisitas') || '[]') : [];
                const visitasProyecto = (historialRaw || []).filter(v => normalizarIdProyecto(v.proyectoId) === normalizarIdProyecto(id));
                let camposBase = {};
                if (visitasProyecto.length) {
                    const ordenadas = visitasProyecto.slice().sort((a, b) => new Date(a.fechaCarga || a.fecha || 0) - new Date(b.fechaCarga || b.fecha || 0));
                    camposBase = ordenadas[0].campos || {};
                } else {
                    camposBase = { 'ID PROYECTO': { valor: updated.id_proyecto || id, tipo: 'entero', fuente: 'directo' } };
                }

                const usuario = updated.usuarioModificacion || window?.SESSION_USUARIO || 'Sistema';
                const resultado = pushVisitaRegistro(id, usuario, camposBase, {
                    fechaVisitaOverride: new Date().toISOString(),
                    avanceOverride: typeof avanceVal === 'number' ? avanceVal : undefined,
                    estadoOverride: nuevoEstado
                });

                if (resultado && resultado.nuevoRegistro) {
                    const estadoValor = resultado.estadoValor;
                    if (typeof estadoValor !== 'undefined' && estadoValor !== null) {
                        proyectos[idx].estado = estadoValor;
                        localStorage.setItem('proyectos', JSON.stringify(proyectos));
                    } else {
                        console.warn('guardarCambios: no se encontro valor para ESTADO EJECUCIÓN OBRA en el registro creado.');
                    }
                }

                // Regenerar Excel principal usando payload normalizado
                try {
                    const exportPayload = buildExportPayload(proyectos);
                    const resp = await fetch('/exportar_excel', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ proyectos: exportPayload })
                    });
                    if (resp.ok) {
                        const data = await resp.json().catch(() => null);
                        console.log('Excel regenerado en backend:', data || 'OK');
                    } else {
                        console.warn('Exportar Excel fallo. status:', resp.status);
                    }
                } catch (err) {
                    console.error('Error exportando Excel:', err);
                }

                // refrescar UI y cerrar modal
                if (typeof cargarProyectos === 'function') {
                    try { cargarProyectos({}); } catch (e) { console.warn('cargarProyectos fallo', e); }
                }
                const modalEl = document.getElementById('editarModal');
                if (modalEl && bootstrap && bootstrap.Modal) {
                    try { bootstrap.Modal.getInstance(modalEl)?.hide(); } catch (e) { }
                }

                if (typeof Swal !== 'undefined') {
                    Swal.fire({ icon: 'success', title: '¡Guardado!', text: 'Cambios actualizados correctamente y Excel regenerado', timer: 1500 });
                } else {
                    console.log('Guardado OK');
                }

            } catch (error) {
                console.error('Error al guardar:', error);
                if (typeof Swal !== 'undefined') {
                    Swal.fire({ icon: 'error', title: 'Error', text: error.message || 'No se pudieron guardar los cambios' });
                } else {
                    alert(error.message || 'No se pudieron guardar los cambios');
                }
            }
        }

        // Crear checkboxes para elegir qué filas mostrar
        document.addEventListener("DOMContentLoaded", () => {
            const filas = document.querySelectorAll("#tablaValores tbody tr");
            const selector = document.getElementById("selector-columnas");

            filas.forEach((fila, i) => {
                const concepto = fila.querySelector("td").innerText;
                const id = "chk_fila_" + i;
                const wrapper = document.createElement("div");
                wrapper.innerHTML = `
        <input type="checkbox" id="${id}" data-index="${i}" checked>
        <label for="${id}">${concepto}</label>
      `;
                selector.appendChild(wrapper);

                wrapper.querySelector("input").addEventListener("change", (e) => {
                    fila.style.display = e.target.checked ? "" : "none";
                });
            });
        });

        // Inyectar usuario de sesión desde Flask
        const usuarioSesion = "{{ session['usuario']['nombre'] if 'usuario' in session else '' }}";

        // Guardar observación
        function guardarObservacion() {
        let idProyecto = document.getElementById("idProyectoSeleccionado")?.value?.trim();
        if (!idProyecto) {
            const idInput = document.getElementById("id_proyecto");
            if (idInput) idProyecto = idInput.value.trim();
        }

        const observacion = document.getElementById("observacionDesembolso").value.trim();

        if (!idProyecto) {
            Swal.fire("Atención", "No se encontró el ID del proyecto", "warning");
            return;
        }
        if (!observacion) {
            Swal.fire("Atención", "Debe ingresar una observación", "warning");
            return;
        }
        if (!usuarioSesion) {
            Swal.fire("Atención", "No se encontró el usuario en sesión", "warning");
            return;
        }

        fetch("/guardar_observacion", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
            id_proyecto: idProyecto, 
            observacion: observacion,
            usuario: usuarioSesion
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
            // Guardar también en localStorage
            guardarHistorialLocal(idProyecto, observacion, usuarioSesion);

            Swal.fire("Éxito", data.message, "success");
            document.getElementById("observacionDesembolso").value = "";
            mostrarHistorial(idProyecto); // refrescar historial en modal
            } else {
            Swal.fire("Error", data.message || "No se pudo guardar la observación", "error");
            }
        })
        .catch(err => {
            Swal.fire("Error", "No se pudo guardar la observación", "error");
        });
        }

        // Guardar historial en localStorage
        function guardarHistorialLocal(idProyecto, observacion, usuario) {
        const fecha = new Date().toLocaleDateString("es-CO");
        const clave = "observaciones_" + idProyecto;
        let historial = JSON.parse(localStorage.getItem(clave) || "[]");

        historial.push({
            observacion: observacion,
            usuario: usuario,
            fecha: fecha
        });

        localStorage.setItem(clave, JSON.stringify(historial));
        }

        // Mostrar historial en el modal
        function mostrarHistorial(idProyecto) {
        const clave = "observaciones_" + idProyecto;
        const historial = JSON.parse(localStorage.getItem(clave) || "[]");

        const contenedor = document.getElementById("historialObservaciones");
        contenedor.innerHTML = "";

        if (historial.length === 0) {
            contenedor.innerHTML = "<p class='text-muted'>No hay observaciones previas</p>";
            return;
        }

        const lista = document.createElement("ul");
        lista.classList.add("list-group");

        historial.forEach(obs => {
            const item = document.createElement("li");
            item.classList.add("list-group-item");
            item.innerHTML = `<b>${obs.fecha}</b> - ${obs.usuario}: ${obs.observacion}`;
            lista.appendChild(item);
        });

        contenedor.appendChild(lista);
        }
        
    </script>
    <!-- End consolidated script -->
</body>

</html>