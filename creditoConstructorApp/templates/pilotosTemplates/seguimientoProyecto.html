<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Proyectos - Bancolombia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bancolombia-blue: #004884;
            --bancolombia-green: #00A859;
            --bancolombia-orange: #FF6B00;
            --bancolombia-gray: #F5F5F5;
            --bancolombia-red: #df0013; 
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bancolombia-gray);
            color: var(--bancolombia-dark-gray);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .header {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 10px 0;
            margin-bottom: 20px;
        }
        
        .logo-container {
            text-align: center;
            padding: 10px 0;
            margin: 0 auto;
            max-width: 1200px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-container img {
            height: 50px;
            width: auto;
        }
        
        .breadcrumb {
            background-color: transparent;
            padding: 0;
            margin: 0;
            font-size: 0.9rem;
        }
        
        .breadcrumb-item.active {
            color: var(--bancolombia-blue);
            font-weight: 600;
        }
        
        .module-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 20px 0;
        }
        
        .module-title {
            color: var(--bancolombia-blue);
            font-weight: 700;
            margin-bottom: 30px;
            text-align: center;
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .module-title i {
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .module-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: none;
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        
        .module-card .card-header {
            background-color: var(--bancolombia-light-blue);
            color: white;
            font-size: 1.2rem;
            padding: 15px;
            font-weight: 600;
        }
        
        .module-card .card-body {
            padding: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .module-card .card-list {
            text-align: left;
            margin-bottom: 20px;
            flex: 1;
        }
        
        .module-card .card-list-item {
            margin-bottom: 10px;
            padding-left: 25px;
            position: relative;
        }
        
        .module-card .card-list-item:before {
            content: "•";
            color: var(--bancolombia-light-blue);
            font-weight: bold;
            position: absolute;
            left: 10px;
        }
        
        .module-card .btn-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .btn-danger {
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .module-card .btn {
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: 600;
            min-width: 100px;
        }
        
        .btn-primary {
            background-color: var(--bancolombia-blue);
        }
        
        .btn-success {
            background-color: var(--bancolombia-green);
        }
        
        .btn-warning {
            background-color: var(--bancolombia-orange);
        }
        
        .btn-danger {
            background-color: var(--bancolombia-red);
        }
        
        .footer {
            background-color: var(--bancolombia-blue);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 0.9rem;
            margin-top: 40px;
            position: sticky;
            top: 100%;
        }

        
        .user-info {
            text-align: right;
            padding: 10px 20px;
            background-color: var(--bancolombia-gray);
            color: var(--bancolombia-dark-gray);
            font-size: 0.9rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .container-aligned {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            width: 100%;
        }

        .seguimiento-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 25px;
            margin: 20px 0;
        }

        .seguimiento-card {
            border-left: 4px solid var(--bancolombia-blue);
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .seguimiento-card:hover {
            transform: translateX(10px);
        }

        .estado-badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 15px;
        }

        .btn-seguimiento {
            background-color: var(--bancolombia-blue);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
        }

        .btn-seguimiento:hover {
            background-color: #0066CC;
        }

        .nav-seguimiento {
            border-bottom: 2px solid var(--bancolombia-gray);
            margin-bottom: 20px;
        }

        .nav-link.active {
            color: var(--bancolombia-blue) !important;
            border-bottom: 3px solid var(--bancolombia-blue);
        }

        .formulario-seguimiento {
            background: var(--bancolombia-gray);
            border-radius: 10px;
            padding: 20px;
        }
        .error-mensaje {
            color: #dc3545;
            font-size: 0.875em;
            display: none;
        }

        .campo-invalido {
            border-color: #dc3545 !important;
        }

        .modal-confirmacion {
            background: rgba(0,0,0,0.4);
        }
        .estado-proyecto {
            font-size: 0.9rem;
            padding: 5px 15px;
            border-radius: 20px;
        }
        
        .activo { background: #d4edda; color: #155724; }
        .en-revision { background: #fff3cd; color: #856404; }
        .desistido { background: #f8d7da; color: #721c24; }
        .completado { background: #d1ecf1; color: #0c5460; }

        .timeline {
        position: relative;
        padding-left: 30px;
        margin: 20px 0;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            height: 100%;
            width: 2px;
            background: var(--bancolombia-blue);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 30px;
            padding-left: 30px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -4px;
            top: 5px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--bancolombia-blue);
            border: 3px solid white;
        }

        .timeline-date {
            font-weight: 600;
            color: var(--bancolombia-blue);
            margin-bottom: 5px;
        }

        .timeline-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        /* Para el selector de proyectos */
        #filtroProyecto, #selectorProyecto {
            border: 2px solid var(--bancolombia-blue);
            border-radius: 8px;
            padding: 0.75rem;
            transition: all 0.3s ease;
        }

        #filtroProyecto:hover, #selectorProyecto:hover {
            border-color: var(--bancolombia-light-blue);
            box-shadow: 0 0 8px rgba(0,104,255,0.1);
        }
        .modal-confirmacion .modal-header {
            background: var(--bancolombia-orange);
        }

        .modal-confirmacion .modal-title {
            color: white;
        }

        #confirmActionBtn {
            background: var(--bancolombia-orange);
            border: none;
        }

        #confirmActionBtn:hover {
            background: #ff8b33;
        }
        /* Reemplaza el CSS anterior por este */
        .btn-action {
            transform: scale(1);
            transition: all 0.3s ease;
            opacity: 0.8;
            margin: 0 3px;
            transform-origin: center;
        }

        .btn-action:hover {
            transform: scale(1.15);
            opacity: 1;
            z-index: 2;
        }

        .btn-action i {
            transition: transform 0.2s ease;
        }

        .btn-action:hover i {
            transform: scale(1.1);
        }
        .modal-content {
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.2);
        }
    </style>
    <link rel="shortcut icon" href="{{ url_for('static', filename='LogoBancolombia.ico') }}">
</head>
<body>
     <!-- Header con logo y usuario -->
     <div class="header">
        <div class="container-aligned">
            <div class="user-info">
                <span class="role-badge me-3">{{ session.usuario.rol | title }}</span>
                <i class="fas fa-user-circle"></i> {{ session.usuario.nombre }}
                | <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Cerrar sesión</a>
            </div>
            <div class="logo-container">
                <img src="https://www.uam.edu.co/wp-content/uploads/2022/09/logo-bancolombia1.png" 
                     alt="Bancolombia">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('menu_principal') }}"><i class="fas fa-home"></i> Menú Principal</a></li>
                        <li class="breadcrumb-item active" aria-current="page"><i class="fas fa-user-tie"></i> Módulo Pilotos</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

     <!-- Contenido principal (envuelto) -->
     <div class="contenido-principal">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <a href="{{ url_for('modulo_pilotos') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </a>
            </div>

            <div class="card mb-4 shadow">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Proyecto a Seguir</h5>
                        </div>
                        <div class="col-md-8">
                            <select class="form-select" id="selectorProyecto" onchange="cargarSeguimientos()">
                                <option value="">Seleccione un proyecto...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="container mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-clipboard-list me-2"></i>Seguimiento de Proyectos</h2>
                    <button class="btn btn-seguimiento" onclick="mostrarFormulario()">
                        <i class="fas fa-plus me-2"></i>Nuevo Seguimiento
                    </button>
                </div>

                <!-- Listado de Seguimientos -->
                <div class="seguimiento-container">
                    <nav class="nav nav-seguimiento">
                        <a class="nav-link active" href="#">Todos</a>
                        <a class="nav-link" href="#">Pendientes</a>
                        <a class="nav-link" href="#">Completados</a>
                    </nav>
                    <div id="listado-seguimientos">
                        <!-- Dinámico -->
                    </div>
                </div>

                <!-- Formulario Nuevo Seguimiento -->
                <div class="seguimiento-container formulario-seguimiento" id="formulario" style="display: none;">
                    <h4><i class="fas fa-file-alt me-2"></i>Nuevo Registro</h4>
                    <form id="form-nuevo-seguimiento">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Título</label>
                                <input type="text" class="form-control" id="titulo" required>
                                <span class="error-mensaje"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Tipo</label>
                                <select class="form-select" id="tipo" required>
                                    <option value="avance">Avance de Obra</option>
                                    <option value="desembolso">Desembolso</option>
                                    <option value="informe">Informe de Ventas</option>
                                    <option value="modificacion">Modificación</option>
                                </select>
                                <span class="error-mensaje"></span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Fecha</label>
                                <input type="date" class="form-control" id="fecha" required>
                                <span class="error-mensaje"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Estado</label>
                                <select class="form-select" id="estado" required>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="completado">Completado</option>
                                    <option value="revision">En Revisión</option>
                                </select>
                                <span class="error-mensaje"></span>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>Contenido</label>
                            <textarea class="form-control" rows="4" id="contenido" required></textarea>
                            <span class="error-mensaje"></span>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="ocultarFormulario()">Cancelar</button>
                            <button type="submit" class="btn btn-seguimiento">Guardar</button>
                        </div>
                    </form>
                </div>

                <!-- Botones de carga -->
                <button class="btn btn-seguimiento" onclick="mostrarFormCargaVentas()" style="margin-left: 10px;">
                    <i class="fas fa-cash-register me-2"></i>Cargar Ventas
                </button>
                <button class="btn btn-seguimiento" onclick="mostrarFormCargaVisitas()" style="margin-left: 10px;">
                    <i class="fas fa-calendar-check me-2"></i>Cargar Visitas
                </button>
                <button class="btn btn-seguimiento" onclick="mostrarFormCargaDesembolsos()" style="margin-left: 10px;">
                    <i class="fas fa-money-bill-wave me-2"></i>Cargar Desembolsos
                </button>

                <!-- Formularios de carga -->
                <div class="seguimiento-container formulario-seguimiento" id="formCargaVentas" style="display: none;">
                    <h4><i class="fas fa-cash-register me-2"></i>Cargar Informe de Ventas</h4>
                    <form id="form-carga-ventas">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Seleccionar archivo Excel</label>
                                <input type="file" class="form-control" id="archivoVentas" accept=".xlsx, .xlsm" required>
                                <small class="form-text text-muted">Se aceptan archivos con macros (.xlsm)</small>
                                <span class="error-mensaje"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Responsable de carga</label>
                                <input type="text" id="responsable-input" class="form-control" value="{{ session.usuario.nombre }}" readonly>
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <strong>Validaciones requeridas:</strong>
                            <ul>
                                <li>El archivo debe contener la hoja 'Resumen'</li>
                            </ul>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="ocultarFormCargaVentas()">Cancelar</button>
                            <button type="button" class="btn btn-seguimiento" onclick="procesarArchivo()">Procesar</button>
                        </div>
                    </form>
                </div>

                <div class="seguimiento-container formulario-seguimiento" id="formCargaVisitas" style="display: none;">
                    <h4><i class="fas fa-calendar-check me-2"></i>Cargar Informe de Visitas</h4>
                    <form id="form-carga-visitas">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Seleccionar archivo Excel</label>
                                <input type="file" class="form-control" id="archivoVisitas" accept=".xlsx, .xlsm" required>
                                <small class="form-text text-muted">Se aceptan archivos con macros (.xlsm)</small>
                                <span class="error-mensaje"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Responsable de carga</label>
                                <input type="text" id="responsable-input" class="form-control" value="{{ session.usuario.nombre }}" readonly>
                            </div>
                        </div>
                        <div class="alert alert-warning">
                            <strong>Validaciones requeridas:</strong>
                            <ul>
                                <li>Debe contener: ID PROYECTO, NOMBRE DEL PROYECTO, VALOR COSTOS FINANCIABLES, NOMBRE DEL PERITO</li>
                            </ul>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="ocultarFormCargaVisitas()">Cancelar</button>
                            <button type="button" class="btn btn-seguimiento" onclick="procesarArchivoVisitas()">Procesar</button>
                        </div>
                    </form>
                </div>

                <div class="seguimiento-container formulario-seguimiento" id="formCargaDesembolsos" style="display: none;">
                    <h4><i class="fas fa-money-bill-wave me-2"></i>Cargar Desembolsos</h4>
                    <form id="form-carga-desembolsos">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Responsable de carga</label>
                                <input type="text" id="responsable-input" class="form-control" value="{{ session.usuario.nombre }}" readonly>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="ocultarFormCargaDesembolsos()">Cancelar</button>
                            <button type="button" class="btn btn-seguimiento" onclick="procesarDesembolsos()">Procesar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <div class="container-aligned">
            <p>© 2025 Bancolombia. Todos los derechos reservados.</p>
            <p>
                <a href="#">Términos y condiciones</a> | 
                <a href="#">Política de privacidad</a> | 
                <a href="#">Ayuda</a>
            </p>
            <p>
                <i class="fas fa-phone"></i> Línea de atención: 01 8000 912 345 | 
                <i class="fas fa-map-marker-alt"></i> Sede principal: Medellín, Colombia
            </p>
        </div>
    </div>
    <!-- Modal de Carga -->
    <div class="modal fade" id="modalCarga" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <h5 class="mb-2">Procesando archivo...</h5>
            <div class="progress w-100 mb-2">
            <div id="barraProgreso" class="progress-bar progress-bar-striped progress-bar-animated" 
                role="progressbar" style="width: 0%">0%</div>
            </div>
            <small class="text-muted">Esto puede tardar unos segundos. Por favor no cierre la ventana.</small>
        </div>
        </div>
    </div>  
    <!-- Modal de Confirmación -->
       <div class="modal fade modal-confirmacion" id="confirmModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Confirmar Datos de la Venta</h5>
                </div>
                <div class="modal-body" id="confirmModalBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtn">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Confirmación para Visitas -->
    <div class="modal fade modal-confirmacion" id="confirmModalVisitas">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>Confirmar Datos de la Visita
                    </h5>
                </div>
                <div class="modal-body" id="confirmModalVisitasBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmActionBtnVisitas">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Confirmación para Desembolsos -->
    <div class="modal fade" id="confirmModalDesembolsos" tabindex="-1" aria-labelledby="confirmModalDesembolsosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="confirmModalDesembolsosLabel">Confirmar Valores de Desembolsos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="confirmModalDesembolsosBody">
                    <!-- Contenido dinámico se insertará aquí -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmActionBtnDesembolsos">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Error -->
    <div class="modal fade" id="errorModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="errorMensaje"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
        <div id="error-general" class="alert alert-danger d-none mb-3"></div>
    </div>
    <!-- Modal de Edición -->
    <div class="modal fade" id="modalEdicion" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Editar Seguimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="form-editar-seguimiento">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Título</label>
                                <input type="text" class="form-control" id="editar-titulo" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Tipo</label>
                                <select class="form-select" id="editar-tipo" required>
                                    <option value="avance">Avance de Obra</option>
                                    <option value="desembolso">Desembolso</option>
                                    <option value="informe">Informe de Ventas</option>
                                    <option value="modificacion">Modificación</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label>Fecha</label>
                                <input type="date" class="form-control" id="editar-fecha" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Estado</label>
                                <select class="form-select" id="editar-estado" required>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="completado">Completado</option>
                                    <option value="revision">En Revisión</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>Contenido</label>
                            <textarea class="form-control" rows="4" id="editar-contenido" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        let seguimientos = JSON.parse(localStorage.getItem('seguimientos')) || [];
        let editandoIndex = -1;
        // Mapeo completo de campos para ambos formatos
        const mapeoCamposVisitas = {
            // Campos comunes (compartidos entre ambos formatos)
            "ID PROYECTO": {
                nuevo: "C13",
                viejo: "C3",
                tipo: "entero"
            },
            "REGIONAL": {
                nuevo: "P21",
                viejo: "E3",
                tipo: "texto"
            },
            "NUMERO VISITA": {
                nuevo: "C9",
                viejo: "E4",
                tipo: "entero"
            },
            "FECHA VISITA": {
                nuevo: "C7",
                viejo: "I4",
                tipo: "fecha"
            },
            "COSTOS FINANCIABLES": {
                nuevo: "H37",
                viejo: "H14",
                tipo: "moneda"
            },
            "PORCENTAJE SOLICITADO FINANCIABLES": {
                nuevo: "H49",
                viejo: "K14",
                tipo: "porcentaje"
            },
            "VALOR ANTICIPOS": {
                nuevo: "C117",
                viejo: "K25",
                tipo: "moneda"
            },
            "VALOR ANTICIPOS ALMACEN": {
                nuevo: "C115",
                viejo: "K26",
                tipo: "moneda"
            },
            "PROGRAMACION INICIAL": {
                nuevo: "H55",
                viejo: "J30",
                tipo: "entero"
            },
            "MES INICIO OBRA": {
                nuevo: "C55",
                viejo: "I31",
                tipo: "fecha"
            },
            "AVANCE OBRA MESES": {
                nuevo: "B82",
                viejo: "J32",
                tipo: "entero"
            },
            "AVANCE ESPERADO PORCENTAJE": {
                nuevo: "P65",
                viejo: "L32",
                tipo: "porcentaje"
            },
            "AVANCE OBRA": {
                nuevo: "P63",
                viejo: "F66",
                tipo: "porcentaje"
            },
            "VALOR TOTAL PROYECTO": {
                nuevo: "C35",
                viejo: "B69",
                tipo: "moneda"
            },
            "INVERSION DEL PROYECTO": {
                nuevo: "C113",
                viejo: "E69",
                tipo: "moneda"
            },

            "VALOR LOTE": {
                nuevo: "C43",
                viejo: "B70",
                tipo: "moneda"
            },

            "TIPO INMUEBLE": {
                nuevo: "F21",
                viejo: "C4",
                tipo: "texto"
            },
            "NUMERO DE INMUEBLES": {
                nuevo: "C21",
                viejo: "B4",
                tipo: "entero"
            },

            "VALOR GARANTIA": {
                nuevo: {
                    logica: (hoja) => {
                        const valorLote = hoja['C43']?.v || 0;
                        const inversionProyecto = hoja['C113']?.v || 0;
                        return parseFloat(valorLote) + parseFloat(inversionProyecto);
                    }
                },
                viejo: "E71",
                tipo: "moneda"
            },

            // Campos exclusivos del NUEVO formato
            "PROMEDIO SPI TRIMESTRE": {
                nuevo: "B72",
                tipo: "decimal"
            },
            
            "SPI AL CORTE": {
                nuevo: "R65",
                tipo: "decimal"
            },
            "ALERTA EN PROGRAMACIÓN": {
                nuevo: "B77",
                tipo: "texto"
            },
            "ESTADO EJECUCIÓN OBRA": {
                nuevo: "Q87",
                tipo: "texto"
            },
            "CPI AL CORTE": {
                nuevo: "R92",
                tipo: "decimal"
            },
            "IMPREVISTOS USADOS A LA FECHA": {
                nuevo: "J109",
                tipo: "porcentaje"
            },
            "ALERTA IMPREVISTOS USADOS A LA FECHA": {
                nuevo: "J111",
                tipo: "texto"
            },
            "ALERTA IMPREVISTOS USADOS VS PROGRAMACIÓN": {
                nuevo: "J113",
                tipo: "texto"
            },
            "ALERTA EJECUTADO VS INVERTIDO": {
                nuevo: "J119",
                tipo: "texto"
            },
            "RESUMEN ALERTA DEL PROYECTO": {
                nuevo: "M125",
                tipo: "texto"
            },
            "ESTADO EJECUCIÓN OBRA MENSUAL": {
                nuevo: "Q117",
                tipo: "texto"
            },
            "CONSUMIDO A LA FECHA": {
                nuevo: "C111",
                tipo: "moneda"
            },
            "IMPREVISTOS Y REAJUSTES USADOS": {
                nuevo: "C125",
                tipo: "moneda"
            },
            "INDIRECTOS INVERTIDOS A LA FECHA": {
                nuevo: "C135",
                tipo: "moneda"
            },
            "INDIRECTOS INVERTIDOS EN %": {
                nuevo: "C137",
                tipo: "porcentaje"
            },
            "HONORARIOS INVERTIDOS A LA FECHA": {
                nuevo: "H135",
                tipo: "moneda"
            },
            "HONORARIOS INVERTIDOS EN %": {
                nuevo: "H137",
                tipo: "porcentaje"
            },
            "ALERTA CONSUMO INDIRECTOS VS PROGRAMACION": {
                nuevo: "C141",
                tipo: "texto"
            },
            "ALERTA CONSUMO HONORARIOS VS PROGRAMACION": {
                nuevo: "H141",
                tipo: "texto"
            },
            "ALERTA INDIRECTOS VS PRESUPUESTO": {
                nuevo: "C143",
                tipo: "texto"
            },
            "ALERTA HONORARIOS VS PRESUPUESTO": {
                nuevo: "H143",
                tipo: "texto"
            },
            "AVANCE OBRA VS AVANCE CI HONORARIOS (CD)": {
                nuevo: "R139",
                tipo: "porcentaje"
            },
            "AVANCE OBRA VS AVANCE CI HONORARIOS (CI+H)": {
                nuevo: "R141",
                tipo: "porcentaje"
            },
            "PROGRAMACION ACTUAL": {
                nuevo: {
                    logica: (hoja) => hoja['L55']?.v || hoja['H55']?.v
                },
                tipo: "entero"
            },
            "MES TERMINACION ACTUAL": {
                nuevo: {
                    logica: (hoja) => hoja['P53']?.v || hoja['F55']?.v
                },
                tipo: "fecha"
            },

            // Campos exclusivos del VIEJO formato
            "VALLA": {
                viejo: "N/A",
                tipo: "texto"
            }
        };
    
        const form = document.getElementById('form-nuevo-seguimiento');
        const campos = {
            titulo: document.getElementById('titulo'),
            tipo: document.getElementById('tipo'),
            fecha: document.getElementById('fecha'),
            estado: document.getElementById('estado'),
            contenido: document.getElementById('contenido')
        };
    
        Object.values(campos).forEach(campo => {
            campo.addEventListener('input', () => validarCampo(campo));
        });
    
        function validarCampo(campo) {
            const valor = campo.value.trim();
            const error = campo.nextElementSibling;
    
            if (!valor) {
                campo.classList.add('campo-invalido');
                error.textContent = 'Este campo es requerido';
                error.style.display = 'block';
                return false;
            }
    
            if (campo.type === 'date' && new Date(valor) > new Date()) {
                campo.classList.add('campo-invalido');
                error.textContent = 'La fecha no puede ser futura';
                error.style.display = 'block';
                return false;
            }
    
            campo.classList.remove('campo-invalido');
            error.textContent = '';
            error.style.display = 'none';
            return true;
        }
    
        function validarFormulario() {
            return Object.values(campos).every(validarCampo);
        }
    
        document.addEventListener('DOMContentLoaded', () => {
            cargarProyectosEnSelector();
            renderSeguimientos();
        });
    
        // Función corregida cargarProyectosEnSelector
        function cargarProyectosEnSelector() {
            const selector = document.getElementById('selectorProyecto');
            selector.innerHTML = '<option value="">Seleccione un proyecto...</option>';
            const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];

            proyectos.forEach(proyecto => {
                // Validar estructura del proyecto
                if (!proyecto.id_proyecto || !proyecto.nombre_proyecto) {
                    console.error("Proyecto inválido:", proyecto);
                    return;
                }

                const option = document.createElement('option');
                option.value = proyecto.id_proyecto;
                option.textContent = proyecto.nombre_proyecto; // Usar nombre_proyecto
                option.dataset.totalUnidades = proyecto.total_inmuebles || 0;
                selector.appendChild(option);
            });
        }
    
        function mostrarFormulario(editar = false, index = -1) {
            form.reset();
            editandoIndex = index;
    
            if (editar) {
                const seg = seguimientos[index];
                campos.titulo.value = seg.titulo;
                campos.tipo.value = seg.tipo;
                campos.fecha.value = seg.fecha;
                campos.estado.value = seg.estado;
                campos.contenido.value = seg.contenido;
                document.querySelector('#formulario h4').textContent = 'Editar Seguimiento';
            } else {
                document.querySelector('#formulario h4').textContent = 'Nuevo Registro';
            }
    
            document.getElementById('formulario').style.display = 'block';
        }
    
        function ocultarFormulario() {
            form.reset();
            editandoIndex = -1;
            document.getElementById('formulario').style.display = 'none';
            Object.values(campos).forEach(campo => {
                campo.classList.remove('campo-invalido');
                const error = campo.nextElementSibling;
                if (error) {
                    error.textContent = '';
                    error.style.display = 'none';
                }
            });
        }
    
        function guardarSeguimiento() {
            const proyectoId = document.getElementById('selectorProyecto').value;
            
            if (!proyectoId) {
                mostrarErrorModal("Seleccione un proyecto primero");
                return;
            }

            if (!validarFormulario()) {
                mostrarErrorModal("Complete todos los campos requeridos");
                return;
            }

            const nuevoSeguimiento = {
                id: editandoIndex !== -1 ? seguimientos[editandoIndex].id : Date.now(),
                proyectoId,
                titulo: campos.titulo.value.trim(),
                tipo: campos.tipo.value,
                estado: campos.estado.value,
                contenido: campos.contenido.value.trim(),
                usuario: "{{ session.usuario.nombre }}",
                fecha: obtenerFechaLocalISO(campos.fecha.value), // Usar función de formateo
            };

            if (editandoIndex !== -1) {
                seguimientos[editandoIndex] = nuevoSeguimiento;
            } else {
                seguimientos.push(nuevoSeguimiento);
            }

            localStorage.setItem('seguimientos', JSON.stringify(seguimientos));
            renderSeguimientos();
            ocultarFormulario();
        }
        
    
        function confirmarEliminacion(index) {
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            document.getElementById('confirmModalBody').textContent =
                '¿Está seguro que desea eliminar este seguimiento? Esta acción no se puede deshacer.';
    
            document.getElementById('confirmActionBtn').onclick = () => {
                seguimientos.splice(index, 1);
                localStorage.setItem('seguimientos', JSON.stringify(seguimientos));
                renderSeguimientos();
                modal.hide();
            };
    
            modal.show();
        }
        // Función para editar un seguimiento
        function editarSeguimiento(index) {
            const seg = seguimientos[index];
            // Rellenar el formulario con los datos del seguimiento
            document.getElementById('titulo').value = seg.titulo;
            document.getElementById('tipo').value = seg.tipo;
            document.getElementById('fecha').value = seg.fecha;
            document.getElementById('estado').value = seg.estado;
            document.getElementById('contenido').value = seg.contenido;
            // Mostrar el modal
            mostrarFormulario(true, index);
        }

        // Función para eliminar un seguimiento
        function eliminarSeguimiento(index) {
            if (confirm('¿Estás seguro de eliminar este seguimiento?')) {
                seguimientos.splice(index, 1);
                renderSeguimientos();
            }
        }    
        function filtrarSeguimientos(estado) {
            if (estado === 'todos') {
                return seguimientosFiltradosPorProyecto().sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            }
            return seguimientosFiltradosPorProyecto()
                .filter(seg => seg.estado === estado)
                .sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
        }
    
        function seguimientosFiltradosPorProyecto() {
            const proyectoId = document.getElementById('selectorProyecto').value;
            return seguimientos.filter(s => s.proyectoId === proyectoId);
        }
    
        function renderSeguimientos(estadoFiltro = 'todos') {
            const container = document.getElementById('listado-seguimientos');
            const filtrados = filtrarSeguimientos(estadoFiltro);
            
            container.innerHTML = filtrados.length === 0 
                ? `<div class="alert alert-info">No hay seguimientos para este proyecto</div>`
                : `
                    <div class="timeline">
                        ${filtrados.map(seg => `
                            <div class="timeline-item">
                                <div class="timeline-date">
                                    ${new Date(seg.fecha + 'T00:00:00').toLocaleDateString('es-CO', {
                                        timeZone: 'America/Bogota',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    })}
                                    <span class="badge bg-${getEstadoColor(seg.estado)}">${seg.estado.toUpperCase()}</span>
                                </div>
                                <div class="timeline-content">
                                    <h5>${seg.titulo}</h5>
                                    <p class="text-muted">${seg.contenido}</p>
                                    <div class="d-flex gap-2 mt-2">
                                        <button class="btn btn-sm btn-primary btn-action" 
                                            onclick="editarPorId(${seg.id})"
                                            title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger btn-action" 
                                            onclick="eliminarPorId(${seg.id})"
                                            title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>`;
        }

        // Función para editar seguimiento (Actualizada)
        function editarPorId(id) {
            const seguimiento = seguimientos.find(seg => seg.id === id);
            if (!seguimiento) return;

            // Asegurar que proyectoId sea string
            document.getElementById('selectorProyecto').value = String(seguimiento.proyectoId);
            cargarSeguimientos();

            // Llenar formulario
            document.getElementById('editar-titulo').value = seguimiento.titulo;
            document.getElementById('editar-tipo').value = seguimiento.tipo;
            document.getElementById('editar-fecha').value = seguimiento.fecha;
            document.getElementById('editar-estado').value = seguimiento.estado;
            document.getElementById('editar-contenido').value = seguimiento.contenido;

            const form = document.getElementById('form-editar-seguimiento');
            form.onsubmit = (e) => {
                e.preventDefault();
                
                // Actualizar datos (convertir proyectoId a string)
                seguimiento.titulo = document.getElementById('editar-titulo').value;
                seguimiento.tipo = document.getElementById('editar-tipo').value;
                seguimiento.fecha = document.getElementById('editar-fecha').value;
                seguimiento.estado = document.getElementById('editar-estado').value;
                seguimiento.contenido = document.getElementById('editar-contenido').value;
                seguimiento.proyectoId = String(document.getElementById('selectorProyecto').value); // <- Conversión a string

                localStorage.setItem('seguimientos', JSON.stringify(seguimientos));
                cargarSeguimientos();
                bootstrap.Modal.getInstance(document.getElementById('modalEdicion')).hide();
            };

            new bootstrap.Modal(document.getElementById('modalEdicion')).show();
        }

        // Función para cargar seguimientos (Actualizada)
        function cargarSeguimientos() {
            const proyectoId = String(document.getElementById('selectorProyecto').value); // <- Asegurar string
            renderSeguimientos();
        }

        // Función para eliminar con modal
        function eliminarPorId(id) {
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            const seguimiento = seguimientos.find(seg => seg.id === id);
            
            document.getElementById('confirmModalBody').innerHTML = `
                <p>¿Está seguro de eliminar el seguimiento:</p>
                <h5 class="text-danger">${seguimiento.titulo}</h5>
                <p>Esta acción no se puede deshacer</p>
            `;
            
            document.getElementById('confirmActionBtn').onclick = () => {
                seguimientos = seguimientos.filter(seg => seg.id !== id);
                localStorage.setItem('seguimientos', JSON.stringify(seguimientos));
                renderSeguimientos();
                modal.hide();
            };
            
            modal.show();
        }

        // Función para filtrar (Actualizada)
        function seguimientosFiltradosPorProyecto() {
            const proyectoId = String(document.getElementById('selectorProyecto').value); // <- Comparar como strings
            return seguimientos.filter(s => String(s.proyectoId) === proyectoId);
        }
    
        function getEstadoColor(estado) {
            const colores = {
                pendiente: 'warning',
                completado: 'success',
                revision: 'primary'
            };
            return colores[estado] || 'secondary';
        }
    
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            guardarSeguimiento();
        });

        function obtenerFechaLocalISO(inputDate) {
            const fecha = new Date(inputDate);
            const offset = fecha.getTimezoneOffset() * 60000; // Offset en milisegundos
            return new Date(fecha.getTime() - offset).toISOString().split('T')[0];
        }
    
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                this.classList.add('active');
    
                const filtro = this.textContent.trim().toLowerCase();
                const estadoFiltro = {
                    'todos': 'todos',
                    'pendientes': 'pendiente',
                    'completados': 'completado'
                }[filtro];
    
                renderSeguimientos(estadoFiltro);
            });
        });
        // Mapeo de campos
        const mapeoCampos = {
            "FECHA ULTIMO INFORME DE VENTAS": {celda: "J9", tipo: "fecha"},
            "FECHA INICIO DE VENTAS": {celda: "J10", tipo: "fecha"},
            "TOTAL ESPERADO VENTAS": {celda: "K15", tipo: "entero"},
            "INMUEBLES VENDIDOS (unidades)": {celda: "G17", tipo: "entero"},
            "valor inmuebles vendidos": {celda: "K17", tipo: "entero"},
            "% PORCENTAJE DE VENTAS (unidades)": {celda: "H17", tipo: "porcentaje"},
            "% PORCENTAJE DE VENTAS (VALOR)": {celda: "L17", tipo: "porcentaje"},
            "VALOR POR VENDER": {celda: "K16", tipo: "entero"},
            "valor canjes": {celda: "I21", tipo: "entero"},
            "cartera RECAUDADA": {celda: "I19", tipo: "entero"},
            "cartera POR RECAUDAR": {celda: "I20", tipo: "entero"},
            "promedio mensual": { tipo: "promedio" },
            "promedio trimestral": { tipo: "promedio" },
            "VALIDACION FECHA INFVENTAS": {
                tipo: "formula",
                formula: (fechaInforme) => validarVencimiento(fechaInforme)
            }
        };

        function validarVencimiento(fechaInforme) {
            const resultado = {
                valor: false,
                mensaje: "Fecha no evaluada",
                clase: "text-secondary"
            };

            if (!fechaInforme) return resultado;

            const hoy = new Date();
            const diferencia = hoy - new Date(fechaInforme);
            const diasVencimiento = 30;

            if (Math.floor(diferencia / (1000 * 60 * 60 * 24)) > diasVencimiento) {
                resultado.valor = true;
                resultado.mensaje = "Vencido";
                resultado.clase = "text-danger";
            } else {
                resultado.mensaje = "Vigente";
                resultado.clase = "text-success";
            }

            return resultado;
        }

        function calcularPromedios(hoja) {
            const valores = [];
            let fila = 28; // ¡AJUSTA ESTA FILA SEGÚN TU DOCUMENTO!
            const filaMaxima = 57; // Límite para evitar bucles infinitos

            while (fila <= filaMaxima) {
                const celda = hoja[`F${fila}`];
                
                // Verificar existencia de la celda y su valor
                if (!celda || celda.v === undefined || celda.v === null || celda.v === "") break;

                // Convertir a número entero (ya que son enteros positivos)
                const valor = parseInt(celda.v, 10);

                // Validar que sea un entero positivo válido
                if (!isNaN(valor) && valor >= 0) {
                    valores.push(valor);
                }

                fila++;
            }

            if (valores.length === 0) return { mensual: 0, trimestral: 0 };

            // Calcular promedios
            const sumaTotal = valores.reduce((a, b) => a + b, 0);
            const promedioMensual = +(sumaTotal / valores.length).toFixed(2);
            
            // Manejar casos con menos de 3 elementos para el trimestral
            const ultimos3 = valores.slice(-3);
            const promedioTrimestral = +(ultimos3.reduce((a, b) => a + b, 0) / (ultimos3.length || 1)).toFixed(2);

            return { 
                mensual: promedioMensual,
                trimestral: promedioTrimestral,
                sumaTotal: sumaTotal // Opcional: si necesitas la suma
            };
        }

        // Funciones de control
        function mostrarFormCargaVentas() {
            ocultarFormCargaVisitas();
            ocultarFormCargaDesembolsos();
            document.getElementById('formCargaVentas').style.display = 'block';
        }


        function ocultarFormCargaVentas() {
            document.getElementById('formCargaVentas').style.display = 'none';
        }

        // Funciones de control para Visitas
        function mostrarFormCargaVisitas() {
            ocultarFormCargaVentas(); // Asegura que el otro formulario esté cerrado
            ocultarFormCargaDesembolsos();
            document.getElementById('formCargaVisitas').style.display = 'block';
        }

        function ocultarFormCargaVisitas() {
            document.getElementById('formCargaVisitas').style.display = 'none';
        }

        function mostrarFormCargaDesembolsos() {
            ocultarFormCargaVentas();
            ocultarFormCargaVisitas();
            document.getElementById('formCargaDesembolsos').style.display = 'block';
        }

        function ocultarFormCargaDesembolsos() {
            
            document.getElementById('formCargaDesembolsos').style.display = 'none';
        }

        async function procesarArchivo() {

            mostrarModalCarga(async () => {

                const archivo = document.getElementById('archivoVentas').files[0];
                if (!archivo) {
                    mostrarErrorModal("Seleccione un archivo válido");
                    return;
                }

                try {
                    const data = await leerExcel(archivo);
                    const hojaResumen = data['RESUMEN'];
                     
                    if (!validarEstructura(hojaResumen)) {
                        return;
                    }

                    const datosProcesados = extraerDatos(hojaResumen);
                    
                    // Solo mostrar confirmación, NO guardar todavía
                    mostrarConfirmacionCarga(datosProcesados);
                            
                } catch (error) {
                    mostrarErrorModal(`Error: ${error.message}`);
                }
            });    
        }

        async function leerExcel(archivo) {
            const buffer = await archivo.arrayBuffer();
            // Usar XLSX en lugar de XLS (nombre correcto de la librería)
            const workbook = XLSX.read(buffer, { 
                type: 'array', 
                cellFormula: true, 
                bookVBA: true 
            });
            return workbook.Sheets; // Acceder a las hojas correctamente
        }

        // Función de validación actualizada para hoja RESUMEN
        function validarEstructura(hoja) {
            if (!hoja) {
                mostrarErrorModal("No se encontró la hoja 'RESUMEN'");
                return false;
            }

            const proyectoSeleccionado = document.getElementById('selectorProyecto');
            const opcionSeleccionada = proyectoSeleccionado.options[proyectoSeleccionado.selectedIndex];

            // Validar selección
            if (!opcionSeleccionada?.value) {
                mostrarErrorModal("Seleccione un proyecto válido");
                return false;
            }

            const idProyecto = opcionSeleccionada.value;
            const totalUnidades = opcionSeleccionada.dataset.totalUnidades || 0;


            // Normalización de datos
            const idExcel = String(hoja['J7']?.v ?? "").trim(); // Asegurar string y quitar espacios
            const idSistema = String(idProyecto).trim();
            const unidadesExcel = parseInt(hoja['G15']?.v) || 0;
            const unidadesSistema = parseInt(totalUnidades) || 0;

            const validaciones = {
                cabecera: hoja['E2']?.v?.includes('RESUMEN DE VENTAS'),
                idProyecto: idExcel === idSistema, // Comparación robusta
                totalUnidades: unidadesExcel === unidadesSistema
            };

            if (!validaciones.cabecera) {
                mostrarErrorModal("La cabecera en E2:G3 debe contener 'RESUMEN DE VENTAS'");
                return false;
            }

            if (!validaciones.idProyecto) {
                mostrarErrorModal(`ID no coincide: "${idExcel}" vs "${idSistema}"`);
                return false;
            }

            if (!validaciones.totalUnidades) {
                mostrarErrorModal(`Unidades finales: ${unidadesExcel} vs ${unidadesSistema}, no coinciden con las iniciales.`);
                return false;
            }

            return true;
        }

        function extraerDatos(hoja) {
            const proyectoSeleccionado = document.getElementById('selectorProyecto');
            const opcionSeleccionada = proyectoSeleccionado.options[proyectoSeleccionado.selectedIndex];

            const promedios = calcularPromedios(hoja);
            const fechaInforme = formatearValor(hoja['J9']?.v, 'fecha');
            const validacionFecha = mapeoCampos["VALIDACION FECHA INFVENTAS"].formula(fechaInforme);

            const datos = {
                proyectoId: opcionSeleccionada.value,
                proyectoNombre: opcionSeleccionada.textContent,
                fechaCarga: new Date().toISOString(),
                campos: {}
            };

            datos.campos["VALIDACION FECHA INFVENTAS"] = {
                valor: validacionFecha.mensaje,
                tipo: "validacion",
                celda: "J9" + (validacionFecha.valor ? " (Vencido)" : " (Vigente)"),
                estado: validacionFecha
            };

            Object.entries(mapeoCampos).forEach(([clave, config]) => {
                if (clave === "TOTAL ESPERADO VENTAS") {
                    const celda = hoja[config.celda];
                    datos.campos[clave] = {
                        valor: formatearValor(celda?.v, config.tipo || 'entero'),
                        rawValue: celda?.v
                    };
                }
                if (clave === "VALIDACION FECHA INFVENTAS") return;

                if (config.tipo === "promedio") {
                    let valorPromedio = 'N/A';
                    if (clave.toLowerCase().includes("mensual")) {
                        valorPromedio = promedios.mensual ?? 'N/A';
                    } else if (clave.toLowerCase().includes("trimestral")) {
                        valorPromedio = promedios.trimestral ?? 'N/A';
                    }

                    datos.campos[clave] = {
                        valor: valorPromedio,
                        tipo: "numero",
                        celda: config.celda
                    };
                } else {
                    const celda = hoja[config.celda];
                    datos.campos[clave] = {
                        valor: formatearValor(celda?.v, config.tipo || 'texto'),
                        rawValue: celda?.v
                    };
                }
            });

            return datos;
        }

        function formatearValor(valor, tipo) {
            if (valor === undefined || valor === null) return null;

            switch(tipo) {
                case 'fecha': {
                    let fecha;

                    // 1. Si es un numero: convertir desde Excel
                    if (typeof valor === 'number') {
                        const dateCode = XLSX.SSF.parse_date_code(valor);
                        if (dateCode && dateCode.y && dateCode.m && dateCode.d) {
                            fecha = new Date(dateCode.y, dateCode.m - 1, dateCode.d);
                        }
                    }

                    // 2. Si es string
                    if (typeof valor === 'string') {
                        // a) Si es DD/MM/YYYY
                        const regexLatina = /^\d{2}\/\d{2}\/\d{4}$/;
                        if (regexLatina.test(valor)) {
                            const [d, m, y] = valor.split('/').map(Number);
                            fecha = new Date(y, m - 1, d);
                        } else {
                            // b) O cualquier string que pueda ser interpretado como fecha
                            const tmpFecha = new Date(valor);
                            if (!isNaN(tmpFecha)) {
                                fecha = tmpFecha;
                            }
                        }
                    }

                    // 3. Si es objeto Date directamente
                    if (valor instanceof Date && !isNaN(valor)) {
                        fecha = valor;
                    }

                    // Validacion final
                    if (fecha instanceof Date && !isNaN(fecha)) {
                        const dia = String(fecha.getDate()).padStart(2, '0');
                        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
                        const anio = fecha.getFullYear();
                        return `${dia}/${mes}/${anio}`;
                    }

                    return 'Fecha invalida';
                }

                case 'porcentaje':
                    if (typeof valor === 'string') {
                        // Solo limpia y convierte a número (sin multiplicar)
                        return parseFloat(
                            valor.replace('%', '')
                                .replace(',', '.')  // Maneja decimales con coma
                        );
                    } else {
                        return Number(valor);
                    }

                case 'entero':
                    return Math.round(Number(valor));

                default:
                    return valor;
            }
        }


        // Función para convertir fechas en español
        function parsearFechaEspanol(fechaInput) {
            // Convertir números de fecha de Excel a Date
            if (typeof fechaInput === 'number') {
                return XLSX.SSF.parse_date_code(fechaInput);
            }

            // Convertir objetos Date directamente
            if (fechaInput instanceof Date) {
                return fechaInput;
            }

            // Manejar cadenas de texto
            if (typeof fechaInput === 'string') {
                const meses = {
                    ene: 0, feb: 1, mar: 2, abr: 3, may: 4, jun: 5,
                    jul: 6, ago: 7, sep: 8, oct: 9, nov: 10, dic: 11
                };

                const partes = fechaInput.toLowerCase().split('-');
                
                // Formato "24-abr-2025"
                if (partes.length === 3) {
                    const [dia, mes, año] = partes;
                    return new Date(año, meses[mes.slice(0,3)], dia);
                }

                // Formato "dic-2022"
                if (partes.length === 2) {
                    const [mes, año] = partes;
                    return new Date(año, meses[mes.slice(0,3)], 1);
                }
            }

            return null;
        }

        function guardarDatosVentas(datos) {
                const historial = JSON.parse(localStorage.getItem('historialVentas') || '[]');
                const usuario = document.querySelector('#responsable-input').value; // Obtener del input
                
                const nuevaVenta = {
                    proyectoId: datos.proyectoId,
                    proyectoNombre: datos.proyectoNombre,
                    campos: datos.campos,
                    usuario: usuario, // Guardar el usuario responsable
                    fechaCarga: new Date().toISOString() // Fecha actual
                };

                historial.push(nuevaVenta);
                localStorage.setItem('historialVentas', JSON.stringify(historial));
        }

        function mostrarConfirmacionCarga(datos) {
            // Función para formatear valores
            const formatearValorTabla = (nombre, valor) => {
                if (valor === null || valor === undefined) return 'N/A';
                
                // Agregar manejo específico para el nuevo campo si es necesario
                if (nombre === "TOTAL ESPERADO VENTAS" && typeof valor === 'number') {
                    return '$' + valor.toLocaleString('es-CO');
                }
                
                // Formatear porcentajes
                if (nombre.includes('%') && typeof valor === 'number') {
                    return (valor * 100).toFixed(2) + '%';
                }
                
                // Formatear valores monetarios (incluyendo cartera)
                if ((nombre.toLowerCase().includes('valor') || 
                    nombre.toLowerCase().includes('cartera')) && 
                    typeof valor === 'number') {
                    return '$' + valor.toLocaleString('es-CO');
                }
                
                // Formatear números grandes
                if (typeof valor === 'number' && Math.abs(valor) > 1000) {
                    return valor.toLocaleString('es-CO');
                }
                
                return valor;
            };

            // Separar campos regulares de los promedios
            const camposRegulares = {};
            const promedios = {};
            
            Object.entries(datos.campos).forEach(([nombre, info]) => {
                if (nombre.includes('promedio')) {
                    promedios[nombre] = info.valor;
                } else {
                    camposRegulares[nombre] = info;
                }
            });

            // Generar tabla solo con campos regulares
            const tabla = Object.entries(camposRegulares).map(([nombre, info]) => {
                const valorFormateado = formatearValorTabla(nombre, info.valor);
                
                // Manejar estado de validación
                if (nombre === "VALIDACION FECHA INFVENTAS") {
                    const estado = info.estado ?? { clase: 'text-secondary', mensaje: 'No evaluado' };
                    return `
                        <tr>
                            <td>${nombre}</td>
                            <td><span class="${estado.clase}">${estado.mensaje}</span></td>
                        </tr>
                    `;
                }

                return `
                    <tr>
                        <td>${nombre}</td>
                        <td>${valorFormateado}</td>
                    </tr>
                `;
            }).join('');

            // Construir HTML
            document.getElementById('confirmModalBody').innerHTML = `
                <h5 class="mb-3">Carga exitosa - ${datos.proyectoNombre}</h5>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Campo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>${tabla}</tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between mt-3 bg-light p-2 rounded">
                    <div>
                        <strong>Promedio mensual:</strong> ${promedios['promedio mensual'] || 'N/A'}
                    </div>
                    <div>
                        <strong>Promedio trimestral:</strong> ${promedios['promedio trimestral'] || 'N/A'}
                    </div>
                </div>
                <p class="text-muted mt-2">Fecha de carga: ${new Date(datos.fechaCarga).toLocaleString('es-CO')}</p>
            `;

            // Configurar el botón de confirmación
            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            const btnConfirmar = document.getElementById('confirmActionBtn');
            
            
            // Limpiar cualquier evento previo
            btnConfirmar.onclick = null;
            
            // Nuevo evento para guardar definitivamente y generar Excel
            btnConfirmar.onclick = function() {
                const usuario = document.querySelector('#responsable-input').value;
                guardarDatosVentas({
                    ...datos,
                    usuario: usuario
                }); 
                
                // Obtener proyectos y usuario
                const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];
                
                // Generar el Excel (asegurando que los porcentajes se multipliquen por 100)
                generarExcel(proyectos, usuario);
                
                confirmModal.hide();
                
                // Mostrar confirmación adicional
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: '¡Datos guardados en la base!',
                        text: 'La información de ventas se ha almacenado',
                        icon: 'success'
                    });
                } else {
                    alert('¡Datos guardados correctamente!');
                }
            };

            confirmModal.show();
        }
        function mesATrimestre(mesStr) {
            const [mes, año] = mesStr.split('-');
            const numeroMes = {
                ene: 0, feb: 1, mar: 2, abr: 3, may: 4, jun: 5,
                jul: 6, ago: 7, sep: 8, oct: 9, nov: 10, dic: 11
            }[mes.toLowerCase().slice(0,3)];

            return Math.floor(numeroMes / 3) + 1; // Trimestre 1, 2, 3 o 4
        }

        // Función de error general
        function mostrarErrorModal(mensaje) {
            document.getElementById('errorMensaje').innerHTML = mensaje;
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        }

        function generarExcel(proyectos, usuario, datosProcesados) {
            // Funciones auxiliares para formatear fechas
            function formatearFechaDDMMAAAA(fechaString) {
                if (!fechaString) return '';
                const fecha = new Date(fechaString);
                if (isNaN(fecha)) return '';
                const dia = fecha.getDate().toString().padStart(2, '0');
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getFullYear();
                return `${dia}-${mes}-${anio}`;
            }

            function formatearFechaConHora(fechaString) {
                if (!fechaString) return '';
                const fecha = new Date(fechaString);
                if (isNaN(fecha)) return '';
                
                const dia = fecha.getDate().toString().padStart(2, '0');
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getFullYear();
                const horas = fecha.getHours().toString().padStart(2, '0');
                const minutos = fecha.getMinutes().toString().padStart(2, '0');
                const segundos = fecha.getSeconds().toString().padStart(2, '0');
                
                return `${dia}-${mes}-${anio} ${horas}:${minutos}:${segundos}`;
            }

            // Obtener historial de ventas y visitas
            const historialVentas = JSON.parse(localStorage.getItem('historialVentas') || '[]');
            const historialVisitas = JSON.parse(localStorage.getItem('historialVisitas') || '[]');
            const historialDesembolsos = JSON.parse(localStorage.getItem('historialDesembolsos') || '[]');
            const usuarioInput = document.getElementById('responsable-input');
            const responsableUsuario = usuarioInput ? usuarioInput.value : "Usuario no definido";
                    
            // Identificar campos numéricos
            const tiposNumericos = ['entero', 'porcentaje', 'moneda', 'decimal'];
            
            // Mapeo de nombres deseados
            const mapeoNombres = {
                'valor_anticipos': 'VALOR ANTICIPOS',
                'valor_anticipos_almacen': 'VALOR ANTICIPOS ALMACEN',
                'programacion_inicial': 'PROGRAMACION INICIAL',
                'mes_inicio_obra': 'MES INICIO OBRA',
                'avance_obra_meses': 'AVANCE OBRA MESES',
                'avance_esperado_porcentaje': 'AVANCE ESPERADO PORCENTAJE',
                'avance_obra': 'AVANCE OBRA',
                'inversion_del_proyecto': 'INVERSION DEL PROYECTO',
                'tipo_inmueble': 'TIPO INMUEBLE',
                'numero_de_inmuebles': 'NUMERO DE INMUEBLES',
                // Campos de porcentaje de ventas
                '%_porcentaje_de_ventas_(unidades)': '% PORCENTAJE DE VENTAS (UNIDADES)',
                '%_porcentaje_de_ventas_(valor)': '% PORCENTAJE DE VENTAS (VALOR)'
            };

            // Combinar datos
            const proyectosCompletos = proyectos.map(p => {
                // 1. Procesar ventas
                const ventasProyecto = historialVentas.filter(v => v.proyectoId === p.id_proyecto);
                let ventasAplanadas = {};
                let responsableVenta = '';
                let fechaVenta = '';
                
                if (ventasProyecto.length > 0) {
                    const ultimaVenta = ventasProyecto[ventasProyecto.length - 1];
                    Object.entries(ultimaVenta.campos).forEach(([nombreCampo, infoCampo]) => {
                        // Usar nombres deseados para campos específicos
                        const nombreNormalizado = nombreCampo.toLowerCase().replace(/\s+/g, '_');
                        const nombreFinal = mapeoNombres[nombreNormalizado] || nombreCampo;
                        const key = nombreFinal.toLowerCase().replace(/\s+/g, '_');
                        
                        // Extraer y formatear el valor del campo
                        let valor = null;
                        if (infoCampo && typeof infoCampo === 'object' && 'valor' in infoCampo) {
                            // Formatear fechas durante la extracción
                            if (infoCampo.tipo === 'fecha') {
                                valor = formatearFechaDDMMAAAA(infoCampo.valor);
                            } else {
                                valor = infoCampo.valor;
                            }
                        } else {
                            valor = infoCampo;
                        }
                        
                        ventasAplanadas[key] = valor;
                    });
                    
                    responsableVenta = ultimaVenta.usuario || '';
                    fechaVenta = ultimaVenta.fechaCarga || ultimaVenta.fechaModificacion || ultimaVenta.fecha;
                    fechaVenta = formatearFechaConHora(fechaVenta); // Formatear fecha con hora
                }

                // 2. Procesar visitas
                let visitaAplanada = {};
                let responsableVisita = '';
                let fechaVisita = '';
                const visitaProyecto = historialVisitas.find(v => v.proyectoId === p.id_proyecto);
                
                if (visitaProyecto) {
                    Object.entries(visitaProyecto.campos).forEach(([nombreCampo, infoCampo]) => {
                        // Usar nombres deseados para campos específicos
                        const nombreNormalizado = nombreCampo.toLowerCase().replace(/\s+/g, '_');
                        const nombreFinal = mapeoNombres[nombreNormalizado] || nombreCampo;
                        const key = nombreFinal.toLowerCase().replace(/\s+/g, '_');
                        
                        // Extraer y formatear el valor del campo
                        let valor = null;
                        if (infoCampo && typeof infoCampo === 'object' && 'valor' in infoCampo) {
                            // Formatear fechas durante la extracción
                            if (infoCampo.tipo === 'fecha') {
                                valor = formatearFechaDDMMAAAA(infoCampo.valor);
                            } else {
                                valor = infoCampo.valor;
                            }
                        } else {
                            valor = infoCampo;
                        }
                        
                        visitaAplanada[key] = valor;
                    });

                    responsableVisita = visitaProyecto.usuario || '';
                    fechaVisita = visitaProyecto.fechaCarga || visitaProyecto.fechaModificacion || visitaProyecto.fecha;
                    fechaVisita = formatearFechaConHora(fechaVisita); // Formatear fecha con hora
                }

                // 3. PROCESAR DESEMBOLSOS (NUEVO)
                const desembolsosProyecto = historialDesembolsos.filter(d => d.proyectoId === p.id_proyecto);
                let desembolsoAplanado = {};
                let responsableDesembolso = '';
                let fechaDesembolso = '';
                
                if (desembolsosProyecto.length > 0) {
                    // Tomar el último desembolso
                    const ultimoDesembolso = desembolsosProyecto[desembolsosProyecto.length - 1];
                    
                    // Aplanar campos de desembolso
                    Object.entries(ultimoDesembolso.campos).forEach(([nombreCampo, infoCampo]) => {
                        const nombreFinal = nombreCampo; // Usar el nombre original
                        const key = nombreFinal.toLowerCase().replace(/\s+/g, '_');
                        
                        // Extraer valor del campo
                        let valor = null;
                        if (infoCampo && typeof infoCampo === 'object' && 'valor' in infoCampo) {
                            valor = infoCampo.valor;
                        } else {
                            valor = infoCampo;
                        }
                        
                        desembolsoAplanado[key] = valor;
                    });

                    responsableDesembolso = ultimoDesembolso.usuario || '';
                    fechaDesembolso = ultimoDesembolso.fechaCarga || '';
                    fechaDesembolso = formatearFechaConHora(fechaDesembolso);
                }

                return {
                    ...p,
                    ...ventasAplanadas,
                    ...visitaAplanada,
                    ...desembolsoAplanado,
                    responsable_carga_venta: responsableVenta,
                    responsable_carga_visita: responsableVisita,
                    responsable_carga_desembolso: responsableDesembolso,
                    fecha_carga_venta: fechaVenta,
                    fecha_carga_visita: fechaVisita,
                    // Formatear otras fechas importantes sin hora
                    fecha_aprobacion: formatearFechaDDMMAAAA(p.fecha_aprobacion),
                    fecha_radicacion: formatearFechaDDMMAAAA(p.fecha_radicacion),
                    fecha_confirmacion: formatearFechaDDMMAAAA(p.fecha_confirmacion),
                    fecha_primera_visita: formatearFechaDDMMAAAA(p.fecha_primera_visita),
                    fecha_carga_desembolso: fechaDesembolso
                };
            });

            // Generar lista de campos (KEYS) incluyendo campos de visitas
            const camposAdicionales = Object.keys(mapeoCampos).map(key => 
                key.toLowerCase().replace(/\s+/g, '_')
            );

            const camposAdicionalesVisitas = Object.keys(mapeoCamposVisitas).map(key => 
                key.toLowerCase().replace(/\s+/g, '_')
            );

            // Campos de desembolsos
            const camposDesembolsos = [
                'valor_entregado',
                'valor_por_entregar',
                'formula_a',
                'formula_b',
                'superavit',
                'cobertura',
                'maximo_desembolsar',
                'requiere_visto_bueno',
                'responsable_carga_desembolso',
                'fecha_carga_desembolso'
            ];

            // Campos de porcentaje de ventas
            const camposPorcentajeVentas = [
                '%_porcentaje_de_ventas_(unidades)',
                '%_porcentaje_de_ventas_(valor)'
            ];

            // Definir KEYS con todos los campos (incluyendo desembolsos)
            const KEYS = [
                'id_proyecto', 'fecha_creacion', 'tipo_producto', 'rango_proyecto',
                'grupoPrincipal', 'subgrupo_1', 'subgrupo_2', 'subgrupo_3', 
                'nit_grupo_riesgo', 'nit_titular', 'titular_credito',
                'nombre_proyecto', 'tipo_inmuebles', 'segmento', 'ciudad', 'tipo_fiducia',
                'fiduciaria', 'gerente', 'arquitecto', 'auxiliar', 'perito',
                'monto_solicitado_1_desembolso', 'monto_solicitado_cpi',
                'monto_solicitado_lote', 'total_valor_aprobado', 'calificacion_it',
                'costos_financiables', 'valor_lote', 'valor_total_proyecto',
                'meses_programacion', 'total_inmuebles', 'meses_para_venta',
                // Nuevos campos de aprobaciones GOSO
                'tipo_credito', 'departamento', 'caso_pcp_bizagi', 'visitas_a_cobrar',
                'cobrar_estudio_tecnico', 'fecha_aprobacion', 'alerta_fecha_aprobacion',
                'vigencia_en_meses', 'instancia_aprobacion', 'condiciones_aprobacion',
                'porcentaje_solicitado_financiables','validacion_licencia', 'fecha_radicacion',
                'poliza_decenal', 'caso_bizagi_juridico','control_cruzado', 'fecha_confirmacion',
                'fecha_primera_visita', 'id_garantia', 'meses_avanzados', 'plazo_ajustado',
                // Campos adicionales de mapeoCampos
                ...camposAdicionales,
                ...camposAdicionalesVisitas,
                ...camposDesembolsos,
                ...camposPorcentajeVentas,
                // Nuevos campos: responsables y fechas específicas
                'responsable_carga_venta',
                'responsable_carga_visita',
                'fecha_carga_venta',
                'fecha_carga_visita',
                'responsable_carga_desembolso',
                'fecha_carga_desembolso'
            ];

            // Identificar campos numéricos para visitas
            const camposNumericosVisitas = Object.entries(mapeoCamposVisitas)
                .filter(([_, config]) => tiposNumericos.includes(config.tipo))
                .map(([key, _]) => key.toLowerCase().replace(/\s+/g, '_'));

            // Campos numéricos de desembolsos
            const camposNumericosDesembolsos = [
                'valor_entregado',
                'valor_por_entregar',
                'formula_a',
                'formula_b',
                'superavit',
                'cobertura',
                'maximo_desembolsar'
            ];

            // Definir numericFields con todos los campos numéricos
            const numericFields = [
                'monto_solicitado_1_desembolso', 'monto_solicitado_cpi',
                'monto_solicitado_lote', 'total_valor_aprobado', 'valor_lote',
                'valor_total_proyecto', 'meses_programacion', 'total_inmuebles',
                'meses_para_venta', 'visitas_a_cobrar', 'vigencia_en_meses',
                'porcentaje_solicitado_financiables','meses_avanzados', 'plazo_ajustado',
                ...camposNumericosVisitas,
                ...camposPorcentajeVentas,
                ...camposNumericosDesembolsos
            ];
            // Limpiar y formatear datos
            const proyectosLimpios = proyectosCompletos.map(p => {
                let proyecto = {};
                KEYS.forEach(key => {
                    if (key === 'condiciones_aprobacion') {
                        proyecto[key] = Array.isArray(p[key]) 
                            ? p[key].join(', ') 
                            : p[key] || 'Sin condiciones';
                    } else {
                        let value = p[key];
                        
                        // Manejar campos numéricos especiales
                        if (numericFields.includes(key)) {
                            if (value === 0 || value === "0" || value === null || value === undefined) {
                                value = 'N/A';
                            } else {
                                const numValue = parseFloat(value);
                                value = isNaN(numValue) ? 'N/A' : numValue;
                                
                                // Ajustar porcentajes solo si son números válidos
                                if ((key.includes('porcentaje') || key.includes('%') || camposPorcentajeVentas.includes(key)) 
                                    && typeof value === 'number') {
                                    // Ajuste especial para porcentajes de ventas
                                    value = value < 1 ? value * 100 : value;
                                    
                                    // Formatear a 2 decimales
                                    value = Math.round(value * 100) / 100;
                                }
                            }
                        } else {
                            // Para campos no numéricos
                            value = value ?? '';
                            
                            // Manejar campos de texto vacíos
                            if (value === '') {
                                value = 'N/A';
                            }
                        }
                        
                        proyecto[key] = value;
                    }
                });
                return proyecto;
            });

            // Enviar datos al backend para generar Excel
            fetch('/exportar_excel', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    proyectos: proyectosLimpios, 
                    usuario,
                    mapeo_encabezados: mapeoNombres,
                    campos_especiales: {
                        porcentaje: [
                            ...camposNumericosVisitas.filter(f => 
                                f.includes('porcentaje') || f.includes('porcentage')
                            ),
                            ...camposPorcentajeVentas
                        ]
                    }
                })
            })
            .then(response => {
                if (response.ok) return response.blob();
                throw new Error('Error en la generación del Excel');
            })
            .catch(error => {
                console.error('Error:', error);
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: 'Error',
                        text: error.message || 'Error al generar el Excel',
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                    });
                } else {
                    alert('Error al generar el Excel: ' + error.message);
                }
            });
        }

        // Manejar envío del formulario
        document.getElementById('form-actividad4').addEventListener('submit', function(e) {
            e.preventDefault();

            // 1. Obtener ID del proyecto (existente)
            const idHidden = document.getElementById('id_proyecto_hidden');
            let idProyecto = idHidden.value;

            if (!idProyecto) {
                idProyecto = localStorage.getItem('idProyectoSeleccionado');
                if (!idProyecto) {
                    Swal.fire({ icon: 'error', title: 'Error', text: 'ID de proyecto no encontrado' });
                    return;
                }
                idHidden.value = idProyecto;
            }

            // 2. Procesar FormData (existente)
            const formData = new FormData(this);
            const datos = {};

            for (const [key, value] of formData.entries()) {
                if (key === 'documentos') {
                    const files = document.querySelector('[name="documentos"]').files;
                    datos[key] = Array.from(files).map(file => file.name).join(', ');
                } else {
                    datos[key] = value;
                }
            }

            // 3. Actualizar localStorage (existente)
            let proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];
            const index = proyectos.findIndex(p => p.id_proyecto === idProyecto);

            if (index !== -1) {
                Object.entries(datos).forEach(([key, value]) => {
                    proyectos[index][key] = value;
                });
            } else {
                proyectos.push(datos);
            }

            localStorage.setItem('proyectos', JSON.stringify(proyectos));
            generarExcel(proyectos); 

            // Verificar si hay datos de visitas para generar ese reporte también
            const historialVisitas = JSON.parse(localStorage.getItem('historialVisitas') || []);
            if (historialVisitas.some(v => v.proyectoId === idProyecto)) {
                generarExcelVisitas(proyectos, "{{ session.usuario.nombre }}");
            }


            // 4. Verificar campos completos (NUEVO)
            const proyectoActual = proyectos[index];
            
            // Lista de todos los campos requeridos
            const camposRequeridos = [
                'validacion_licencia', 'fecha_radicacion',
                'poliza_decenal', 'caso_bizagi_juridico','control_cruzado', 'fecha_confirmacion',
                'fecha_primera_visita', 'id_garantia', 'meses_avanzados', 'plazo_ajustado'
            ];

            const formularioCompleto = camposRequeridos.every(campo => {
                const valor = proyectoActual[campo];
                return valor !== undefined && valor !== null && valor.toString().trim() !== '';
            });

            // 5. Mostrar mensaje y redirigir solo si está completo (Modificado)
            if (formularioCompleto) {
                Swal.fire({ 
                    title: 'Proyecto completo', 
                    text: 'Todos los datos han sido registrados', 
                    icon: 'success' 
                }).then(() => {
                    window.location.href = "{{ url_for('seguimiento_Proyecto') }}";
                });
            } else {
                Swal.fire({
                    title: 'Datos guardados', 
                    text: 'Información parcial almacenada', 
                    icon: 'success'
                });
            }
        });
        // Agregar evento al botón de confirmación del modal
        document.getElementById('btn-confirmar')
            .addEventListener('click', function() {
                const form = document.getElementById('form-actividad4');
                form.requestSubmit();          // dispara el evento submit correctamente
                // luego cierras tu modal
                const modal = bootstrap.Modal.getInstance(
                document.getElementById('confirmModal')
                );
                modal.hide();
        });

        // Función para guardar datos de desembolsos en localStorage
        function guardarDatosDesembolsos(datos) {
            const historial = JSON.parse(localStorage.getItem('historialDesembolsos') || '[]');
            const usuario = document.querySelector('#responsable-input').value;
            
            const nuevoDesembolso = {
                proyectoId: datos.proyectoId,
                campos: {
                    valorEntregado: datos.valorEntregado,
                    valorPorEntregar: datos.valorPorEntregar,
                    formulaA: datos.formulaA,
                    formulaB: datos.formulaB,
                    superavit: datos.superavit,
                    cobertura: datos.cobertura,
                    maximoDesembolsar: datos.maximoDesembolsar,
                    requiereVistoBueno: datos.requiereVistoBueno
                },
                usuario: usuario,
                fechaCarga: new Date().toISOString()
            };

            historial.push(nuevoDesembolso);
            localStorage.setItem('historialDesembolsos', JSON.stringify(historial));
        }

        // Función para validar fecha de visita
        function validarVencimientoVisita(fechaVisita) {
            const resultado = {
                valor: false,
                mensaje: "Fecha no evaluada",
                clase: "text-secondary"
            };

            if (!fechaVisita) return resultado;

            const hoy = new Date();
            const diferencia = hoy - new Date(fechaVisita);
            const diasVencimiento = 15; // Plazo más corto para visitas (15 días)

            if (Math.floor(diferencia / (1000 * 60 * 60 * 24)) > diasVencimiento) {
                resultado.valor = true;
                resultado.mensaje = "Vencido";
                resultado.clase = "text-danger";
            } else {
                resultado.mensaje = "Vigente";
                resultado.clase = "text-success";
            }

            return resultado;
        }

        // Función para leer archivos Excel, incluyendo protegidos con contraseña
        async function leerExcelVisitas(archivo) {
            const buffer = await archivo.arrayBuffer();
            
            try {
                // Primero intentar sin contraseña
                let workbook = XLSX.read(buffer, { 
                    type: 'array', 
                    cellFormula: true, 
                    bookVBA: true,
                    cellDates: true,
                    sheetStubs: true
                });
                
                // Verificar si la hoja VISOR BANCO está protegida
                const hojaVisorBanco = workbook.Sheets['VISOR BANCO'];
                if (hojaVisorBanco && hojaVisorBanco['!protect']) {
                    throw new Error("Hoja protegida detectada");
                }
                
                return workbook;
            } catch (error) {
                console.log("Archivo protegido detectado, intentando con contraseña...");
                
                // Intentar con contraseña
                try {
                    const workbook = XLSX.read(buffer, { 
                        type: 'array', 
                        cellFormula: true, 
                        bookVBA: true,
                        cellDates: true,
                        sheetStubs: true,
                        password: 'InfoPerito1875*'  // Contraseña proporcionada
                    });
                    
                    return workbook;
                } catch (passError) {
                    // Si falla con contraseña, solicitar al usuario
                    return await solicitarContraseña(archivo);
                }
            }
        }

        // Función para solicitar contraseña al usuario
        async function solicitarContraseña(archivo) {
            return new Promise((resolve, reject) => {
                Swal.fire({
                    title: 'Archivo Protegido',
                    html: `
                        <p>El archivo está protegido con contraseña.</p>
                        <input type="password" id="passwordInput" class="swal2-input" placeholder="Contraseña">
                    `,
                    focusConfirm: false,
                    showCancelButton: true,
                    confirmButtonText: 'Desbloquear',
                    preConfirm: () => {
                        const password = document.getElementById('passwordInput').value;
                        if (!password) {
                            Swal.showValidationMessage('Debe ingresar una contraseña');
                            return false;
                        }
                        return password;
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const password = result.value;
                        const buffer = archivo.arrayBuffer();
                        
                        try {
                            const workbook = XLSX.read(buffer, { 
                                type: 'array', 
                                password: password,
                                cellDates: true
                            });
                            resolve(workbook);
                        } catch (error) {
                            Swal.fire({
                                icon: 'error',
                                title: 'Contraseña incorrecta',
                                text: 'La contraseña ingresada no es válida'
                            });
                            reject(new Error("Contraseña incorrecta"));
                        }
                    } else {
                        reject(new Error("Operación cancelada por el usuario"));
                    }
                });
            });
        }

        function mostrarModalCarga(callback) {
            const modal = new bootstrap.Modal(document.getElementById('modalCarga'));
            const barra = document.getElementById('barraProgreso');
            let progreso = 0;

            modal.show();
            barra.style.width = "0%";
            barra.textContent = "0%";

            const intervalo = setInterval(() => {
            progreso += Math.floor(Math.random() * 10) + 5;
            if (progreso >= 100) {
                progreso = 100;
                barra.style.width = progreso + "%";
                barra.textContent = progreso + "%";
                clearInterval(intervalo);
                setTimeout(() => {
                modal.hide();
                if (callback) callback();
                }, 500);
            } else {
                barra.style.width = progreso + "%";
                barra.textContent = progreso + "%";
            }
            }, 300);
        }

        // Función para detectar el formato del archivo
        function detectarFormatoVisita(workbook) {
            const sheetNames = workbook.SheetNames.map(name => name.toLowerCase());
            
            // Verificar si existe hoja VISOR BANCO (formato nuevo)
            if (sheetNames.includes('visor banco')) {
                return 'nuevo';
            }
            
            // Verificar si existe hoja AVANCE (formato viejo)
            if (sheetNames.includes('avance')) {
                return 'viejo';
            }
            
            // Si no se detecta por nombre, analizar contenido
            try {
                const primeraHoja = workbook.Sheets[workbook.SheetNames[0]];
                
                // Heurística para formato nuevo
                if (primeraHoja['C13'] && primeraHoja['P21'] && primeraHoja['C9']) {
                    return 'nuevo';
                }
                
                // Heurística para formato viejo
                if (primeraHoja['C3'] && primeraHoja['E3'] && primeraHoja['E4']) {
                    return 'viejo';
                }
            } catch (e) {
                console.error("Error analizando contenido de hoja:", e);
            }
            
            return 'mixto';
        }


        // Función para obtener la hoja correcta según el formato
        function obtenerHojaVisita(workbook, formato) {
            if (formato === 'nuevo') {
                return workbook.Sheets['VISOR BANCO'] || workbook.Sheets[workbook.SheetNames[0]];
            }
            
            if (formato === 'viejo') {
                return workbook.Sheets['AVANCE'] || workbook.Sheets[workbook.SheetNames[0]];
            }
            
            // Para formato mixto, buscar la hoja más probable
            for (const sheetName of workbook.SheetNames) {
                const hoja = workbook.Sheets[sheetName];
                if (hoja['C13'] && hoja['P21']) return hoja; // Formato nuevo
                if (hoja['C3'] && hoja['E3']) return hoja;   // Formato viejo
            }
            
            // Si no se encuentra, usar primera hoja
            return workbook.Sheets[workbook.SheetNames[0]];
        }


        // Función principal para procesar archivo de visitas
        async function procesarArchivoVisitas() {

            mostrarModalCarga(async () => {

                const archivo = document.getElementById('archivoVisitas').files[0];
                if (!archivo) {
                    mostrarErrorModal("Seleccione un archivo de visitas válido");
                    return;
                }

                try {
                    // Obtener datos del proyecto seleccionado
                    const proyectoSeleccionado = document.getElementById('selectorProyecto');
                    const opcionSeleccionada = proyectoSeleccionado.options[proyectoSeleccionado.selectedIndex];
                    
                    if (!opcionSeleccionada?.value) {
                        mostrarErrorModal("Seleccione un proyecto válido");
                        return;
                    }

                    const idProyecto = opcionSeleccionada.value;
                    const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];
                    const proyecto = proyectos.find(p => p.id_proyecto == idProyecto);
                    
                    if (!proyecto) {
                        mostrarErrorModal("No se encontraron datos del proyecto en el sistema");
                        return;
                    }

                    // Leer archivo Excel (maneja archivos protegidos)
                    const workbook = await leerExcelVisitas(archivo);
                    
                    // Detectar formato y obtener hoja correcta
                    const formato = detectarFormatoVisita(workbook);
                    const hojaVisitas = obtenerHojaVisita(workbook, formato);
                    
                    if (!hojaVisitas) {
                        mostrarErrorModal("No se encontraron datos válidos en el archivo");
                        return;
                    }

                    // Extraer datos para validación crítica según formato
                    const datosValidacion = {
                        idProyectoExcel: formato === 'nuevo' ? 
                            hojaVisitas['C13']?.v : 
                            hojaVisitas['C3']?.v,
                        costosFinanciablesExcel: formato === 'nuevo' ? 
                            hojaVisitas['H37']?.v : 
                            hojaVisitas['H14']?.v,
                        peritoExcel: formato === 'nuevo' ? 
                            hojaVisitas['P9']?.v : 
                            hojaVisitas['H68']?.v,
                        fechaVisita: formato === 'nuevo' ? 
                            hojaVisitas['C7']?.v : 
                            hojaVisitas['I4']?.v,
                        avanceObra: formato === 'nuevo' ? 
                            hojaVisitas['P63']?.v : 
                            hojaVisitas['F66']?.v
                    };

                    // Validar datos críticos con el sistema
                    const errores = [];

                    // 1. Validar ID del proyecto
                    if (String(proyecto.id_proyecto) !== String(datosValidacion.idProyectoExcel)) {
                        errores.push(`ID del proyecto no coincide: Sistema (${proyecto.id_proyecto}) vs Excel (${datosValidacion.idProyectoExcel})`);
                    }

                    // 2. Validar costos financiables (con tolerancia numérica)
                    const costosSistema = cleanNumber(proyecto.costos_financiables || 0);
                    const costosExcel = cleanNumber(datosValidacion.costosFinanciablesExcel || 0);
                    const diferenciaCostos = Math.abs(costosSistema - costosExcel);
                    
                    if (diferenciaCostos > 1) {
                        errores.push(`Costos financiables no coinciden: Sistema (${costosSistema.toLocaleString()}) vs Excel (${costosExcel.toLocaleString()}) - Diferencia: ${diferenciaCostos.toLocaleString()}`);
                    }

                    // 3. Validar perito (ignorar mayúsculas y espacios)
                    const peritoSistema = (proyecto.perito || '').trim().toLowerCase();
                    const peritoExcel = (datosValidacion.peritoExcel || '').trim().toLowerCase();
                    
                    if (peritoSistema !== peritoExcel) {
                        errores.push(`Perito no coincide: Sistema (${proyecto.perito}) vs Excel (${datosValidacion.peritoExcel})`);
                    }

                    // Mostrar errores si existen
                    if (errores.length > 0) {
                        // Limpiar cada mensaje de error quitando etiquetas HTML
                        const erroresLimpios = errores.map(error => {
                            return error.replace(/<\/?[^>]+(>|$)/g, "");
                        });

                        // Construir el contenido HTML con formato adecuado
                        const contenidoHTML = `
                            <h5>Errores de validación crítica</h5>
                            <ul class="mb-0">
                                ${erroresLimpios.map(e => `<li>${e}</li>`).join('')}
                            </ul>
                            <p class="mt-3">No se puede cargar la visita debido a inconsistencias con los datos del sistema.</p>
                        `;

                        mostrarErrorModal(contenidoHTML);
                        return;
                    }

                    // Extraer y mostrar datos completos
                    const datosProcesados = extraerDatosVisitasCompleto(hojaVisitas, proyecto, formato);
                    mostrarConfirmacionDatosVisita(proyecto, datosValidacion, hojaVisitas, formato, datosProcesados);
                            
                } catch (error) {
                    mostrarErrorModal(`Error al procesar visitas: ${error.message}`);
                }
        });
        }

        // Función para validar estructura del archivo de visitas
        function validarEstructuraVisitas(hoja) {
            if (!hoja) {
                mostrarErrorModal("No se encontró la hoja 'REGISTRO VISITAS'");
                return false;
            }

            const proyectoSeleccionado = document.getElementById('selectorProyecto');
            const opcionSeleccionada = proyectoSeleccionado.options[proyectoSeleccionado.selectedIndex];

            if (!opcionSeleccionada?.value) {
                mostrarErrorModal("Seleccione un proyecto válido");
                return false;
            }

            // Validar cabecera específica para visitas
            const validaciones = {
                cabecera: hoja['A1']?.v?.includes('REGISTRO DE VISITAS'),
                tieneDatos: hoja['B5']?.v !== undefined // Verificar al menos una fecha de visita
            };

            if (!validaciones.cabecera) {
                mostrarErrorModal("La cabecera en A1 debe contener 'REGISTRO DE VISITAS'");
                return false;
            }

            if (!validaciones.tieneDatos) {
                mostrarErrorModal("No se encontraron datos de visitas en las celdas esperadas");
                return false;
            }

            return true;
        }
        
        function mostrarConfirmacionDatosVisita(proyecto, datosValidacion, hojaVisitas, formato) {
            // Cerrar cualquier otro modal abierto (como el de ventas)
            const modalesAbiertos = document.querySelectorAll('.modal.show');
            modalesAbiertos.forEach(modal => bootstrap.Modal.getInstance(modal)?.hide());

            // Extraer datos completos usando el mapeo
            const datosProcesados = extraerDatosVisitasCompleto(hojaVisitas, proyecto, formato);
            let numeroVisita = 'N/A';

            if (hojaVisitas && (hojaVisitas['C9'] || hojaVisitas['E4'])) {
                numeroVisita = hojaVisitas['C9']?.v || hojaVisitas['E4']?.v || 'N/A';
            }

            // 1. Construir la primera parte del modal
            let contenidoModal = `
                <div class="alert alert-info">
                    <strong>Formato detectado:</strong> ${formato === 'nuevo' ? 'Nuevo (VISOR BANCO)' : formato === 'viejo' ? 'Viejo (AVANCE)' : 'Mixto (Autodetectado)'}
                </div>
                
                <div class="alert alert-primary">
                    <h5 class="mb-3">Validación de datos del proyecto</h5>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>ID Proyecto:</strong> ${proyecto.id_proyecto}</div>
                        <div class="col-md-6"><strong>Nombre:</strong> ${proyecto.nombre_proyecto}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6"><strong>Costos Financiables:</strong> ${cleanNumber(proyecto.costos_financiables || 0).toLocaleString('es-CO', {style: 'currency', currency: 'COP'})}</div>
                        <div class="col-md-6"><strong>Perito:</strong> ${proyecto.perito || 'No registrado'}</div>
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="fas fa-check-circle me-2"></i>
                        Todos los datos críticos coinciden con el sistema
                    </div>
                    <hr>
                </div>`;

            // 2. Validaciones
            let alertaContenido = '';
            if (proyecto.ultima_fecha_visita && datosValidacion.fechaVisita) {
                const ultimaFecha = new Date(proyecto.ultima_fecha_visita);
                const nuevaFecha = new Date(datosValidacion.fechaVisita);
                if (nuevaFecha < ultimaFecha) {
                    alertaContenido += `⚠️ La fecha de la visita (${formatearValor(nuevaFecha)}) es anterior a la última visita registrada (${formatearValor(ultimaFecha)})<br>`;
                }
            }

            if (proyecto.avance_obra && datosValidacion.avanceObra) {
                const ultimoAvance = parseFloat(proyecto.avance_obra);
                const nuevoAvance = parseFloat(datosValidacion.avanceObra);
                if (nuevoAvance < ultimoAvance) {
                    alertaContenido += `⚠️ El avance reportado (${nuevoAvance.toFixed(2)}%) es menor que el último registro (${ultimoAvance.toFixed(2)}%)<br>`;
                }
            }

            if (alertaContenido) {
                contenidoModal += `
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${alertaContenido}
                </div>`;
            }

            // 3. Detalles de visita
            contenidoModal += `
                <h5 class="mt-4">Detalles completos de la visita</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead>
                            <tr>
                                <th>Campo</th>
                                <th>Valor</th>
                            </tr>
                        </thead>
                        <tbody>`;

            Object.entries(mapeoCamposVisitas).forEach(([nombreCampo, config]) => {
                const campo = datosProcesados.campos[nombreCampo];
                let valorFormateado = 'N/A';

                if (campo && campo.valor !== null && campo.valor !== undefined) {
                    switch (campo.tipo) {
                        case 'moneda':
                            if (!isNaN(campo.valor)) {
                                valorFormateado = parseFloat(campo.valor).toLocaleString('es-CO', {
                                    style: 'currency',
                                    currency: 'COP'
                                });
                            }
                            break;
                            
                        case 'porcentaje':
                            if (!isNaN(campo.valor)) {
                                valorFormateado = parseFloat(campo.valor).toFixed(2) + '%';
                            }
                            break;
                            
                        case 'fecha':
                            if (campo.valor instanceof Date && !isNaN(campo.valor)) {
                                valorFormateado = campo.valor.toLocaleDateString('es-CO');
                            }
                            break;
                            
                        case 'decimal':
                            if (!isNaN(campo.valor)) {
                                valorFormateado = parseFloat(campo.valor).toFixed(2);
                            }
                            break;
                            
                        case 'entero':
                            if (!isNaN(campo.valor)) {
                                valorFormateado = parseInt(campo.valor).toLocaleString('es-CO');
                            }
                            break;
                            
                        default:
                            valorFormateado = campo.valor.toString();
                    }
                }

                contenidoModal += `
                    <tr>
                        <td>${nombreCampo}</td>
                        <td>${valorFormateado}</td>
                    </tr>`;
            });

            contenidoModal += `
                        </tbody>
                    </table>
                </div>`;

            // ✅ Asignar contenido correctamente al body del modal
            document.getElementById('confirmModalVisitasBody').innerHTML = contenidoModal;

            // Configurar el botón de confirmación
            const btnConfirmar = document.getElementById('confirmActionBtnVisitas');
            btnConfirmar.onclick = function () {
                const usuario = document.querySelector('#responsable-input').value;
                // Guardar en historial de visitas o base de datos
                guardarDatosVisitas({
                    ...datosProcesados,
                    usuario: usuario
                });

                // Obtener proyectos y usuario
                const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];

                // Generar el Excel incluyendo datos de la visita
                generarExcel(proyectos, usuario, datosProcesados);

                // Cerrar modal
                confirmModalVisitas.hide();

                // Mostrar confirmacion
                if (typeof Swal !== 'undefined') {
                    Swal.fire({
                        title: '¡Datos guardados en la base!',
                        text: 'La informacion de la visita ha sido almacenada',
                        icon: 'success'
                    });
                } else {
                    alert('¡Datos de visita guardados correctamente!');
                }
            };


            // Mostrar el modal
            const confirmModalVisitas = new bootstrap.Modal(document.getElementById('confirmModalVisitas'));
            confirmModalVisitas.show();
        }


        // Función para extraer datos de ambos formatos
        function extraerDatosVisitasCompleto(hoja, proyecto, formato) {
            const datos = {
                proyectoId: proyecto.id_proyecto,
                proyectoNombre: proyecto.nombre_proyecto,
                fechaCarga: new Date().toISOString(),
                tipo: 'visitas',
                formato: formato,
                campos: {}
            };

            Object.entries(mapeoCamposVisitas).forEach(([clave, config]) => {
                let valor = null;
                let celdaFuente = 'N/A';
                let tipoFuente = 'directo';
                
                try {
                    // 1. Manejar campos con lógica especial (solo formato nuevo)
                    if (formato === 'nuevo' && config.nuevo && typeof config.nuevo.logica === 'function') {
                        valor = config.nuevo.logica(hoja);
                        tipoFuente = 'logica';
                        celdaFuente = 'Cálculo interno';
                    }
                    // 2. Campos con referencia directa (formato nuevo)
                    else if (formato === 'nuevo' && config.nuevo && typeof config.nuevo === 'string') {
                        celdaFuente = config.nuevo;
                        if (hoja[config.nuevo]) {
                            valor = hoja[config.nuevo].v;
                        }
                    }
                    // 3. Campos con referencia directa (formato viejo)
                    else if (formato === 'viejo' && config.viejo) {
                        celdaFuente = config.viejo;
                        if (hoja[config.viejo]) {
                            valor = hoja[config.viejo].v;
                        }
                    }
                    // 4. Intento mixto si no se detectó bien el formato
                    else if (formato === 'mixto') {
                        // Primero intentar con formato nuevo
                        if (config.nuevo) {
                            if (typeof config.nuevo === 'string' && hoja[config.nuevo]) {
                                valor = hoja[config.nuevo].v;
                                celdaFuente = config.nuevo;
                            } else if (typeof config.nuevo.logica === 'function') {
                                valor = config.nuevo.logica(hoja);
                                tipoFuente = 'logica';
                                celdaFuente = 'Cálculo interno (mixto)';
                            }
                        }
                        // Si no se encontró en nuevo, intentar con viejo
                        if ((valor === null || valor === undefined) && config.viejo && hoja[config.viejo]) {
                            valor = hoja[config.viejo].v;
                            celdaFuente = config.viejo;
                        }
                    }
                } catch (e) {
                    console.error(`Error extrayendo ${clave}:`, e);
                }

                // Solo aplicar transformaciones si tenemos un valor
                if (valor !== null && valor !== undefined) {
                    switch(config.tipo) {
                        case 'moneda':
                            valor = cleanNumber(valor);
                            break;
                        case 'porcentaje':
                            valor = cleanNumber(valor) * 100;
                            break;
                        case 'decimal':
                            valor = parseFloat(valor);
                            break;
                        case 'entero':
                            valor = parseInt(cleanNumber(valor));
                            break;
                        case 'fecha':
                            // Mantener como objeto Date para formateo posterior
                            valor = new Date(valor);
                            break;
                    }
                }

                // Guardar campo (mantener null/undefined si no se encontró)
                datos.campos[clave] = {
                    valor: valor,
                    tipo: config.tipo,
                    fuente: tipoFuente,
                    celda: celdaFuente
                };
            });

            return datos;
        }

        // Función para guardar datos de visitas en localStorage
        function guardarDatosVisitas(datos) {
            const historial = JSON.parse(localStorage.getItem('historialVisitas') || '[]');
            const usuario = document.querySelector('#responsable-input').value; // Obtener del input
            
            const nuevaVisita = {
                proyectoId: datos.proyectoId,
                campos: datos.campos,
                usuario: usuario, // Guardar el usuario responsable
                fechaCarga: new Date().toISOString() // Fecha actual
            };

            historial.push(nuevaVisita);
            localStorage.setItem('historialVisitas', JSON.stringify(historial));
        }
        
        // Función para procesar desembolsos (muestra el modal)
        function procesarDesembolsos() {
            // Obtener proyecto actual
            const proyecto = obtenerProyectoActual();
            if (!proyecto) {
                mostrarErrorModal("No se ha seleccionado un proyecto válido.");
                return;
            }
            
            // Calcular los valores
            const valores = calcularValoresDesembolsos(proyecto);
            
            // Construir contenido del modal
            let contenido = `
                <div class="alert alert-info">
                    <strong>Proyecto:</strong> ${proyecto.nombre_proyecto} (ID: ${proyecto.id_proyecto})
                    <br><strong>Avance de obra:</strong> ${(proyecto.avance_obra || 0).toFixed(2)}%
                    <br><strong>Porcentaje de ventas:</strong> ${(proyecto.porcentaje_ventas || 0).toFixed(2)}%
                </div>
                
                <h5 class="mt-3">Valores Calculados</h5>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Concepto</th>
                                <th>Valor</th>
                                <th>Fórmula</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>VALOR ENTREGADO</strong></td>
                                <td>${formatCurrency(valores.valorEntregado)}</td>
                                <td>Suma de todos los desembolsos a la fecha</td>
                            </tr>
                            <tr>
                                <td><strong>VALOR POR ENTREGAR</strong></td>
                                <td>${formatCurrency(valores.valorPorEntregar)}</td>
                                <td>Aprobado - Desistido + Ampliación - Entregado</td>
                            </tr>
                            <tr>
                                <td><strong>A DESEMBOLSAR CONSTRUCTOR (% SOLICITADO)</strong></td>
                                <td>${formatCurrency(valores.formulaA)}</td>
                                <td>${valores.formulaADesc}</td>
                            </tr>
                            <tr>
                                <td><strong>B DESEMBOLSAR CONSTRUCTOR (MÁXIMO %)</strong></td>
                                <td>${formatCurrency(valores.formulaB)}</td>
                                <td>${valores.formulaBDesc}</td>
                            </tr>
                            <tr>
                                <td><strong>SUPERÁVIT (C)</strong></td>
                                <td>${formatCurrency(valores.superavit)}</td>
                                <td>Recaudado + Entregado - Invertido - Lote</td>
                            </tr>
                            <tr>
                                <td><strong>VALOR POR INVERTIR</strong></td>
                                <td>${formatCurrency(valores.valorPorInvertir)}</td>
                                <td>Costos financiables - Valor invertido</td>
                            </tr>
                            <tr>
                                <td><strong>COBERTURA</strong></td>
                                <td>${valores.cobertura.toFixed(2)}%</td>
                                <td>(Por recaudar + Por vender - Por invertir) / Entregado</td>
                            </tr>
                            <tr>
                                <td><strong>MÁXIMO A DESEMBOLSAR (POLÍTICA)</strong></td>
                                <td>${formatCurrency(valores.maximoDesembolsar)}</td>
                                <td>${valores.maximoDesembolsarFormula}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="alert ${valores.requiereVistoBueno ? 'alert-danger' : 'alert-success'}">
                    <i class="fas ${valores.requiereVistoBueno ? 'fa-exclamation-triangle' : 'fa-check-circle'} me-2"></i>
                    ${valores.requiereVistoBueno 
                        ? 'REQUIERE VISTO BUENO DE RIESGOS (Cobertura < 100%)' 
                        : 'No requiere visto bueno de riesgos'}
                </div>
                
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    ${valores.condicionesCumplidas 
                        ? 'Cálculos realizados con avance de obra > 30% y valor entregado > 0' 
                        : 'Cálculos no aplican (avance obra ≤ 30% o valor entregado = 0)'}
                </div>
                
                <h5 class="mt-3">Validación de Condiciones</h5>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">Condiciones para Fórmula A</div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li class="${valores.condicionesAB.avanceObraReciente ? 'text-success' : 'text-danger'}">
                                        Avance obra ≤ 2 meses: ${valores.condicionesAB.avanceObraReciente ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                    <li class="${valores.condicionesAB.informeVentasReciente ? 'text-success' : 'text-danger'}">
                                        Informe ventas ≤ 31 días: ${valores.condicionesAB.informeVentasReciente ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                    <li class="${valores.condicionesAB.ventasMayor100 ? 'text-success' : 'text-danger'}">
                                        % Ventas > 100%: ${valores.condicionesAB.ventasMayor100 ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                    <li class="${valores.condicionesAB.licenciaOK ? 'text-success' : 'text-danger'}">
                                        Licencia OK: ${valores.condicionesAB.licenciaOK ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card mb-3">
                            <div class="card-header bg-light">Condiciones para Fórmula B</div>
                            <div class="card-body">
                                <ul class="mb-0">
                                    <li class="${valores.condicionesAB.avanceObraReciente ? 'text-success' : 'text-danger'}">
                                        Avance obra ≤ 2 meses: ${valores.condicionesAB.avanceObraReciente ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                    <li class="${valores.condicionesAB.informeVentasReciente ? 'text-success' : 'text-danger'}">
                                        Informe ventas ≤ 31 días: ${valores.condicionesAB.informeVentasReciente ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                    <li class="${valores.condicionesAB.ventasMayor100 ? 'text-success' : 'text-danger'}">
                                        % Ventas > 100%: ${valores.condicionesAB.ventasMayor100 ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                    <li class="${valores.condicionesAB.licenciaOK ? 'text-success' : 'text-danger'}">
                                        Licencia OK: ${valores.condicionesAB.licenciaOK ? '✔️ Cumple' : '❌ No cumple'}
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Asignar contenido al modal
            document.getElementById('confirmModalDesembolsosBody').innerHTML = contenido;
            
            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('confirmModalDesembolsos'));
            modal.show();
            
            // Configurar acción del botón Confirmar
            document.getElementById('confirmActionBtnDesembolsos').onclick = function() {
                // Aquí iría la lógica para guardar en la base de datos

                // Obtener proyecto y valores calculados
                const proyecto = obtenerProyectoActual();
                const valores = calcularValoresDesembolsos(proyecto);
                const usuario = document.querySelector('#responsable-input').value;
                 // Guardar en historial de desembolsos
                guardarDatosDesembolsos({
                    proyectoId: proyecto.id_proyecto,
                    valorEntregado: valores.valorEntregado,
                    valorPorEntregar: valores.valorPorEntregar,
                    formulaA: valores.formulaA,
                    formulaB: valores.formulaB,
                    superavit: valores.superavit,
                    cobertura: valores.cobertura,
                    maximoDesembolsar: valores.maximoDesembolsar,
                    requiereVistoBueno: valores.requiereVistoBueno
                });

                // Obtener proyectos actualizados
                const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];

                // Generar Excel incluyendo desembolsos
                generarExcel(proyectos, usuario, null);
                modal.hide();
                
                // Mostrar confirmación
                Swal.fire({
                    title: '¡Procesado!',
                    text: 'Los valores de desembolsos han sido registrados',
                    icon: 'success'
                });
            };
        }

        // Función para calcular todos los valores
        function calcularValoresDesembolsos(proyecto) {
            // Obtener datos necesarios del proyecto
            const costosFinanciables = cleanNumber(proyecto.costos_financiables || 0);
            const valorInvertido = cleanNumber(proyecto.valor_invertido || 0);
            const valorRecaudado = cleanNumber(proyecto.valor_recaudado || 0);
            const valorLote = cleanNumber(proyecto.valor_lote || 0);
            const valorPreoperativo = cleanNumber(proyecto.valor_preoperativo || 0);
            const valorEntregado = cleanNumber(proyecto.valor_entregado || 0); // Suma de desembolsos
            const valorDesistido = cleanNumber(proyecto.valor_desistido || 0);
            const valorAmpliacion = cleanNumber(proyecto.valor_ampliacion || 0);
            const valorAprobado = cleanNumber(proyecto.valor_aprobado || 0);
            const avanceObra = cleanNumber(proyecto.avance_obra || 0) / 100; // Convertir porcentaje a decimal
            const porcentajeVentas = cleanNumber(proyecto.porcentaje_ventas || 0) / 100; // Porcentaje de ventas en decimal
            const valorPorRecaudar = cleanNumber(proyecto.valor_por_recaudar || 0);
            const valorPorVender = cleanNumber(proyecto.valor_por_vender || 0);
            
            // Obtener fechas para validar condiciones
            const fechaActual = new Date();
            const fechaUltimoInformeVentas = proyecto.fecha_ultimo_informe_ventas ? new Date(proyecto.fecha_ultimo_informe_ventas) : null;
            const fechaUltimoAvanceObra = proyecto.fecha_ultimo_avance_obra ? new Date(proyecto.fecha_ultimo_avance_obra) : null;
            
            // Validar condiciones para A y B (comunes)
            let condicionesAB = {
                avanceObraReciente: false,
                informeVentasReciente: false,
                ventasMayor100: porcentajeVentas >= 1, // 100% o más
                licenciaOK: proyecto.licencia_ok || false // Asumimos un campo booleano
            };
            
            // Validar que el avance de obra no sea de hace más de 2 meses (60 días)
            if (fechaUltimoAvanceObra) {
                const diffDiasAvance = (fechaActual - fechaUltimoAvanceObra) / (1000 * 60 * 60 * 24);
                condicionesAB.avanceObraReciente = diffDiasAvance <= 60;
            }
            
            // Validar que el informe de ventas no sea de hace más de 31 días
            if (fechaUltimoInformeVentas) {
                const diffDiasVentas = (fechaActual - fechaUltimoInformeVentas) / (1000 * 60 * 60 * 24);
                condicionesAB.informeVentasReciente = diffDiasVentas <= 31;
            }
            
            // Calcular valor por entregar
            const valorPorEntregar = valorAprobado - valorDesistido + valorAmpliacion - valorEntregado;
            
            // Calcular valor por invertir
            const valorPorInvertir = costosFinanciables - valorInvertido;
            
            // Inicializar fórmulas A, B y C
            let formulaA = 0;
            let formulaB = 0;
            let formulaADesc = '';
            let formulaBDesc = '';
            let superavit = 0;
            let cobertura = 0;
            let maximoDesembolsar = 0;
            let maximoDesembolsarFormula = '';
            let requiereVistoBueno = false;
            let condicionesCumplidas = false; // Para ver si se pueden calcular A, B, C
            
            // Solo calcular A, B, C si:
            // - valorEntregado > 0
            // - avanceObra (en decimal) > 0.3 (30%)
            if (valorEntregado > 0 && avanceObra > 0.3) {
                condicionesCumplidas = true;
                
                // Fórmula C: Superávit
                superavit = valorRecaudado + valorEntregado - valorInvertido - valorLote;
                
                // Fórmula A: 
                // Parte 1: aprobado - desistido + ampliado
                const parteA1 = valorAprobado - valorDesistido + valorAmpliacion;
                // Parte 2: costos financiables * valor invertido - (entregado - lote - preoperativo)
                const parteA2 = costosFinanciables * valorInvertido - (valorEntregado - valorLote - valorPreoperativo);
                
                // Fórmula A es la parte 1, pero limitada por la parte 2
                formulaA = parteA1;
                formulaADesc = `Aprobado - Desistido + Ampliado = ${formatCurrency(parteA1)}`;
                
                // Fórmula B: 
                formulaB = (valorInvertido * 0.8) - (valorEntregado - valorLote - valorPreoperativo);
                // La fórmula B no puede ser mayor que el valor por entregar
                formulaB = Math.min(formulaB, valorPorEntregar);
                formulaBDesc = `(Valor invertido × 0.8) - (Entregado - Lote - Preoperativo) = ${formatCurrency(formulaB)}`;
                
                // Si parteA2 > formulaB, entonces formulaA = formulaB
                if (parteA2 > formulaB) {
                    formulaA = formulaB;
                    formulaADesc += `<br>→ Limitado por Fórmula B = ${formatCurrency(formulaB)}`;
                }
                
                // Fórmula de cobertura
                cobertura = (valorPorRecaudar + valorPorVender - valorPorInvertir) / valorEntregado;
                cobertura = cobertura * 100; // a porcentaje
                
                // Visto bueno de riesgos
                requiereVistoBueno = cobertura < 100;
                
                // Máximo a desembolsar según política de superávit
                if (superavit < 0) {
                    maximoDesembolsar = formulaA;
                    maximoDesembolsarFormula = 'Superávit < 0 → Fórmula A';
                } else {
                    maximoDesembolsar = formulaB - (superavit * avanceObra);
                    if (maximoDesembolsar > formulaB) {
                        maximoDesembolsar = formulaB;
                        maximoDesembolsarFormula = 'Máximo = Fórmula B (superó el límite)';
                    } else {
                        maximoDesembolsarFormula = `Fórmula B - (Superávit × Avance Obra) = ${formatCurrency(formulaB)} - (${formatCurrency(superavit)} × ${(avanceObra*100).toFixed(2)}%)`;
                    }
                }
            } else {
                // No se cumplen las condiciones para calcular A, B, C
                superavit = 0;
                cobertura = 0;
                maximoDesembolsar = 0;
                maximoDesembolsarFormula = 'No aplica (valor entregado=0 o avance obra ≤ 30%)';
                requiereVistoBueno = false;
            }
            
            return {
                condicionesCumplidas,
                condicionesAB,
                valorEntregado,
                valorPorEntregar,
                valorPorInvertir,
                formulaA,
                formulaB,
                formulaADesc,
                formulaBDesc,
                superavit,
                cobertura,
                maximoDesembolsar,
                maximoDesembolsarFormula,
                requiereVistoBueno
            };
        }

        // Función auxiliar para obtener proyecto actual
        function obtenerProyectoActual() {
            const selector = document.getElementById('selectorProyecto');
            if (!selector) return null;
            
            const idProyecto = selector.value;
            const proyectos = JSON.parse(localStorage.getItem('proyectos')) || [];
            return proyectos.find(p => p.id_proyecto == idProyecto);
        }

        // Función para formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        }

        // Función para formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-CO', {
                style: 'currency',
                currency: 'COP',
                minimumFractionDigits: 0
            }).format(value);
        }

        function cleanNumber(value) {
            if (typeof value === 'number') return value;
            if (typeof value === 'string') {
                // Eliminar caracteres no numéricos excepto puntos y comas
                const cleaned = value.replace(/[^\d.,]/g, '');
                // Convertir a formato numérico estándar
                return parseFloat(cleaned.replace(/\./g, '').replace(',', '.')) || 0;
            }
            return 0;
        }
    </script>   
</body>
</html>