<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cargar archivo Excel</title>
    
    <!-- Enlace a Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Estilos personalizados -->
    <style>
        .container {
            margin-top: 50px;
        }

        .btn-custom {
            background-color: #007bff;
            color: white;
        }

        .btn-custom:hover {
            background-color: #0056b3;
        }

        .result-message {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .logo-container {
            text-align: center;
            margin-top: 10px;
        }
        .logo-container img {
            max-width: 100%;
            height: auto;
            width: 300px;
        }
        .modal-content {
            border-radius: 1rem;
            box-shadow: 0 0.5rem 1.5rem rgba(0,0,0,0.2);
        }
    </style>
</head>

<body>
     <!-- Modal de Carga -->
     <div class="modal fade" id="modalCarga" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center p-4">
            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
            <h5 class="mb-2">Procesando archivo...</h5>
            <div class="progress w-100 mb-2">
            <div id="barraProgreso" class="progress-bar progress-bar-striped progress-bar-animated" 
                role="progressbar" style="width: 0%">0%</div>
            </div>
            <small class="text-muted">Esto puede tardar unos segundos. Por favor no cierre la ventana.</small>
        </div>
        </div>
    </div> 

    <div class="container">
        <h1 class="text-center mb-4">Cargar archivo Venta Cierta</h1>

        <!-- Formulario de carga de archivo -->
        <form id="fileForm" action="/upload" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="file" class="form-label">Selecciona un archivo Excel:</label>
                <input type="file" class="form-control" id="file" name="file" accept=".xlsx" required>
            </div>

            <div class="d-flex justify-content-center">
                <button type="submit" class="btn btn-custom">Subir archivo</button>
            </div>
        </form>

        <!-- Mensaje de resultado -->
        <div id="resultado" class="result-message d-none"></div>
    </div>

    <div class="logo-container">
        <img src="https://www.uam.edu.co/wp-content/uploads/2022/09/logo-bancolombia1.png" 
             alt="Bancolombia">
    </div>     
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Script para manejar la carga del archivo -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 1. Elementos del DOM
            const modal = new bootstrap.Modal(document.getElementById('modalCarga'));
            const barra = document.getElementById('barraProgreso');
            const form = document.getElementById('fileForm');
            const resultDiv = document.getElementById('resultado');
            
            // 2. Validar existencia de elementos
            if (!modal || !barra || !form || !resultDiv) {
                console.error("Elementos del DOM no encontrados!");
                return;
            }

            // 3. Registrar evento submit (fuera del modal inicial)
            form.addEventListener('submit', async (event) => {
                event.preventDefault();
                
                // Mostrar modal de carga REAL
                barra.style.width = "0%";
                barra.textContent = "0%";
                modal.show();
                
                const formData = new FormData(form);
                
                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    // Actualizar progreso (simulado)
                    const progressInterval = setInterval(() => {
                        const currentWidth = parseInt(barra.style.width);
                        const newWidth = Math.min(currentWidth + 10, 90); // Máximo 90% hasta recibir respuesta
                        barra.style.width = `${newWidth}%`;
                        barra.textContent = `${newWidth}%`;
                    }, 300);

                    // Manejar respuesta
                    if (!response.ok) throw new Error(await response.text());
                    const data = await response.json();
                    
                    clearInterval(progressInterval);
                    barra.style.width = "100%";
                    barra.textContent = "100%";
                    
                    // Resultado exitoso
                    setTimeout(() => {
                        modal.hide();
                        resultDiv.classList.remove('d-none', 'alert-danger');
                        resultDiv.classList.add('alert', 'alert-success');
                        resultDiv.textContent = data.message || "¡Archivo procesado con éxito!";
                        
                        // Descargar archivo
                        if (data.output_file) {
                            const a = document.createElement('a');
                            a.href = data.output_file;
                            a.download = 'Clientes_venta_cierta_procesado.xlsx';
                            a.click();
                        }
                    }, 500);

                } catch (error) {
                    modal.hide();
                    resultDiv.classList.remove('d-none');
                    resultDiv.classList.add('alert', 'alert-danger');
                    resultDiv.textContent = `Error: ${error.message || "Falló la subida del archivo"}`;
                }
            });
        });      
    </script>
    <!-- Enlace a Bootstrap JS y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

</body>

</html>